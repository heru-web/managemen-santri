<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Manajemen Pesantren Al-Hikmah</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      :root {
        --primary-color: #096934;
        --secondary-color: #2f5328;
        --accent-color: #1e5f1e;
        --light-bg: #f5f7fa;
        --dark-text: #2c3e50;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --info-color: #16a085;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--light-bg);
        color: var(--dark-text);
      }

      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 250px;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--accent-color)
        );
        padding: 20px;
        overflow-y: auto;
        transition: all 0.3s ease;
        z-index: 1000;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .sidebar.collapsed {
        width: 70px;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .logo {
        display: flex;
        align-items: center;
        color: white;
        text-decoration: none;
      }

      .logo i {
        font-size: 28px;
        margin-right: 10px;
      }

      .logo-text {
        font-size: 20px;
        font-weight: bold;
        transition: opacity 0.3s;
      }

      .sidebar.collapsed .logo-text {
        opacity: 0;
        display: none;
      }

      .toggle-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
      }

      .nav-menu {
        list-style: none;
      }

      .nav-item {
        margin-bottom: 5px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .nav-link:hover,
      .nav-link.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      .nav-link i {
        font-size: 20px;
        margin-right: 15px;
        width: 20px;
      }

      .sidebar.collapsed .nav-link span {
        display: none;
      }

      /* Main Content */
      .main-content {
        margin-left: 250px;
        padding: 20px;
        transition: margin-left 0.3s ease;
      }

      .main-content.expanded {
        margin-left: 70px;
      }

      /* Header */
      .header {
        background: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .search-bar {
        position: relative;
        width: 300px;
      }

      .search-bar input {
        width: 100%;
        padding: 10px 40px 10px 15px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        transition: border-color 0.3s;
      }

      .search-bar input:focus {
        border-color: var(--secondary-color);
      }

      .search-bar i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .mobile-toggle-btn {
        display: none;
        background: none;
        border: none;
        color: var(--primary-color);
        font-size: 24px;
        cursor: pointer;
      }

      /* Dashboard Cards */
      .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s, box-shadow 0.3s;
        border-left: 4px solid var(--secondary-color);
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      .card-icon.blue {
        background: rgba(52, 152, 219, 0.1);
        color: var(--secondary-color);
      }

      .card-icon.green {
        background: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
      }

      .card-icon.orange {
        background: rgba(243, 156, 18, 0.1);
        color: var(--warning-color);
      }

      .card-icon.red {
        background: rgba(231, 76, 60, 0.1);
        color: var(--danger-color);
      }

      .card-icon.purple {
        background: rgba(155, 89, 182, 0.1);
        color: #9b59b6;
      }

      .card-icon.teal {
        background: rgba(26, 188, 156, 0.1);
        color: #1abc9c;
      }

      .card-title {
        color: #999;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .card-value {
        font-size: 28px;
        font-weight: bold;
        color: var(--dark-text);
      }

      /* Tables */
      .table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        overflow-x: auto;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .table-title {
        font-size: 20px;
        font-weight: bold;
        color: var(--primary-color);
      }

      .btn-primary-custom {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
        white-space: nowrap;
      }

      .btn-primary-custom:hover {
        background: var(--accent-color);
      }

      .custom-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }

      .custom-table th {
        background: var(--light-bg);
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--primary-color);
        border-bottom: 2px solid var(--secondary-color);
      }

      .custom-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      .custom-table tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-badge.active {
        background: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
      }

      .status-badge.pending {
        background: rgba(243, 156, 18, 0.1);
        color: var(--warning-color);
      }

      .status-badge.inactive {
        background: rgba(231, 76, 60, 0.1);
        color: var(--danger-color);
      }

      .status-badge.high {
        background: rgba(231, 76, 60, 0.1);
        color: var(--danger-color);
      }

      .status-badge.medium {
        background: rgba(243, 156, 18, 0.1);
        color: var(--warning-color);
      }

      .status-badge.low {
        background: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
      }

      .status-badge.excellent {
        background: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
      }

      .status-badge.good {
        background: rgba(52, 152, 219, 0.1);
        color: var(--secondary-color);
      }

      .status-badge.fair {
        background: rgba(243, 156, 18, 0.1);
        color: var(--warning-color);
      }

      .status-badge.poor {
        background: rgba(231, 76, 60, 0.1);
        color: var(--danger-color);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--primary-color);
        color: white;
        border-radius: 10px 10px 0 0;
      }

      .modal-title {
        font-size: 20px;
        font-weight: bold;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: white;
      }

      .modal-body {
        padding: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--primary-color);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        outline: none;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--secondary-color);
      }

      .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      /* Tab Navigation */
      .tab-navigation {
        display: flex;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
        overflow-x: auto;
      }

      .tab-btn {
        background: none;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 500;
        color: #666;
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .tab-btn.active {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Checkbox for attendance */
      .attendance-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      /* Filter section */
      .filter-section {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
      }

      .filter-group {
        flex: 1;
        min-width: 200px;
      }

      .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--primary-color);
      }

      .filter-group select,
      .filter-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        outline: none;
      }

      .btn-filter {
        background: var(--secondary-color);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-filter:hover {
        background: var(--accent-color);
      }

      /* Attendance summary */
      .attendance-summary {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .summary-card {
        flex: 1;
        min-width: 120px;
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
        border-top: 3px solid var(--secondary-color);
      }

      .summary-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .summary-label {
        color: #666;
        font-size: 14px;
      }

      .summary-card.present .summary-value {
        color: var(--success-color);
      }

      .summary-card.absent .summary-value {
        color: var(--danger-color);
      }

      .summary-card.permission .summary-value {
        color: var(--warning-color);
      }

      .summary-card.sick .summary-value {
        color: var(--info-color);
      }

      .summary-card.leave .summary-value {
        color: var(--warning-color);
      }

      .summary-card.truant .summary-value {
        color: var(--danger-color);
      }

      /* Character assessment styles */
      .character-assessment {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }

      .assessment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .assessment-title {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary-color);
      }

      .assessment-item {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
      }

      .assessment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .assessment-item-title {
        font-weight: 600;
        color: var(--primary-color);
      }

      .assessment-item-score {
        font-weight: bold;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 14px;
      }

      .assessment-item-description {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .assessment-item-progress {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
      }

      .assessment-item-progress-bar {
        height: 100%;
        background-color: var(--secondary-color);
      }

      /* Case management styles */
      .case-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        border-left: 4px solid var(--warning-color);
      }

      .case-card.high {
        border-left-color: var(--danger-color);
      }

      .case-card.medium {
        border-left-color: var(--warning-color);
      }

      .case-card.low {
        border-left-color: var(--success-color);
      }

      .case-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .case-title {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary-color);
      }

      .case-date {
        color: #666;
        font-size: 14px;
      }

      .case-description {
        color: #666;
        margin-bottom: 15px;
      }

      .case-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .case-status {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }

      .case-actions {
        display: flex;
        gap: 10px;
      }

      /* Info section */
      .info-section {
        margin-bottom: 20px;
      }

      /* Loading indicator */
      .loading-indicator {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 4000;
        justify-content: center;
        align-items: center;
      }

      .loading-indicator.active {
        display: flex;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Pagination */
      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .pagination-info {
        color: #666;
      }

      .pagination-buttons {
        display: flex;
        gap: 5px;
      }

      .pagination-btn {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 5px;
      }

      .pagination-btn:hover:not(:disabled) {
        background: var(--light-bg);
      }

      .pagination-btn:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }

      .pagination-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      /* Form range styling */
      .form-range {
        width: 100%;
        height: 1.5rem;
        padding: 0;
        background-color: transparent;
        -webkit-appearance: none;
        appearance: none;
      }

      .form-range:focus {
        outline: 0;
      }

      .form-range::-webkit-slider-track {
        width: 100%;
        height: 0.5rem;
        color: transparent;
        cursor: pointer;
        background-color: #dee2e6;
        border-color: transparent;
        border-radius: 1rem;
      }

      .form-range::-webkit-slider-thumb {
        width: 1rem;
        height: 1rem;
        margin-top: -0.25rem;
        background-color: var(--secondary-color);
        border: 0;
        border-radius: 1rem;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
      }

      .form-range::-moz-range-track {
        width: 100%;
        height: 0.5rem;
        color: transparent;
        cursor: pointer;
        background-color: #dee2e6;
        border-color: transparent;
        border-radius: 1rem;
      }

      .form-range::-moz-range-thumb {
        width: 1rem;
        height: 1rem;
        background-color: var(--secondary-color);
        border: 0;
        border-radius: 1rem;
        cursor: pointer;
      }

      /* Form text styling */
      .form-text {
        font-size: 12px;
        color: #6c757d;
      }

      .text-danger {
        color: var(--danger-color);
      }

      /* Responsive Design */
      @media (max-width: 992px) {
        .sidebar {
          left: -100%;
        }
        .sidebar.active {
          left: 0;
        }
        .main-content {
          margin-left: 0;
        }
        .mobile-toggle-btn {
          display: block;
        }
        .sidebar.collapsed {
          width: 250px;
        }
        .sidebar.collapsed .logo-text {
          opacity: 1;
          display: inline;
        }
        .sidebar.collapsed .nav-link span {
          display: inline;
        }
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }
        .search-bar {
          width: 100%;
        }
        .user-info {
          justify-content: space-between;
        }
        .dashboard-cards {
          grid-template-columns: 1fr;
        }
        .table-header {
          flex-direction: column;
          align-items: stretch;
        }
        .table-header div {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-top: 10px;
        }
        .filter-row {
          flex-direction: column;
        }
        .filter-group {
          width: 100%;
        }
        .attendance-summary {
          flex-direction: column;
        }
        .pagination-container {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loadingIndicator">
      <div class="spinner"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="#" class="logo">
          <i class="bi bi-mosque"></i>
          <span class="logo-text">Pesantren</span>
        </a>
        <button class="toggle-btn d-none d-lg-block" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
      </div>
      <nav>
        <ul class="nav-menu">
          <li class="nav-item">
            <a
              href="#"
              class="nav-link active"
              onclick="showSection('dashboard')"
            >
              <i class="bi bi-speedometer2"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('santri')">
              <i class="bi bi-people"></i>
              <span>Data Santri</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('pengajar')">
              <i class="bi bi-person-workspace"></i>
              <span>Pengajar</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('absen')">
              <i class="bi bi-calendar-check"></i>
              <span>Absen Halaqoh</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('absensi')">
              <i class="bi bi-calendar3"></i>
              <span>Absensi</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('kasus')">
              <i class="bi bi-exclamation-triangle"></i>
              <span>Kasus & Penanganan</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('karakter')">
              <i class="bi bi-person-badge"></i>
              <span>Karakter/Akhlak</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('kegiatan')">
              <i class="bi bi-calendar-event"></i>
              <span>Kegiatan</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('fasilitas')">
              <i class="bi bi-building"></i>
              <span>Fasilitas</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
      <!-- Header -->
      <header class="header">
        <button
          class="mobile-toggle-btn d-lg-none"
          onclick="toggleMobileSidebar()"
        >
          <i class="bi bi-list"></i>
        </button>
        <div class="search-bar">
          <input type="text" placeholder="Cari data..." />
          <i class="bi bi-search"></i>
        </div>
        <div class="user-info">
          <img
            src="https://picsum.photos/seed/user1/40/40"
            alt="User"
            class="user-avatar"
          />
          <div>
            <div style="font-weight: 500">Admin</div>
            <div style="font-size: 12px; color: #999">Administrator</div>
          </div>
          <button class="btn btn-sm btn-outline-secondary" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </header>

      <!-- Dashboard Section -->
      <section id="dashboard" class="content-section">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Dashboard
        </h2>

        <!-- Dashboard Cards -->
        <div class="dashboard-cards">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Total Santri</div>
                <div class="card-value" id="totalSantriCount">0</div>
              </div>
              <div class="card-icon blue">
                <i class="bi bi-people"></i>
              </div>
            </div>
            <div style="color: var(--success-color); font-size: 14px">
              <i class="bi bi-arrow-up"></i> 12% dari bulan lalu
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Total Pengajar</div>
                <div class="card-value" id="totalGuruCount">0</div>
              </div>
              <div class="card-icon green">
                <i class="bi bi-person-workspace"></i>
              </div>
            </div>
            <div style="color: var(--success-color); font-size: 14px">
              <i class="bi bi-arrow-up"></i> 5% dari bulan lalu
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Kegiatan Bulan Ini</div>
                <div class="card-value" id="totalKegiatanCount">0</div>
              </div>
              <div class="card-icon orange">
                <i class="bi bi-calendar-event"></i>
              </div>
            </div>
            <div style="color: var(--warning-color); font-size: 14px">
              <i class="bi bi-dash"></i> Sama dengan bulan lalu
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Fasilitas Tersedia</div>
                <div class="card-value" id="totalFasilitasCount">0</div>
              </div>
              <div class="card-icon red">
                <i class="bi bi-building"></i>
              </div>
            </div>
            <div style="color: var(--success-color); font-size: 14px">
              <i class="bi bi-arrow-up"></i> 3% dari bulan lalu
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Kasus Aktif</div>
                <div class="card-value" id="totalKasusCount">0</div>
              </div>
              <div class="card-icon purple">
                <i class="bi bi-exclamation-triangle"></i>
              </div>
            </div>
            <div style="color: var(--danger-color); font-size: 14px">
              <i class="bi bi-arrow-up"></i> 2 dari minggu lalu
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Rata-rata Akhlak</div>
                <div class="card-value" id="avgAkhlakCount">0</div>
              </div>
              <div class="card-icon teal">
                <i class="bi bi-person-badge"></i>
              </div>
            </div>
            <div style="color: var(--success-color); font-size: 14px">
              <i class="bi bi-arrow-up"></i> 5% dari bulan lalu
            </div>
          </div>
        </div>
      </section>

      <!-- Santri Section -->
      <section id="santri" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Data Santri
        </h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Daftar Santri</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportSantriPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportSantriExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('santriModal')"
              >
                <i class="bi bi-plus"></i> Tambah Santri
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>NIS</th>
                <th>Nama Lengkap</th>
                <th>Kelas</th>
                <th>Alamat</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="santriTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Santri -->
          <div class="pagination-container">
            <div class="pagination-info" id="santriPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="santriPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Pengajar Section -->
      <section id="pengajar" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Data Pengajar
        </h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Daftar Pengajar</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportGuruPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportGuruExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('pengajarModal')"
              >
                <i class="bi bi-plus"></i> Tambah Pengajar
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>NIP</th>
                <th>Nama</th>
                <th>Mata Pelajaran</th>
                <th>No. HP</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="guruTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Guru -->
          <div class="pagination-container">
            <div class="pagination-info" id="guruPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="guruPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Absen Halaqoh Section -->
      <section id="absen" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Absen Halaqoh
        </h2>

        <!-- Filter Section -->
        <div class="filter-section">
          <div class="filter-row">
            <div class="filter-group">
              <label>Tanggal</label>
              <input type="date" id="absenTanggal" value="" />
            </div>
            <div class="filter-group">
              <label>Waktu</label>
              <select id="absenWaktu">
                <option value="pagi">Pagi (07:00-09:00)</option>
                <option value="sore">Sore (16:00-18:00)</option>
                <option value="malam">Malam (20:00-22:00)</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Kelas</label>
              <select id="absenKelas">
                <option value="">Semua Kelas</option>
              </select>
            </div>
            <button class="btn-filter" onclick="filterAbsen()">
              <i class="bi bi-funnel"></i> Filter
            </button>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
          <button class="tab-btn active" onclick="switchTab('guru')">
            Absen Guru
          </button>
          <button class="tab-btn" onclick="switchTab('santri')">
            Absen Santri
          </button>
        </div>

        <!-- Tab Content -->
        <div id="guruTab" class="tab-content active">
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Absen Guru Halaqoh</h3>
              <div>
                <button
                  class="btn btn-sm btn-outline-success me-2"
                  onclick="exportAbsensiPDF('guru')"
                >
                  <i class="bi bi-file-earmark-pdf"></i> Export PDF
                </button>
                <button
                  class="btn btn-sm btn-outline-success me-2"
                  onclick="exportAbsensiExcel('guru')"
                >
                  <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>
                <button class="btn-primary-custom" onclick="saveAbsenGuru()">
                  <i class="bi bi-check"></i> Simpan Absen
                </button>
              </div>
            </div>

            <!-- Attendance Summary -->
            <div class="attendance-summary">
              <div class="summary-card present">
                <div class="summary-value" id="guruHadirCount">0</div>
                <div class="summary-label">Hadir</div>
              </div>
              <div class="summary-card absent">
                <div class="summary-value" id="guruTidakHadirCount">0</div>
                <div class="summary-label">Tidak Hadir</div>
              </div>
              <div class="summary-card permission">
                <div class="summary-value" id="guruIzinCount">0</div>
                <div class="summary-label">Izin</div>
              </div>
            </div>

            <table class="custom-table">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      class="attendance-checkbox"
                      id="selectAllGuru"
                      onchange="toggleAllGuru()"
                    />
                  </th>
                  <th>Nama</th>
                  <th>NIP</th>
                  <th>Mata Pelajaran</th>
                  <th>Status</th>
                  <th>Keterangan</th>
                </tr>
              </thead>
              <tbody id="absenGuruTableBody">
                <!-- Data akan dimuat dengan JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <div id="santriTab" class="tab-content">
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Absen Santri Halaqoh</h3>
              <div>
                <button
                  class="btn btn-sm btn-outline-success me-2"
                  onclick="exportAbsensiPDF('santri')"
                >
                  <i class="bi bi-file-earmark-pdf"></i> Export PDF
                </button>
                <button
                  class="btn btn-sm btn-outline-success me-2"
                  onclick="exportAbsensiExcel('santri')"
                >
                  <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>
                <button class="btn-primary-custom" onclick="saveAbsenSantri()">
                  <i class="bi bi-check"></i> Simpan Absen
                </button>
              </div>
            </div>

            <!-- Attendance Summary -->
            <div class="attendance-summary">
              <div class="summary-card present">
                <div class="summary-value" id="santriHadirCount">0</div>
                <div class="summary-label">Hadir</div>
              </div>
              <div class="summary-card absent">
                <div class="summary-value" id="santriTidakHadirCount">0</div>
                <div class="summary-label">Tidak Hadir</div>
              </div>
              <div class="summary-card permission">
                <div class="summary-value" id="santriIzinCount">0</div>
                <div class="summary-label">Izin</div>
              </div>
            </div>

            <table class="custom-table">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      class="attendance-checkbox"
                      id="selectAllSantri"
                      onchange="toggleAllSantri()"
                    />
                  </th>
                  <th>Nama</th>
                  <th>NIS</th>
                  <th>Kelas</th>
                  <th>Status</th>
                  <th>Keterangan</th>
                </tr>
              </thead>
              <tbody id="absenSantriTableBody">
                <!-- Data akan dimuat dengan JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Absensi Section -->
      <section id="absensi" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Absensi Santri
        </h2>

        <!-- Filter Section -->
        <div class="filter-section">
          <div class="filter-row">
            <div class="filter-group">
              <label>Tanggal</label>
              <input type="date" id="absensiTanggal" value="" />
            </div>
            <div class="filter-group">
              <label>Kelas</label>
              <select id="absensiKelas">
                <option value="">Semua Kelas</option>
              </select>
            </div>
            <button class="btn-filter" onclick="filterAbsensi()">
              <i class="bi bi-funnel"></i> Filter
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Data Absensi Santri</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportAbsensiSantriPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportAbsensiSantriExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('absensiModal')"
              >
                <i class="bi bi-plus"></i> Tambah Absensi
              </button>
            </div>
          </div>

          <!-- Attendance Summary -->
          <div class="attendance-summary">
            <div class="summary-card present">
              <div class="summary-value" id="santriHadirCount">0</div>
              <div class="summary-label">Hadir</div>
            </div>
            <div class="summary-card sick">
              <div class="summary-value" id="santriSakitCount">0</div>
              <div class="summary-label">Sakit</div>
            </div>
            <div class="summary-card leave">
              <div class="summary-value" id="santriPulangCount">0</div>
              <div class="summary-label">Pulang</div>
            </div>
            <div class="summary-card absent">
              <div class="summary-value" id="santriMangkirCount">0</div>
              <div class="summary-label">Mangkir</div>
            </div>
          </div>

          <table class="custom-table">
            <thead>
              <tr>
                <th>Nama</th>
                <th>NIS</th>
                <th>Kelas</th>
                <th>Tanggal</th>
                <th>Status</th>
                <th>Keterangan</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="absensiTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Absensi -->
          <div class="pagination-container">
            <div class="pagination-info" id="absensiPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="absensiPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Kasus Section -->
      <section id="kasus" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Kasus & Penanganan
        </h2>

        <!-- Informasi Section -->
        <div class="info-section mb-4">
          <div class="alert alert-info">
            <h5>
              <i class="bi bi-info-circle"></i> Tentang Fitur Kasus & Penanganan
            </h5>
            <p>
              Fitur ini digunakan untuk melacak dan mengelola kasus disiplin
              santri, mulai dari pelanggaran ringan hingga berat. Setiap kasus
              akan dicatat secara sistematis dengan detail informasi, prioritas,
              status penanganan, dan tindakan yang telah diambil.
            </p>
          </div>
        </div>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Daftar Kasus</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportKasusPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportKasusExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('kasusModal')"
              >
                <i class="bi bi-plus"></i> Tambah Kasus
              </button>
            </div>
          </div>

          <!-- Filter Section -->
          <div class="filter-section">
            <div class="filter-row">
              <div class="filter-group">
                <label>Periode</label>
                <select id="kasusPeriode">
                  <option value="">Semua Periode</option>
                  <option value="minggu-ini">Minggu Ini</option>
                  <option value="bulan-ini">Bulan Ini</option>
                  <option value="tahun-ini">Tahun Ini</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Prioritas</label>
                <select id="kasusPrioritas">
                  <option value="">Semua Prioritas</option>
                  <option value="tinggi">Tinggi</option>
                  <option value="sedang">Sedang</option>
                  <option value="rendah">Rendah</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Status</label>
                <select id="kasusStatus">
                  <option value="">Semua Status</option>
                  <option value="terbuka">Terbuka</option>
                  <option value="dalam-proses">Dalam Proses</option>
                  <option value="selesai">Selesai</option>
                </select>
              </div>
              <button class="btn-filter" onclick="filterKasus()">
                <i class="bi bi-funnel"></i> Filter
              </button>
            </div>
          </div>

          <!-- Statistics Cards -->
          <div class="dashboard-cards mb-4">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Total Kasus</div>
                  <div class="card-value" id="totalKasusCount">0</div>
                </div>
                <div class="card-icon purple">
                  <i class="bi bi-exclamation-triangle"></i>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Kasus Aktif</div>
                  <div class="card-value" id="kasusAktifCount">0</div>
                </div>
                <div class="card-icon orange">
                  <i class="bi bi-clock-history"></i>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Kasus Selesai</div>
                  <div class="card-value" id="kasusSelesaiCount">0</div>
                </div>
                <div class="card-icon green">
                  <i class="bi bi-check-circle"></i>
                </div>
              </div>
            </div>
          </div>

          <div id="kasusContainer">
            <!-- Data kasus akan dimuat dengan JavaScript -->
          </div>
          <!-- Pagination for Kasus -->
          <div class="pagination-container">
            <div class="pagination-info" id="kasusPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="kasusPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Karakter Section -->
      <section id="karakter" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Penilaian Karakter/Akhlak Santri
        </h2>

        <!-- Informasi Section -->
        <div class="info-section mb-4">
          <div class="alert alert-info">
            <h5>
              <i class="bi bi-info-circle"></i> Tentang Fitur Penilaian
              Karakter/Akhlak
            </h5>
            <p>
              Fitur ini digunakan untuk menilai dan melacak perkembangan
              karakter dan akhlak santri. Penilaian mencakup aspek-aspek penting
              seperti sikap, komunikasi, etos kerja, dan kedisiplinan. Data ini
              akan membantu dalam pembinaan santri secara holistik.
            </p>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
          <div class="filter-row">
            <div class="filter-group">
              <label>Santri</label>
              <select id="karakterSantri">
                <option value="">Pilih Santri</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Periode</label>
              <select id="karakterPeriode">
                <option value="bulan-ini">Bulan Ini</option>
                <option value="bulan-lalu">Bulan Lalu</option>
                <option value="3-bulan-terakhir">3 Bulan Terakhir</option>
                <option value="semester-ini">Semester Ini</option>
                <option value="tahun-ini">Tahun Ini</option>
              </select>
            </div>
            <button class="btn-filter" onclick="filterKarakter()">
              <i class="bi bi-funnel"></i> Filter
            </button>
            <button
              class="btn-primary-custom"
              onclick="openModal('karakterModal')"
            >
              <i class="bi bi-plus"></i> Tambah Penilaian
            </button>
          </div>
        </div>

        <!-- Statistics Cards -->
        <div class="dashboard-cards mb-4">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Rata-rata Sikap</div>
                <div class="card-value" id="avgSikapCount">0</div>
              </div>
              <div class="card-icon blue">
                <i class="bi bi-person-heart"></i>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Rata-rata Komunikasi</div>
                <div class="card-value" id="avgKomunikasiCount">0</div>
              </div>
              <div class="card-icon green">
                <i class="bi bi-chat-dots"></i>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Rata-rata Etos Kerja</div>
                <div class="card-value" id="avgEtosKerjaCount">0</div>
              </div>
              <div class="card-icon orange">
                <i class="bi bi-briefcase"></i>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Rata-rata Disiplin</div>
                <div class="card-value" id="avgDisiplinCount">0</div>
              </div>
              <div class="card-icon red">
                <i class="bi bi-clipboard-check"></i>
              </div>
            </div>
          </div>
        </div>

        <div id="karakterContainer">
          <!-- Data karakter akan dimuat dengan JavaScript -->
        </div>
      </section>

      <!-- Kegiatan Section -->
      <section id="kegiatan" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Manajemen Kegiatan
        </h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Jadwal Kegiatan</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportKegiatanPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportKegiatanExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('kegiatanModal')"
              >
                <i class="bi bi-plus"></i> Tambah Kegiatan
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Nama Kegiatan</th>
                <th>Penanggung Jawab</th>
                <th>Lokasi</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="kegiatanTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Kegiatan -->
          <div class="pagination-container">
            <div class="pagination-info" id="kegiatanPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="kegiatanPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Fasilitas Section -->
      <section id="fasilitas" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px; color: var(--primary-color)">
          Manajemen Fasilitas
        </h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Daftar Fasilitas</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportFasilitasPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportFasilitasExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('fasilitasModal')"
              >
                <i class="bi bi-plus"></i> Tambah Fasilitas
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>Nama Fasilitas</th>
                <th>Kapasitas</th>
                <th>Kondisi</th>
                <th>Penanggung Jawab</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="fasilitasTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Fasilitas -->
          <div class="pagination-container">
            <div class="pagination-info" id="fasilitasPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="fasilitasPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Login Sistem</h3>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="loginEmail"
              class="form-control"
              value="admin@pesantren.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="loginPassword"
              class="form-control"
              value="admin123"
            />
          </div>
          <div id="loginError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button class="btn-primary-custom" onclick="login()">Login</button>
        </div>
      </div>
    </div>

    <!-- Santri Modal -->
    <div class="modal" id="santriModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="santriModalTitle">Tambah Santri Baru</h3>
          <button class="close-btn" onclick="closeModal('santriModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="santriId" />
          <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="santriNama" />
          </div>
          <div class="form-group">
            <label>NIS</label>
            <input type="text" id="santriNIS" />
          </div>
          <div class="form-group">
            <label>Tempat Lahir</label>
            <input type="text" id="santriTempatLahir" />
          </div>
          <div class="form-group">
            <label>Tanggal Lahir</label>
            <input type="date" id="santriTanggalLahir" />
          </div>
          <div class="form-group">
            <label>Kelas</label>
            <select id="santriKelas">
              <option value="">Pilih Kelas</option>
            </select>
          </div>
          <div class="form-group">
            <label>Alamat</label>
            <input type="text" id="santriAlamat" />
          </div>
          <div class="form-group">
            <label>Nama Orang Tua/Wali</label>
            <input type="text" id="santriOrtu" />
          </div>
          <div class="form-group">
            <label>No. HP Orang Tua/Wali</label>
            <input type="tel" id="santriHPOrtu" />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="santriStatus">
              <option value="aktif">Aktif</option>
              <option value="tidak_aktif">Tidak Aktif</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('santriModal')">
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveSantri()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Pengajar Modal -->
    <div class="modal" id="pengajarModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="pengajarModalTitle">
            Tambah Pengajar Baru
          </h3>
          <button class="close-btn" onclick="closeModal('pengajarModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="pengajarId" />
          <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="pengajarNama" />
          </div>
          <div class="form-group">
            <label>NIP</label>
            <input type="text" id="pengajarNIP" />
          </div>
          <div class="form-group">
            <label>Mata Pelajaran</label>
            <input type="text" id="pengajarMapel" />
          </div>
          <div class="form-group">
            <label>No. HP</label>
            <input type="tel" id="pengajarHP" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="pengajarEmail" />
          </div>
          <div class="form-group">
            <label>Alamat</label>
            <textarea id="pengajarAlamat" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="pengajarStatus">
              <option value="aktif">Aktif</option>
              <option value="tidak_aktif">Tidak Aktif</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('pengajarModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveGuru()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Kegiatan Modal -->
    <div class="modal" id="kegiatanModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="kegiatanModalTitle">
            Tambah Kegiatan Baru
          </h3>
          <button class="close-btn" onclick="closeModal('kegiatanModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="kegiatanId" />
          <div class="form-group">
            <label>Nama Kegiatan</label>
            <input type="text" id="kegiatanNama" />
          </div>
          <div class="form-group">
            <label>Tanggal</label>
            <input type="date" id="kegiatanTanggal" />
          </div>
          <div class="form-group">
            <label>Waktu</label>
            <input type="time" id="kegiatanWaktu" />
          </div>
          <div class="form-group">
            <label>Lokasi</label>
            <input type="text" id="kegiatanLokasi" />
          </div>
          <div class="form-group">
            <label>Penanggung Jawab</label>
            <input type="text" id="kegiatanPJ" />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="kegiatanStatus">
              <option value="dalam_proses">Dalam Proses</option>
              <option value="selesai">Selesai</option>
              <option value="dibatalkan">Dibatalkan</option>
            </select>
          </div>
          <div class="form-group">
            <label>Deskripsi</label>
            <textarea id="kegiatanDeskripsi" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('kegiatanModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveKegiatan()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Fasilitas Modal -->
    <div class="modal" id="fasilitasModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="fasilitasModalTitle">
            Tambah Fasilitas Baru
          </h3>
          <button class="close-btn" onclick="closeModal('fasilitasModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="fasilitasId" />
          <div class="form-group">
            <label>Nama Fasilitas</label>
            <input type="text" id="fasilitasNama" />
          </div>
          <div class="form-group">
            <label>Kapasitas</label>
            <input type="text" id="fasilitasKapasitas" />
          </div>
          <div class="form-group">
            <label>Kondisi</label>
            <select id="fasilitasKondisi">
              <option value="">Pilih Kondisi</option>
              <option value="baik">Baik</option>
              <option value="sedang">Sedang</option>
              <option value="rusak">Rusak</option>
            </select>
          </div>
          <div class="form-group">
            <label>Penanggung Jawab</label>
            <input type="text" id="fasilitasPJ" />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="fasilitasStatus">
              <option value="tersedia">Tersedia</option>
              <option value="tidak_tersedia">Tidak Tersedia</option>
            </select>
          </div>
          <div class="form-group">
            <label>Deskripsi</label>
            <textarea id="fasilitasDeskripsi" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('fasilitasModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveFasilitas()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Absensi Modal -->
    <div class="modal" id="absensiModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="absensiModalTitle">
            Tambah Data Absensi
          </h3>
          <button class="close-btn" onclick="closeModal('absensiModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="absensiId" />
          <div class="form-group">
            <label>Santri</label>
            <select id="absensiSantri">
              <option value="">Pilih Santri</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tanggal</label>
            <input type="date" id="absensiTanggal" />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="absensiStatus">
              <option value="">Pilih Status</option>
              <option value="hadir">Hadir</option>
              <option value="sakit">Sakit</option>
              <option value="pulang">Pulang</option>
              <option value="mangkir">Mangkir</option>
            </select>
          </div>
          <div class="form-group">
            <label>Keterangan</label>
            <textarea id="absensiKeterangan" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('absensiModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveAbsensi()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Kasus Modal -->
    <div class="modal" id="kasusModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="kasusModalTitle">Tambah Kasus Baru</h3>
          <button class="close-btn" onclick="closeModal('kasusModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="kasusId" />
          <div class="form-group">
            <label>Judul Kasus <span class="text-danger">*</span></label>
            <input type="text" id="kasusJudul" required />
            <small class="form-text text-muted"
              >Berikan judul yang jelas dan singkat untuk kasus ini</small
            >
          </div>
          <div class="form-group">
            <label>Santri Terkait <span class="text-danger">*</span></label>
            <select id="kasusSantri" required>
              <option value="">Pilih Santri</option>
            </select>
            <small class="form-text text-muted"
              >Pilih santri yang terlibat dalam kasus ini</small
            >
          </div>
          <div class="form-group">
            <label>Tanggal Kejadian <span class="text-danger">*</span></label>
            <input type="date" id="kasusTanggal" required />
            <small class="form-text text-muted"
              >Tanggal saat kasus terjadi</small
            >
          </div>
          <div class="form-group">
            <label>Jenis Pelanggaran</label>
            <select id="kasusJenis">
              <option value="">Pilih Jenis Pelanggaran</option>
              <option value="akademik">
                Akademik (Tidak mengerjakan tugas, menyontek, dll)
              </option>
              <option value="disiplin">
                Disiplin (Terlambat, bolos, tidak mengikuti aturan)
              </option>
              <option value="sosial">
                Sosial (Berkata kasar, perkelahian, bullying)
              </option>
              <option value="kebersihan">
                Kebersihan (Membuang sampah sembarangan, merusak fasilitas)
              </option>
              <option value="ibadah">
                Ibadah (Meninggalkan shalat, tidak mengikuti kegiatan keagamaan)
              </option>
              <option value="lainnya">Lainnya</option>
            </select>
            <small class="form-text text-muted"
              >Kategorikan jenis pelanggaran yang terjadi</small
            >
          </div>
          <div class="form-group">
            <label>Prioritas <span class="text-danger">*</span></label>
            <select id="kasusPrioritas" required>
              <option value="">Pilih Prioritas</option>
              <option value="tinggi">
                Tinggi - Memerlukan penanganan segera
              </option>
              <option value="sedang">
                Sedang - Penanganan dalam beberapa hari
              </option>
              <option value="rendah">Rendah - Penanganan rutin</option>
            </select>
            <small class="form-text text-muted"
              >Tentukan tingkat prioritas penanganan kasus</small
            >
          </div>
          <div class="form-group">
            <label>Status <span class="text-danger">*</span></label>
            <select id="kasusStatus" required>
              <option value="">Pilih Status</option>
              <option value="terbuka">
                Terbuka - Kasus baru, belum ada tindakan
              </option>
              <option value="dalam-proses">
                Dalam Proses - Sedang ditangani
              </option>
              <option value="menunggu-konfirmasi">
                Menunggu Konfirmasi - Menunggu tanggapan orang tua/wali
              </option>
              <option value="selesai">Selesai - Kasus telah ditangani</option>
            </select>
            <small class="form-text text-muted"
              >Status penanganan kasus saat ini</small
            >
          </div>
          <div class="form-group">
            <label>Deskripsi Kasus <span class="text-danger">*</span></label>
            <textarea id="kasusDeskripsi" rows="3" required></textarea>
            <small class="form-text text-muted"
              >Jelaskan secara detail kronologi dan konteks kasus</small
            >
          </div>
          <div class="form-group">
            <label>Saksi/Keterangan Tambahan</label>
            <textarea id="kasusSaksi" rows="2"></textarea>
            <small class="form-text text-muted"
              >Tambahkan keterangan dari saksi jika ada</small
            >
          </div>
          <div class="form-group">
            <label>Tindakan yang Diambil</label>
            <textarea id="kasusTindakan" rows="3"></textarea>
            <small class="form-text text-muted"
              >Jelaskan tindakan yang telah atau akan diambil</small
            >
          </div>
          <div class="form-group">
            <label>Penanggung Jawab <span class="text-danger">*</span></label>
            <input type="text" id="kasusPJ" required />
            <small class="form-text text-muted"
              >Nama penanggung jawab penanganan kasus</small
            >
          </div>
          <div class="form-group">
            <label>Tindak Lanjut</label>
            <textarea id="kasusTindakLanjut" rows="2"></textarea>
            <small class="form-text text-muted"
              >Rencana tindak lanjut untuk mencegah kasus serupa</small
            >
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('kasusModal')">
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveKasus()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Karakter Modal -->
    <div class="modal" id="karakterModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="karakterModalTitle">
            Tambah Penilaian Karakter
          </h3>
          <button class="close-btn" onclick="closeModal('karakterModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="karakterId" />
          <div class="form-group">
            <label>Santri <span class="text-danger">*</span></label>
            <select id="karakterSantriForm" required>
              <option value="">Pilih Santri</option>
            </select>
            <small class="form-text text-muted"
              >Pilih santri yang akan dinilai</small
            >
          </div>
          <div class="form-group">
            <label>Periode Penilaian <span class="text-danger">*</span></label>
            <select id="karakterPeriodeForm" required>
              <option value="">Pilih Periode</option>
              <option value="minggu-1">Minggu 1</option>
              <option value="minggu-2">Minggu 2</option>
              <option value="minggu-3">Minggu 3</option>
              <option value="minggu-4">Minggu 4</option>
              <option value="bulan-1">Bulan 1</option>
              <option value="bulan-2">Bulan 2</option>
              <option value="bulan-3">Bulan 3</option>
              <option value="semester-1">Semester 1</option>
              <option value="semester-2">Semester 2</option>
              <option value="tahunan">Tahunan</option>
            </select>
            <small class="form-text text-muted">Pilih periode penilaian</small>
          </div>
          <div class="form-group">
            <label>Tanggal Penilaian <span class="text-danger">*</span></label>
            <input type="date" id="karakterTanggal" required />
            <small class="form-text text-muted"
              >Tanggal saat penilaian dilakukan</small
            >
          </div>

          <div class="assessment-item">
            <div class="assessment-item-header">
              <h5 class="assessment-item-title">Sikap</h5>
              <div class="d-flex align-items-center">
                <input
                  type="range"
                  class="form-range me-2"
                  min="0"
                  max="100"
                  value="50"
                  id="sikapRange"
                />
                <span class="assessment-item-score" id="sikapScore">50</span>
              </div>
            </div>
            <div class="assessment-item-description">
              Menilai perilaku dan sikap santri dalam kehidupan sehari-hari,
              termasuk sopan santun, hormat kepada yang lebih tua, dan interaksi
              dengan teman sebaya.
            </div>
            <div class="form-group mt-2">
              <label>Keterangan Sikap</label>
              <textarea id="karakterSikapKeterangan" rows="2"></textarea>
              <small class="form-text text-muted"
                >Berikan contoh konkret perilaku yang menjadi dasar
                penilaian</small
              >
            </div>
          </div>

          <div class="assessment-item">
            <div class="assessment-item-header">
              <h5 class="assessment-item-title">Komunikasi</h5>
              <div class="d-flex align-items-center">
                <input
                  type="range"
                  class="form-range me-2"
                  min="0"
                  max="100"
                  value="50"
                  id="komunikasiRange"
                />
                <span class="assessment-item-score" id="komunikasiScore"
                  >50</span
                >
              </div>
            </div>
            <div class="assessment-item-description">
              Menilai kemampuan berkomunikasi dengan teman dan guru, termasuk
              kemampuan menyampaikan pendapat, mendengarkan, dan berdiskusi.
            </div>
            <div class="form-group mt-2">
              <label>Keterangan Komunikasi</label>
              <textarea id="karakterKomunikasiKeterangan" rows="2"></textarea>
              <small class="form-text text-muted"
                >Berikan contoh konkret kemampuan komunikasi yang diamati</small
              >
            </div>
          </div>

          <div class="assessment-item">
            <div class="assessment-item-header">
              <h5 class="assessment-item-title">Etos Kerja</h5>
              <div class="d-flex align-items-center">
                <input
                  type="range"
                  class="form-range me-2"
                  min="0"
                  max="100"
                  value="50"
                  id="etosKerjaRange"
                />
                <span class="assessment-item-score" id="etosKerjaScore"
                  >50</span
                >
              </div>
            </div>
            <div class="assessment-item-description">
              Menilai semangat dan dedikasi dalam menyelesaikan tugas, tanggung
              jawab terhadap pekerjaan, dan inisiatif dalam belajar.
            </div>
            <div class="form-group mt-2">
              <label>Keterangan Etos Kerja</label>
              <textarea id="karakterEtosKerjaKeterangan" rows="2"></textarea>
              <small class="form-text text-muted"
                >Berikan contoh konkret etos kerja yang diamati</small
              >
            </div>
          </div>

          <div class="assessment-item">
            <div class="assessment-item-header">
              <h5 class="assessment-item-title">Disiplin</h5>
              <div class="d-flex align-items-center">
                <input
                  type="range"
                  class="form-range me-2"
                  min="0"
                  max="100"
                  value="50"
                  id="disiplinRange"
                />
                <span class="assessment-item-score" id="disiplinScore">50</span>
              </div>
            </div>
            <div class="assessment-item-description">
              Menilai kedisiplinan dalam mengikuti aturan dan jadwal, termasuk
              kehadiran, ketepatan waktu, dan pematuhan terhadap peraturan.
            </div>
            <div class="form-group mt-2">
              <label>Keterangan Disiplin</label>
              <textarea id="karakterDisiplinKeterangan" rows="2"></textarea>
              <small class="form-text text-muted"
                >Berikan contoh konkret kedisiplinan yang diamati</small
              >
            </div>
          </div>

          <div class="form-group">
            <label>Catatan Umum</label>
            <textarea id="karakterCatatan" rows="3"></textarea>
            <small class="form-text text-muted"
              >Catatan tambahan tentang perkembangan karakter santri</small
            >
          </div>

          <div class="form-group">
            <label>Penilai <span class="text-danger">*</span></label>
            <input type="text" id="karakterPenilai" required />
            <small class="form-text text-muted"
              >Nama penilai (pengajar/ustadz)</small
            >
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('karakterModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveKarakter()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Library untuk export PDF dan Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      // Ganti dengan URL dan API Key dari Supabase Anda
      const supabaseUrl = "https://wlgpomtligrimbzakxiz.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsZ3BvbXRsaWdyaW1iemFreGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MjMxNDAsImV4cCI6MjA3NzI5OTE0MH0.9MKCtx-fFbRLb5dnHNsqOaCNvOWZRgFXwLYxkSVux20";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // State aplikasi
      let currentUser = null;
      let dataKelas = [];
      let dataPengaturan = {};

      // Pagination state
      const paginationState = {
        santri: { page: 1, pageSize: 10, count: 0 },
        guru: { page: 1, pageSize: 10, count: 0 },
        kegiatan: { page: 1, pageSize: 10, count: 0 },
        fasilitas: { page: 1, pageSize: 10, count: 0 },
        absensi: { page: 1, pageSize: 10, count: 0 },
        kasus: { page: 1, pageSize: 10, count: 0 },
      };

      // Fungsi untuk menampilkan toast menggunakan SweetAlert2
      function showToast(message, type = "success") {
        const Toast = Swal.mixin({
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 3000,
          timerProgressBar: true,
          didOpen: (toast) => {
            toast.addEventListener("mouseenter", Swal.stopTimer);
            toast.addEventListener("mouseleave", Swal.resumeTimer);
          },
        });

        Toast.fire({
          icon: type,
          title: message,
        });
      }

      // Fungsi untuk menambahkan header ke PDF
      function addHeaderToPDF(doc) {
        // Tambahkan logo (gunakan base64 atau URL)
        // Untuk contoh, saya akan menggunakan placeholder
        doc.addImage(
          "https://raw.githubusercontent.com/heru-web/managemen-santri/main/assets/img/alma.jpg",
          "JPEG",
          14,
          10,
          20,
          20
        );

        // Tambahkan nama pondok
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text("Pondok Pesantren Al-maa", 40, 20);

        // Tambahkan lokasi
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Parung Bogor", 40, 26);

        // Tambahkan alamat
        doc.setFontSize(9);
        doc.text(
          "Jl. Haji Mawi Gg. Omega RT. 03/RW. 02, Kp. Jati Waru, Des. Waru,",
          14,
          36
        );
        doc.text("Kec. Parung, Kab. Bogor, Prov. Jawa Barat", 14, 41);

        // Tambahkan garis pemisah
        doc.setLineWidth(0.5);
        doc.line(14, 46, 195, 46);

        return 55; // Kembalikan posisi Y untuk melanjutkan konten
      }

      // Fungsi untuk menambahkan header ke Excel
      function addHeaderToExcel(worksheet) {
        // Merge cells untuk header
        XLSX.utils.sheet_add_aoa(
          worksheet,
          [
            ["Pondok Pesantren Al-maa"],
            ["Parung Bogor"],
            [
              "Jl. Haji Mawi Gg. Omega RT. 03/RW. 02, Kp. Jati Waru, Des. Waru,",
            ],
            ["Kec. Parung, Kab. Bogor, Prov. Jawa Barat"],
            [],
          ],
          { origin: "A1" }
        );

        // Atur style untuk header
        const headerRange = XLSX.utils.decode_range(worksheet["!ref"]);
        for (let R = headerRange.s.r; R <= headerRange.s.r + 4; ++R) {
          for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            if (!worksheet[cellAddress]) continue;

            if (R === 0) {
              worksheet[cellAddress].s = {
                font: { bold: true, sz: 16 },
                alignment: { horizontal: "center" },
              };
            } else if (R === 1) {
              worksheet[cellAddress].s = {
                font: { bold: true, sz: 12 },
                alignment: { horizontal: "center" },
              };
            } else if (R <= 3) {
              worksheet[cellAddress].s = {
                font: { sz: 9 },
                alignment: { horizontal: "center" },
              };
            }
          }
        }

        // Merge cells untuk judul header
        worksheet["!merges"] = [
          { s: { r: 0, c: 0 }, e: { r: 0, c: 9 } },
          { s: { r: 1, c: 0 }, e: { r: 1, c: 9 } },
          { s: { r: 2, c: 0 }, e: { r: 2, c: 9 } },
          { s: { r: 3, c: 0 }, e: { r: 3, c: 9 } },
        ];

        return 6; // Kembalikan baris awal untuk data
      }

      // Fungsi untuk menampilkan/menyembunyikan loading indicator
      function showLoading() {
        document.getElementById("loadingIndicator").classList.add("active");
      }

      function hideLoading() {
        document.getElementById("loadingIndicator").classList.remove("active");
      }

      // Fungsi login
      async function login() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const errorDiv = document.getElementById("loginError");

        if (!email || !password) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Email dan password harus diisi",
          });
          return;
        }

        showLoading();

        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Login Gagal",
              text: error.message,
            });
            hideLoading();
            return;
          }

          // Login berhasil
          currentUser = data.user;
          closeModal("loginModal");
          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Login berhasil!",
            timer: 1500,
            showConfirmButton: false,
          });

          // Load data user
          await loadUserProfile();

          // Load data dashboard saja saat awal
          await loadDashboardData();
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat login",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi logout yang diperbaiki
      async function logout() {
        const result = await Swal.fire({
          title: "Konfirmasi Logout",
          text: "Apakah Anda yakin ingin keluar?",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, keluar!",
        });

        if (!result.isConfirmed) {
          return;
        }

        try {
          showLoading();
          await supabase.auth.signOut();
          // Tunggu sebentar agar onAuthStateChange selesai diproses
          setTimeout(() => {
            currentUser = null;
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Logout berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            // Pastikan modal login ditampilkan
            const loginModal = document.getElementById("loginModal");
            loginModal.classList.add("active");
            hideLoading();
          }, 500);
        } catch (error) {
          console.error("Error during logout:", error);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Gagal logout",
          });
          hideLoading();
        }
      }

      // Fungsi load profile user
      async function loadUserProfile() {
        try {
          const { data, error } = await supabase
            .from("users")
            .select("*")
            .eq("id", currentUser.id)
            .single();

          if (error) {
            console.error("Error loading user profile:", error);
            return;
          }

          // Update UI dengan data user
          document.querySelector(".user-avatar").src =
            data.avatar_url || "https://picsum.photos/seed/user1/40/40";
          document.querySelector(".user-info div div").textContent =
            data.full_name;
          document.querySelector(".user-info div div:last-child").textContent =
            data.role;
        } catch (err) {
          console.error("Error loading user profile:", err);
        }
      }

      // Hanya memuat data yang diperlukan untuk dashboard
      async function loadDashboardData() {
        showLoading();
        try {
          const today = new Date();
          const currentMonth = today.getMonth();
          const currentYear = today.getFullYear();

          // Buat tanggal dalam format YYYY-MM-DD yang bisa dibaca Supabase
          const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
          const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);

          const startDateString = firstDayOfMonth.toISOString().split("T")[0];
          const endDateString = lastDayOfMonth.toISOString().split("T")[0];

          // Gunakan count untuk menghemat bandwidth, kita hanya butuh jumlahnya
          const [
            { count: santriCount },
            { count: guruCount },
            { data: kegiatanData },
            { count: fasilitasCount },
            { count: kasusCount },
            { data: karakterData },
          ] = await Promise.all([
            supabase
              .from("santri")
              .select("id", { count: "exact", head: true }),
            supabase.from("guru").select("id", { count: "exact", head: true }),
            supabase
              .from("kegiatan")
              .select("id")
              .gte("tanggal", startDateString)
              .lte("tanggal", endDateString),
            supabase
              .from("fasilitas")
              .select("id", { count: "exact", head: true }),
            supabase
              .from("kasus")
              .select("id", { count: "exact", head: true })
              .eq("status", "terbuka"),
            supabase
              .from("karakter")
              .select("sikap, komunikasi, etos_kerja, disiplin"),
          ]);

          // Update dashboard
          document.getElementById("totalSantriCount").textContent =
            santriCount || 0;
          document.getElementById("totalGuruCount").textContent =
            guruCount || 0;

          // Tambahkan pengecekan untuk mencegah error jika data null
          document.getElementById("totalKegiatanCount").textContent =
            kegiatanData && kegiatanData.length ? kegiatanData.length : 0;

          document.getElementById("totalFasilitasCount").textContent =
            fasilitasCount || 0;
          document.getElementById("totalKasusCount").textContent =
            kasusCount || 0;

          // Hitung rata-rata akhlak
          let avgScore = 0;
          if (karakterData && karakterData.length > 0) {
            const totalScore = karakterData.reduce((sum, item) => {
              return (
                sum +
                ((item.sikap || 0) +
                  (item.komunikasi || 0) +
                  (item.etos_kerja || 0) +
                  (item.disiplin || 0)) /
                  4
              );
            }, 0);
            avgScore = Math.round(totalScore / karakterData.length);
          }
          document.getElementById("avgAkhlakCount").textContent = avgScore;
        } catch (err) {
          console.error("Error loading dashboard data:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data dashboard",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi load data santri dengan pagination
      async function loadSantri(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(
            page,
            paginationState.santri.pageSize
          );

          const { data, error, count } = await supabase
            .from("santri")
            .select(
              `
                *,
                kelas (
                    id,
                    nama
                )
            `,
              { count: "exact" }
            )
            .range(from, to)
            .order("nama_lengkap");

          if (error) {
            console.error("Error loading santri:", error);
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error loading santri: " + error.message,
            });
            return;
          }

          paginationState.santri.count = count || 0;
          paginationState.santri.page = page;

          updateSantriTable(data);
          updatePagination("santri");
        } catch (err) {
          console.error("Error loading santri:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data santri",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel santri
      function updateSantriTable(data) {
        const tbody = document.getElementById("santriTableBody");
        tbody.innerHTML = "";

        data.forEach((santri) => {
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${santri.nis}</td>
              <td>${santri.nama_lengkap}</td>
              <td>${santri.kelas ? santri.kelas.nama : "-"}</td>
              <td>${santri.alamat || "-"}</td>
              <td><span class="status-badge ${
                santri.status === "aktif" ? "active" : "inactive"
              }">${
            santri.status === "aktif" ? "Aktif" : "Tidak Aktif"
          }</span></td>
              <td>
                  <button class="btn btn-sm btn-primary" onclick="editSantri('${
                    santri.id
                  }')">
                      <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteSantri('${
                    santri.id
                  }')">
                      <i class="bi bi-trash"></i>
                  </button>
              </td>
          `;
          tbody.appendChild(row);
        });
      }

      // Fungsi load data guru dengan pagination
      async function loadGuru(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(
            page,
            paginationState.guru.pageSize
          );

          const { data, error, count } = await supabase
            .from("guru")
            .select("*", { count: "exact" })
            .range(from, to)
            .order("nama_lengkap");

          if (error) {
            console.error("Error loading guru:", error);
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error loading guru: " + error.message,
            });
            return;
          }

          paginationState.guru.count = count || 0;
          paginationState.guru.page = page;

          updateGuruTable(data);
          updatePagination("guru");
        } catch (err) {
          console.error("Error loading guru:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data guru",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel guru
      function updateGuruTable(data) {
        const tbody = document.getElementById("guruTableBody");
        tbody.innerHTML = "";

        data.forEach((guru) => {
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${guru.nip}</td>
              <td>${guru.nama_lengkap}</td>
              <td>${guru.mata_pelajaran || "-"}</td>
              <td>${guru.no_hp || "-"}</td>
              <td><span class="status-badge ${
                guru.status === "aktif" ? "active" : "inactive"
              }">${
            guru.status === "aktif" ? "Aktif" : "Tidak Aktif"
          }</span></td>
              <td>
                  <button class="btn btn-sm btn-primary" onclick="editGuru('${
                    guru.id
                  }')">
                      <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteGuru('${
                    guru.id
                  }')">
                      <i class="bi bi-trash"></i>
                  </button>
              </td>
          `;
          tbody.appendChild(row);
        });
      }

      // Fungsi load data kelas
      async function loadKelas() {
        try {
          const { data, error } = await supabase.from("kelas").select("*");

          if (error) {
            console.error("Error loading kelas:", error);
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error loading kelas: " + error.message,
            });
            return;
          }

          dataKelas = data;
          updateKelasOptions();
        } catch (err) {
          console.error("Error loading kelas:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data kelas",
          });
        }
      }

      // Fungsi update opsi kelas
      function updateKelasOptions() {
        const selects = document.querySelectorAll('select[id*="Kelas"]');

        selects.forEach((select) => {
          // Clear existing options except the first one
          while (select.children.length > 1) {
            select.removeChild(select.lastChild);
          }

          // Add new options
          dataKelas.forEach((kelas) => {
            const option = document.createElement("option");
            option.value = kelas.id;
            option.textContent = kelas.nama;
            select.appendChild(option);
          });
        });
      }

      // Fungsi load data kegiatan dengan pagination
      async function loadKegiatan(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(
            page,
            paginationState.kegiatan.pageSize
          );

          const { data, error, count } = await supabase
            .from("kegiatan")
            .select("*", { count: "exact" })
            .range(from, to)
            .order("tanggal", { ascending: false });

          if (error) {
            console.error("Error loading kegiatan:", error);
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error loading kegiatan: " + error.message,
            });
            return;
          }

          paginationState.kegiatan.count = count || 0;
          paginationState.kegiatan.page = page;

          updateKegiatanTable(data);
          updatePagination("kegiatan");
        } catch (err) {
          console.error("Error loading kegiatan:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data kegiatan",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel kegiatan
      function updateKegiatanTable(data) {
        const tbody = document.getElementById("kegiatanTableBody");
        tbody.innerHTML = "";

        data.forEach((kegiatan) => {
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${formatDate(kegiatan.tanggal)}</td>
              <td>${kegiatan.nama}</td>
              <td>${kegiatan.penanggung_jawab || "-"}</td>
              <td>${kegiatan.lokasi || "-"}</td>
              <td><span class="status-badge ${getStatusClass(
                kegiatan.status
              )}">${getStatusText(kegiatan.status)}</span></td>
              <td>
                  <button class="btn btn-sm btn-primary" onclick="editKegiatan('${
                    kegiatan.id
                  }')">
                      <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteKegiatan('${
                    kegiatan.id
                  }')">
                      <i class="bi bi-trash"></i>
                  </button>
              </td>
          `;
          tbody.appendChild(row);
        });
      }

      // Fungsi load data fasilitas dengan pagination
      async function loadFasilitas(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(
            page,
            paginationState.fasilitas.pageSize
          );

          const { data, error, count } = await supabase
            .from("fasilitas")
            .select("*", { count: "exact" })
            .range(from, to)
            .order("nama");

          if (error) {
            console.error("Error loading fasilitas:", error);
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error loading fasilitas: " + error.message,
            });
            return;
          }

          paginationState.fasilitas.count = count || 0;
          paginationState.fasilitas.page = page;

          updateFasilitasTable(data);
          updatePagination("fasilitas");
        } catch (err) {
          console.error("Error loading fasilitas:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data fasilitas",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel fasilitas
      function updateFasilitasTable(data) {
        const tbody = document.getElementById("fasilitasTableBody");
        tbody.innerHTML = "";

        data.forEach((fasilitas) => {
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${fasilitas.nama}</td>
              <td>${fasilitas.kapasitas || "-"}</td>
              <td>${fasilitas.kondisi || "-"}</td>
              <td>${fasilitas.penanggung_jawab || "-"}</td>
              <td><span class="status-badge ${getStatusClass(
                fasilitas.status
              )}">${getStatusText(fasilitas.status)}</span></td>
              <td>
                  <button class="btn btn-sm btn-primary" onclick="editFasilitas('${
                    fasilitas.id
                  }')">
                      <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteFasilitas('${
                    fasilitas.id
                  }')">
                      <i class="bi bi-trash"></i>
                  </button>
              </td>
          `;
          tbody.appendChild(row);
        });
      }

      // Fungsi load data absensi dengan pagination
      async function loadAbsensi(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(
            page,
            paginationState.absensi.pageSize
          );

          const { data, error, count } = await supabase
            .from("absensi")
            .select(
              `
                *,
                santri (
                    id,
                    nama_lengkap,
                    nis,
                    kelas (
                        id,
                        nama
                    )
                )
            `,
              { count: "exact" }
            )
            .range(from, to)
            .order("tanggal", { ascending: false });

          if (error) {
            console.error("Error loading absensi:", error);
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error loading absensi: " + error.message,
            });
            return;
          }

          paginationState.absensi.count = count || 0;
          paginationState.absensi.page = page;

          updateAbsensiTable(data);
          updateAbsensiSummary(data);
          updatePagination("absensi");
        } catch (err) {
          console.error("Error loading absensi:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data absensi",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel absensi
      function updateAbsensiTable(data) {
        const tbody = document.getElementById("absensiTableBody");
        tbody.innerHTML = "";

        data.forEach((absensi) => {
          const row = document.createElement("tr");
          row.innerHTML = `
              <td>${absensi.santri.nama_lengkap}</td>
              <td>${absensi.santri.nis}</td>
              <td>${absensi.santri.kelas ? absensi.santri.kelas.nama : "-"}</td>
              <td>${formatDate(absensi.tanggal)}</td>
              <td><span class="status-badge ${getAbsensiStatusClass(
                absensi.status
              )}">${getAbsensiStatusText(absensi.status)}</span></td>
              <td>${absensi.keterangan || "-"}</td>
              <td>
                  <button class="btn btn-sm btn-primary" onclick="editAbsensi('${
                    absensi.id
                  }')">
                      <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteAbsensi('${
                    absensi.id
                  }')">
                      <i class="bi bi-trash"></i>
                  </button>
              </td>
          `;
          tbody.appendChild(row);
        });
      }

      // Fungsi update summary absensi
      function updateAbsensiSummary(data) {
        let hadirCount = 0;
        let sakitCount = 0;
        let pulangCount = 0;
        let mangkirCount = 0;

        data.forEach((absensi) => {
          if (absensi.status === "hadir") hadirCount++;
          else if (absensi.status === "sakit") sakitCount++;
          else if (absensi.status === "pulang") pulangCount++;
          else if (absensi.status === "mangkir") mangkirCount++;
        });

        document.getElementById("santriHadirCount").textContent = hadirCount;
        document.getElementById("santriSakitCount").textContent = sakitCount;
        document.getElementById("santriPulangCount").textContent = pulangCount;
        document.getElementById("santriMangkirCount").textContent =
          mangkirCount;
      }

      // Fungsi load data kasus dengan pagination
      async function loadKasus(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(
            page,
            paginationState.kasus.pageSize
          );

          const { data, error, count } = await supabase
            .from("kasus")
            .select(
              `
                *,
                santri (
                    id,
                    nama_lengkap,
                    nis
                )
            `,
              { count: "exact" }
            )
            .range(from, to)
            .order("tanggal", { ascending: false });

          if (error) {
            console.error("Error loading kasus:", error);
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error loading kasus: " + error.message,
            });
            return;
          }

          paginationState.kasus.count = count || 0;
          paginationState.kasus.page = page;

          updateKasusContainer(data);
          updateKasusStatistics(data);
          updatePagination("kasus");
        } catch (err) {
          console.error("Error loading kasus:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data kasus",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi update container kasus
      function updateKasusContainer(data) {
        const container = document.getElementById("kasusContainer");
        container.innerHTML = "";

        data.forEach((kasus) => {
          const caseCard = document.createElement("div");
          caseCard.className = `case-card ${kasus.prioritas}`;

          caseCard.innerHTML = `
      <div class="case-header">
        <h4 class="case-title">${kasus.judul}</h4>
        <div class="case-date">${formatDate(kasus.tanggal)}</div>
      </div>
      <div class="case-description">
        <p><strong>Santri:</strong> ${kasus.santri.nama_lengkap} (${
            kasus.santri.nis
          })</p>
        <p><strong>Jenis Pelanggaran:</strong> ${getKasusJenisText(
          kasus.jenis
        )}</p>
        <p>${kasus.deskripsi}</p>
        <p><strong>Tindakan:</strong> ${
          kasus.tindakan || "Belum ada tindakan"
        }</p>
        <p><strong>Penanggung Jawab:</strong> ${
          kasus.penanggung_jawab || "-"
        }</p>
      </div>
      <div class="case-footer">
        <span class="status-badge ${getKasusStatusClass(
          kasus.status
        )}">${getKasusStatusText(kasus.status)}</span>
        <span class="status-badge ${getKasusPrioritasClass(
          kasus.prioritas
        )}">${getKasusPrioritasText(kasus.prioritas)}</span>
        <div class="case-actions">
          <button class="btn btn-sm btn-primary" onclick="editKasus('${
            kasus.id
          }')">
            <i class="bi bi-pencil"></i> Edit
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteKasus('${
            kasus.id
          }')">
            <i class="bi bi-trash"></i> Hapus
          </button>
        </div>
      </div>
    `;

          container.appendChild(caseCard);
        });
      }

      // Function to update kasus statistics
      function updateKasusStatistics(data) {
        let totalKasus = data.length;
        let kasusAktif = 0;
        let kasusSelesai = 0;

        data.forEach((kasus) => {
          if (
            kasus.status === "terbuka" ||
            kasus.status === "dalam-proses" ||
            kasus.status === "menunggu-konfirmasi"
          ) {
            kasusAktif++;
          } else if (kasus.status === "selesai") {
            kasusSelesai++;
          }
        });

        document.getElementById("totalKasusCount").textContent = totalKasus;
        document.getElementById("kasusAktifCount").textContent = kasusAktif;
        document.getElementById("kasusSelesaiCount").textContent = kasusSelesai;
      }

      // Fungsi load data karakter
      async function loadKarakter() {
        showLoading();
        try {
          const santriId = document.getElementById("karakterSantri").value;
          const periode = document.getElementById("karakterPeriode").value;

          if (!santriId) {
            Swal.fire({
              icon: "warning",
              title: "Peringatan",
              text: "Silakan pilih santri terlebih dahulu",
            });
            hideLoading();
            return;
          }

          // Tentukan rentang tanggal berdasarkan periode
          let startDate, endDate;
          const today = new Date();

          if (periode === "bulan-ini") {
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          } else if (periode === "bulan-lalu") {
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
          } else if (periode === "3-bulan-terakhir") {
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          } else if (periode === "semester-ini") {
            // Assuming semester starts in January and July
            if (today.getMonth() >= 0 && today.getMonth() <= 5) {
              startDate = new Date(today.getFullYear(), 0, 1);
              endDate = new Date(today.getFullYear(), 5, 30);
            } else {
              startDate = new Date(today.getFullYear(), 6, 1);
              endDate = new Date(today.getFullYear(), 11, 31);
            }
          } else if (periode === "tahun-ini") {
            startDate = new Date(today.getFullYear(), 0, 1);
            endDate = new Date(today.getFullYear(), 11, 31);
          }

          const startDateString = startDate.toISOString().split("T")[0];
          const endDateString = endDate.toISOString().split("T")[0];

          const { data, error } = await supabase
            .from("karakter")
            .select("*")
            .eq("santri_id", santriId)
            .gte("tanggal", startDateString)
            .lte("tanggal", endDateString)
            .order("tanggal", { ascending: false });

          if (error) {
            console.error("Error loading karakter:", error);
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error loading karakter: " + error.message,
            });
            hideLoading();
            return;
          }

          updateKarakterContainer(data);
          updateKarakterStatistics(data);
        } catch (err) {
          console.error("Error loading karakter:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data karakter",
          });
        } finally {
          hideLoading();
        }
      }

      // Function to update karakter statistics
      function updateKarakterStatistics(data) {
        if (!data || data.length === 0) {
          document.getElementById("avgSikapCount").textContent = "0";
          document.getElementById("avgKomunikasiCount").textContent = "0";
          document.getElementById("avgEtosKerjaCount").textContent = "0";
          document.getElementById("avgDisiplinCount").textContent = "0";
          return;
        }

        let totalSikap = 0,
          totalKomunikasi = 0,
          totalEtosKerja = 0,
          totalDisiplin = 0;

        data.forEach((item) => {
          totalSikap += item.sikap || 0;
          totalKomunikasi += item.komunikasi || 0;
          totalEtosKerja += item.etos_kerja || 0;
          totalDisiplin += item.disiplin || 0;
        });

        const count = data.length;
        document.getElementById("avgSikapCount").textContent = Math.round(
          totalSikap / count
        );
        document.getElementById("avgKomunikasiCount").textContent = Math.round(
          totalKomunikasi / count
        );
        document.getElementById("avgEtosKerjaCount").textContent = Math.round(
          totalEtosKerja / count
        );
        document.getElementById("avgDisiplinCount").textContent = Math.round(
          totalDisiplin / count
        );
      }

      // Fungsi update container karakter
      function updateKarakterContainer(data) {
        const container = document.getElementById("karakterContainer");
        container.innerHTML = "";

        if (!data || data.length === 0) {
          container.innerHTML =
            '<p class="text-center">Tidak ada data karakter untuk periode yang dipilih</p>';
          return;
        }

        // Hitung rata-rata nilai
        let avgSikap = 0,
          avgKomunikasi = 0,
          avgEtosKerja = 0,
          avgDisiplin = 0;

        data.forEach((item) => {
          avgSikap += item.sikap || 0;
          avgKomunikasi += item.komunikasi || 0;
          avgEtosKerja += item.etos_kerja || 0;
          avgDisiplin += item.disiplin || 0;
        });

        const count = data.length;
        avgSikap = Math.round(avgSikap / count);
        avgKomunikasi = Math.round(avgKomunikasi / count);
        avgEtosKerja = Math.round(avgEtosKerja / count);
        avgDisiplin = Math.round(avgDisiplin / count);

        // Buat assessment card untuk setiap aspek
        const assessmentItems = [
          {
            title: "Sikap",
            value: avgSikap,
            description:
              "Menilai perilaku dan sikap santri dalam kehidupan sehari-hari",
          },
          {
            title: "Komunikasi",
            value: avgKomunikasi,
            description:
              "Menilai kemampuan berkomunikasi dengan teman dan guru",
          },
          {
            title: "Etos Kerja",
            value: avgEtosKerja,
            description:
              "Menilai semangat dan dedikasi dalam menyelesaikan tugas",
          },
          {
            title: "Disiplin",
            value: avgDisiplin,
            description:
              "Menilai kedisiplinan dalam mengikuti aturan dan jadwal",
          },
        ];

        assessmentItems.forEach((item) => {
          const assessmentDiv = document.createElement("div");
          assessmentDiv.className = "character-assessment";

          const scoreClass = getCharacterScoreClass(item.value);
          const scoreText = getCharacterScoreText(item.value);

          assessmentDiv.innerHTML = `
      <div class="assessment-header">
        <h4 class="assessment-title">${item.title}</h4>
        <span class="assessment-item-score ${scoreClass}">${item.value}</span>
      </div>
      <div class="assessment-item-description">${item.description}</div>
      <div class="assessment-item-progress">
        <div class="assessment-item-progress-bar" style="width: ${item.value}%"></div>
      </div>
      <div class="mt-2 text-center">
        <span class="status-badge ${scoreClass}">${scoreText}</span>
      </div>
    `;

          container.appendChild(assessmentDiv);
        });

        // Tambahkan tombol untuk menambah penilaian baru
        const addAssessmentBtn = document.createElement("div");
        addAssessmentBtn.className = "text-center mt-4";
        addAssessmentBtn.innerHTML = `
    <button class="btn-primary-custom" onclick="openModal('karakterModal')">
      <i class="bi bi-plus"></i> Tambah Penilaian
    </button>
  `;
        container.appendChild(addAssessmentBtn);
      }

      // Fungsi save santri
      async function saveSantri() {
        const id = document.getElementById("santriId").value;
        const nis = document.getElementById("santriNIS").value;
        const fullName = document.getElementById("santriNama").value;
        const birthPlace = document.getElementById("santriTempatLahir").value;
        const birthDate = document.getElementById("santriTanggalLahir").value;
        const kelasId = document.getElementById("santriKelas").value;
        const address = document.getElementById("santriAlamat").value;
        const parentName = document.getElementById("santriOrtu").value;
        const parentPhone = document.getElementById("santriHPOrtu").value;
        const status = document.getElementById("santriStatus").value;

        if (!nis || !fullName || !kelasId) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon lengkapi semua field yang diperlukan",
          });
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing santri
            result = await supabase
              .from("santri")
              .update({
                nis: nis,
                nama_lengkap: fullName,
                tempat_lahir: birthPlace,
                tanggal_lahir: birthDate,
                kelas_id: kelasId,
                alamat: address,
                nama_ortu: parentName,
                hp_ortu: parentPhone,
                status: status,
              })
              .eq("id", id);
          } else {
            // Insert new santri
            result = await supabase.from("santri").insert([
              {
                nis: nis,
                nama_lengkap: fullName,
                tempat_lahir: birthPlace,
                tanggal_lahir: birthDate,
                kelas_id: kelasId,
                alamat: address,
                nama_ortu: parentName,
                hp_ortu: parentPhone,
                status: status,
              },
            ]);
          }

          if (result.error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + result.error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: `Data santri berhasil ${id ? "diperbarui" : "disimpan"}!`,
            timer: 1500,
            showConfirmButton: false,
          });
          closeModal("santriModal");

          // Clear form
          document.getElementById("santriId").value = "";
          document.getElementById("santriNIS").value = "";
          document.getElementById("santriNama").value = "";
          document.getElementById("santriTempatLahir").value = "";
          document.getElementById("santriTanggalLahir").value = "";
          document.getElementById("santriKelas").value = "";
          document.getElementById("santriAlamat").value = "";
          document.getElementById("santriOrtu").value = "";
          document.getElementById("santriHPOrtu").value = "";
          document.getElementById("santriStatus").value = "aktif";

          // Reload data
          await loadSantri(paginationState.santri.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit santri
      async function editSantri(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("santri")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("santriId").value = data.id;
          document.getElementById("santriNIS").value = data.nis;
          document.getElementById("santriNama").value = data.nama_lengkap;
          document.getElementById("santriTempatLahir").value =
            data.tempat_lahir || "";
          document.getElementById("santriTanggalLahir").value =
            data.tanggal_lahir || "";
          document.getElementById("santriKelas").value = data.kelas_id || "";
          document.getElementById("santriAlamat").value = data.alamat || "";
          document.getElementById("santriOrtu").value = data.nama_ortu || "";
          document.getElementById("santriHPOrtu").value = data.hp_ortu || "";
          document.getElementById("santriStatus").value =
            data.status || "aktif";

          // Update modal title
          document.getElementById("santriModalTitle").textContent =
            "Edit Data Santri";

          // Open modal
          openModal("santriModal");
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data santri",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete santri
      async function deleteSantri(id) {
        const result = await Swal.fire({
          title: "Konfirmasi Hapus",
          text: "Apakah Anda yakin ingin menghapus data santri ini?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, hapus!",
        });

        if (!result.isConfirmed) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase.from("santri").delete().eq("id", id);

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Data santri berhasil dihapus!",
            timer: 1500,
            showConfirmButton: false,
          });

          // Reload data
          await loadSantri(paginationState.santri.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menghapus data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi save guru
      async function saveGuru() {
        const id = document.getElementById("pengajarId").value;
        const nip = document.getElementById("pengajarNIP").value;
        const fullName = document.getElementById("pengajarNama").value;
        const subject = document.getElementById("pengajarMapel").value;
        const phone = document.getElementById("pengajarHP").value;
        const email = document.getElementById("pengajarEmail").value;
        const address = document.getElementById("pengajarAlamat").value;
        const status = document.getElementById("pengajarStatus").value;

        if (!nip || !fullName || !subject) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon lengkapi semua field yang diperlukan",
          });
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing guru
            result = await supabase
              .from("guru")
              .update({
                nip: nip,
                nama_lengkap: fullName,
                mata_pelajaran: subject,
                no_hp: phone,
                email: email,
                alamat: address,
                status: status,
              })
              .eq("id", id);
          } else {
            // Insert new guru
            result = await supabase.from("guru").insert([
              {
                nip: nip,
                nama_lengkap: fullName,
                mata_pelajaran: subject,
                no_hp: phone,
                email: email,
                alamat: address,
                status: status,
              },
            ]);
          }

          if (result.error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + result.error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: `Data guru berhasil ${id ? "diperbarui" : "disimpan"}!`,
            timer: 1500,
            showConfirmButton: false,
          });
          closeModal("pengajarModal");

          // Clear form
          document.getElementById("pengajarId").value = "";
          document.getElementById("pengajarNIP").value = "";
          document.getElementById("pengajarNama").value = "";
          document.getElementById("pengajarMapel").value = "";
          document.getElementById("pengajarHP").value = "";
          document.getElementById("pengajarEmail").value = "";
          document.getElementById("pengajarAlamat").value = "";
          document.getElementById("pengajarStatus").value = "aktif";

          // Reload data
          await loadGuru(paginationState.guru.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit guru
      async function editGuru(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("guru")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("pengajarId").value = data.id;
          document.getElementById("pengajarNIP").value = data.nip;
          document.getElementById("pengajarNama").value = data.nama_lengkap;
          document.getElementById("pengajarMapel").value =
            data.mata_pelajaran || "";
          document.getElementById("pengajarHP").value = data.no_hp || "";
          document.getElementById("pengajarEmail").value = data.email || "";
          document.getElementById("pengajarAlamat").value = data.alamat || "";
          document.getElementById("pengajarStatus").value =
            data.status || "aktif";

          // Update modal title
          document.getElementById("pengajarModalTitle").textContent =
            "Edit Data Pengajar";

          // Open modal
          openModal("pengajarModal");
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data guru",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete guru
      async function deleteGuru(id) {
        const result = await Swal.fire({
          title: "Konfirmasi Hapus",
          text: "Apakah Anda yakin ingin menghapus data guru ini?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, hapus!",
        });

        if (!result.isConfirmed) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase.from("guru").delete().eq("id", id);

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Data guru berhasil dihapus!",
            timer: 1500,
            showConfirmButton: false,
          });

          // Reload data
          await loadGuru(paginationState.guru.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menghapus data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi save kegiatan
      async function saveKegiatan() {
        const id = document.getElementById("kegiatanId").value;
        const name = document.getElementById("kegiatanNama").value;
        const date = document.getElementById("kegiatanTanggal").value;
        const time = document.getElementById("kegiatanWaktu").value;
        const location = document.getElementById("kegiatanLokasi").value;
        const organizer = document.getElementById("kegiatanPJ").value;
        const status = document.getElementById("kegiatanStatus").value;
        const description = document.getElementById("kegiatanDeskripsi").value;

        if (!name || !date || !location) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon lengkapi semua field yang diperlukan",
          });
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing kegiatan
            result = await supabase
              .from("kegiatan")
              .update({
                nama: name,
                tanggal: date,
                waktu: time,
                lokasi: location,
                penanggung_jawab: organizer,
                status: status,
                deskripsi: description,
              })
              .eq("id", id);
          } else {
            // Insert new kegiatan
            result = await supabase.from("kegiatan").insert([
              {
                nama: name,
                tanggal: date,
                waktu: time,
                lokasi: location,
                penanggung_jawab: organizer,
                status: status,
                deskripsi: description,
              },
            ]);
          }

          if (result.error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + result.error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: `Data kegiatan berhasil ${id ? "diperbarui" : "disimpan"}!`,
            timer: 1500,
            showConfirmButton: false,
          });
          closeModal("kegiatanModal");

          // Clear form
          document.getElementById("kegiatanId").value = "";
          document.getElementById("kegiatanNama").value = "";
          document.getElementById("kegiatanTanggal").value = "";
          document.getElementById("kegiatanWaktu").value = "";
          document.getElementById("kegiatanLokasi").value = "";
          document.getElementById("kegiatanPJ").value = "";
          document.getElementById("kegiatanStatus").value = "dalam_proses";
          document.getElementById("kegiatanDeskripsi").value = "";

          // Reload data
          await loadKegiatan(paginationState.kegiatan.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit kegiatan
      async function editKegiatan(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("kegiatan")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("kegiatanId").value = data.id;
          document.getElementById("kegiatanNama").value = data.nama;
          document.getElementById("kegiatanTanggal").value = data.tanggal;
          document.getElementById("kegiatanWaktu").value = data.waktu || "";
          document.getElementById("kegiatanLokasi").value = data.lokasi || "";
          document.getElementById("kegiatanPJ").value =
            data.penanggung_jawab || "";
          document.getElementById("kegiatanStatus").value =
            data.status || "dalam_proses";
          document.getElementById("kegiatanDeskripsi").value =
            data.deskripsi || "";

          // Update modal title
          document.getElementById("kegiatanModalTitle").textContent =
            "Edit Data Kegiatan";

          // Open modal
          openModal("kegiatanModal");
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data kegiatan",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete kegiatan
      async function deleteKegiatan(id) {
        const result = await Swal.fire({
          title: "Konfirmasi Hapus",
          text: "Apakah Anda yakin ingin menghapus data kegiatan ini?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, hapus!",
        });

        if (!result.isConfirmed) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase
            .from("kegiatan")
            .delete()
            .eq("id", id);

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Data kegiatan berhasil dihapus!",
            timer: 1500,
            showConfirmButton: false,
          });

          // Reload data
          await loadKegiatan(paginationState.kegiatan.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menghapus data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi save fasilitas
      async function saveFasilitas() {
        const id = document.getElementById("fasilitasId").value;
        const name = document.getElementById("fasilitasNama").value;
        const capacity = document.getElementById("fasilitasKapasitas").value;
        const condition = document.getElementById("fasilitasKondisi").value;
        const pic = document.getElementById("fasilitasPJ").value;
        const status = document.getElementById("fasilitasStatus").value;
        const description = document.getElementById("fasilitasDeskripsi").value;

        if (!name || !capacity || !condition) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon lengkapi semua field yang diperlukan",
          });
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing fasilitas
            result = await supabase
              .from("fasilitas")
              .update({
                nama: name,
                kapasitas: capacity,
                kondisi: condition,
                penanggung_jawab: pic,
                status: status,
                deskripsi: description,
              })
              .eq("id", id);
          } else {
            // Insert new fasilitas
            result = await supabase.from("fasilitas").insert([
              {
                nama: name,
                kapasitas: capacity,
                kondisi: condition,
                penanggung_jawab: pic,
                status: status,
                deskripsi: description,
              },
            ]);
          }

          if (result.error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + result.error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: `Data fasilitas berhasil ${id ? "diperbarui" : "disimpan"}!`,
            timer: 1500,
            showConfirmButton: false,
          });
          closeModal("fasilitasModal");

          // Clear form
          document.getElementById("fasilitasId").value = "";
          document.getElementById("fasilitasNama").value = "";
          document.getElementById("fasilitasKapasitas").value = "";
          document.getElementById("fasilitasKondisi").value = "";
          document.getElementById("fasilitasPJ").value = "";
          document.getElementById("fasilitasStatus").value = "tersedia";
          document.getElementById("fasilitasDeskripsi").value = "";

          // Reload data
          await loadFasilitas(paginationState.fasilitas.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit fasilitas
      async function editFasilitas(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("fasilitas")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("fasilitasId").value = data.id;
          document.getElementById("fasilitasNama").value = data.nama;
          document.getElementById("fasilitasKapasitas").value =
            data.kapasitas || "";
          document.getElementById("fasilitasKondisi").value =
            data.kondisi || "";
          document.getElementById("fasilitasPJ").value =
            data.penanggung_jawab || "";
          document.getElementById("fasilitasStatus").value =
            data.status || "tersedia";
          document.getElementById("fasilitasDeskripsi").value =
            data.deskripsi || "";

          // Update modal title
          document.getElementById("fasilitasModalTitle").textContent =
            "Edit Data Fasilitas";

          // Open modal
          openModal("fasilitasModal");
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data fasilitas",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete fasilitas
      async function deleteFasilitas(id) {
        const result = await Swal.fire({
          title: "Konfirmasi Hapus",
          text: "Apakah Anda yakin ingin menghapus data fasilitas ini?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, hapus!",
        });

        if (!result.isConfirmed) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase
            .from("fasilitas")
            .delete()
            .eq("id", id);

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Data fasilitas berhasil dihapus!",
            timer: 1500,
            showConfirmButton: false,
          });

          // Reload data
          await loadFasilitas(paginationState.fasilitas.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menghapus data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi save absensi
      async function saveAbsensi() {
        const id = document.getElementById("absensiId").value;
        const santriId = document.getElementById("absensiSantri").value;
        const date = document.getElementById("absensiTanggal").value;
        const status = document.getElementById("absensiStatus").value;
        const notes = document.getElementById("absensiKeterangan").value;

        if (!santriId || !date || !status) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon lengkapi semua field yang diperlukan",
          });
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing absensi
            result = await supabase
              .from("absensi")
              .update({
                santri_id: santriId,
                tanggal: date,
                status: status,
                keterangan: notes,
              })
              .eq("id", id);
          } else {
            // Insert new absensi
            result = await supabase.from("absensi").insert([
              {
                santri_id: santriId,
                tanggal: date,
                status: status,
                keterangan: notes,
              },
            ]);
          }

          if (result.error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + result.error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: `Data absensi berhasil ${id ? "diperbarui" : "disimpan"}!`,
            timer: 1500,
            showConfirmButton: false,
          });
          closeModal("absensiModal");

          // Clear form
          document.getElementById("absensiId").value = "";
          document.getElementById("absensiSantri").value = "";
          document.getElementById("absensiTanggal").value = "";
          document.getElementById("absensiStatus").value = "";
          document.getElementById("absensiKeterangan").value = "";

          // Reload data
          await loadAbsensi(paginationState.absensi.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit absensi
      async function editAbsensi(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("absensi")
            .select(
              `
        *,
        santri (
          id,
          nama_lengkap,
          nis
        )
      `
            )
            .eq("id", id)
            .single();

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("absensiId").value = data.id;
          document.getElementById("absensiSantri").value = data.santri_id;
          document.getElementById("absensiTanggal").value = data.tanggal;
          document.getElementById("absensiStatus").value = data.status;
          document.getElementById("absensiKeterangan").value =
            data.keterangan || "";

          // Update modal title
          document.getElementById("absensiModalTitle").textContent =
            "Edit Data Absensi";

          // Open modal
          openModal("absensiModal");
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data absensi",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete absensi
      async function deleteAbsensi(id) {
        const result = await Swal.fire({
          title: "Konfirmasi Hapus",
          text: "Apakah Anda yakin ingin menghapus data absensi ini?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, hapus!",
        });

        if (!result.isConfirmed) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase
            .from("absensi")
            .delete()
            .eq("id", id);

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Data absensi berhasil dihapus!",
            timer: 1500,
            showConfirmButton: false,
          });

          // Reload data
          await loadAbsensi(paginationState.absensi.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menghapus data",
          });
        } finally {
          hideLoading();
        }
      }

      // Update saveKarakter function to handle the new form fields
      async function saveKarakter() {
        const id = document.getElementById("karakterId").value;
        const santriId = document.getElementById("karakterSantriForm").value;
        const periode = document.getElementById("karakterPeriodeForm").value;
        const tanggal = document.getElementById("karakterTanggal").value;
        const sikap = document.getElementById("sikapRange").value;
        const komunikasi = document.getElementById("komunikasiRange").value;
        const etosKerja = document.getElementById("etosKerjaRange").value;
        const disiplin = document.getElementById("disiplinRange").value;
        const sikapKeterangan = document.getElementById(
          "karakterSikapKeterangan"
        ).value;
        const komunikasiKeterangan = document.getElementById(
          "karakterKomunikasiKeterangan"
        ).value;
        const etosKerjaKeterangan = document.getElementById(
          "karakterEtosKerjaKeterangan"
        ).value;
        const disiplinKeterangan = document.getElementById(
          "karakterDisiplinKeterangan"
        ).value;
        const catatan = document.getElementById("karakterCatatan").value;
        const penilai = document.getElementById("karakterPenilai").value;

        if (!santriId || !periode || !tanggal || !penilai) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon lengkapi semua field yang diperlukan",
          });
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing karakter
            result = await supabase
              .from("karakter")
              .update({
                santri_id: santriId,
                periode: periode,
                tanggal: tanggal,
                sikap: sikap,
                komunikasi: komunikasi,
                etos_kerja: etosKerja,
                disiplin: disiplin,
                sikap_keterangan: sikapKeterangan,
                komunikasi_keterangan: komunikasiKeterangan,
                etos_kerja_keterangan: etosKerjaKeterangan,
                disiplin_keterangan: disiplinKeterangan,
                catatan: catatan,
                penilai: penilai,
              })
              .eq("id", id);
          } else {
            // Insert new karakter
            result = await supabase.from("karakter").insert([
              {
                santri_id: santriId,
                periode: periode,
                tanggal: tanggal,
                sikap: sikap,
                komunikasi: komunikasi,
                etos_kerja: etosKerja,
                disiplin: disiplin,
                sikap_keterangan: sikapKeterangan,
                komunikasi_keterangan: komunikasiKeterangan,
                etos_kerja_keterangan: etosKerjaKeterangan,
                disiplin_keterangan: disiplinKeterangan,
                catatan: catatan,
                penilai: penilai,
              },
            ]);
          }

          if (result.error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + result.error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: `Data penilaian karakter berhasil ${
              id ? "diperbarui" : "disimpan"
            }!`,
            timer: 1500,
            showConfirmButton: false,
          });
          closeModal("karakterModal");

          // Clear form
          document.getElementById("karakterId").value = "";
          document.getElementById("karakterSantriForm").value = "";
          document.getElementById("karakterPeriodeForm").value = "";
          document.getElementById("karakterTanggal").value = "";
          document.getElementById("sikapRange").value = 50;
          document.getElementById("komunikasiRange").value = 50;
          document.getElementById("etosKerjaRange").value = 50;
          document.getElementById("disiplinRange").value = 50;
          document.getElementById("sikapScore").textContent = "50";
          document.getElementById("komunikasiScore").textContent = "50";
          document.getElementById("etosKerjaScore").textContent = "50";
          document.getElementById("disiplinScore").textContent = "50";
          document.getElementById("karakterSikapKeterangan").value = "";
          document.getElementById("karakterKomunikasiKeterangan").value = "";
          document.getElementById("karakterEtosKerjaKeterangan").value = "";
          document.getElementById("karakterDisiplinKeterangan").value = "";
          document.getElementById("karakterCatatan").value = "";
          document.getElementById("karakterPenilai").value = "";

          // Reload data
          await loadKarakter();
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit kasus
      async function editKasus(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("kasus")
            .select(
              `
      *,
      santri (
        id,
        nama_lengkap,
        nis
      )
    `
            )
            .eq("id", id)
            .single();

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("kasusId").value = data.id;
          document.getElementById("kasusJudul").value = data.judul;
          document.getElementById("kasusSantri").value = data.santri_id;
          document.getElementById("kasusTanggal").value = data.tanggal;
          document.getElementById("kasusJenis").value = data.jenis || "";
          document.getElementById("kasusPrioritas").value = data.prioritas;
          document.getElementById("kasusStatus").value = data.status;
          document.getElementById("kasusDeskripsi").value = data.deskripsi;
          document.getElementById("kasusSaksi").value = data.saksi || "";
          document.getElementById("kasusTindakan").value = data.tindakan || "";
          document.getElementById("kasusPJ").value = data.penanggung_jawab;
          document.getElementById("kasusTindakLanjut").value =
            data.tindak_lanjut || "";

          // Update modal title
          document.getElementById("kasusModalTitle").textContent = "Edit Kasus";

          // Open modal
          openModal("kasusModal");
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data kasus",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete kasus
      async function deleteKasus(id) {
        const result = await Swal.fire({
          title: "Konfirmasi Hapus",
          text: "Apakah Anda yakin ingin menghapus data kasus ini?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Ya, hapus!",
        });

        if (!result.isConfirmed) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase.from("kasus").delete().eq("id", id);

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Data kasus berhasil dihapus!",
            timer: 1500,
            showConfirmButton: false,
          });

          // Reload data
          await loadKasus(paginationState.kasus.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menghapus data",
          });
        } finally {
          hideLoading();
        }
      }

      // Update saveKasus function to handle the new form fields
      async function saveKasus() {
        const id = document.getElementById("kasusId").value;
        const title = document.getElementById("kasusJudul").value;
        const santriId = document.getElementById("kasusSantri").value;
        const date = document.getElementById("kasusTanggal").value;
        const jenis = document.getElementById("kasusJenis").value;
        const priority = document.getElementById("kasusPrioritas").value;
        const status = document.getElementById("kasusStatus").value;
        const description = document.getElementById("kasusDeskripsi").value;
        const saksi = document.getElementById("kasusSaksi").value;
        const action = document.getElementById("kasusTindakan").value;
        const pic = document.getElementById("kasusPJ").value;
        const tindakLanjut = document.getElementById("kasusTindakLanjut").value;

        if (
          !title ||
          !santriId ||
          !date ||
          !priority ||
          !status ||
          !description ||
          !pic
        ) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon lengkapi semua field yang diperlukan",
          });
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing kasus
            result = await supabase
              .from("kasus")
              .update({
                judul: title,
                santri_id: santriId,
                tanggal: date,
                jenis: jenis,
                prioritas: priority,
                status: status,
                deskripsi: description,
                saksi: saksi,
                tindakan: action,
                penanggung_jawab: pic,
                tindak_lanjut: tindakLanjut,
              })
              .eq("id", id);
          } else {
            // Insert new kasus
            result = await supabase.from("kasus").insert([
              {
                judul: title,
                santri_id: santriId,
                tanggal: date,
                jenis: jenis,
                prioritas: priority,
                status: status,
                deskripsi: description,
                saksi: saksi,
                tindakan: action,
                penanggung_jawab: pic,
                tindak_lanjut: tindakLanjut,
              },
            ]);
          }

          if (result.error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + result.error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: `Data kasus berhasil ${id ? "diperbarui" : "disimpan"}!`,
            timer: 1500,
            showConfirmButton: false,
          });
          closeModal("kasusModal");

          // Clear form
          document.getElementById("kasusId").value = "";
          document.getElementById("kasusJudul").value = "";
          document.getElementById("kasusSantri").value = "";
          document.getElementById("kasusTanggal").value = "";
          document.getElementById("kasusJenis").value = "";
          document.getElementById("kasusPrioritas").value = "";
          document.getElementById("kasusStatus").value = "";
          document.getElementById("kasusDeskripsi").value = "";
          document.getElementById("kasusSaksi").value = "";
          document.getElementById("kasusTindakan").value = "";
          document.getElementById("kasusPJ").value = "";
          document.getElementById("kasusTindakLanjut").value = "";

          // Reload data
          await loadKasus(paginationState.kasus.page);
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan data",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi load data absen guru
      async function loadAbsenGuru() {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;

        if (!tanggal) return;

        showLoading();

        try {
          // Get all guru
          const { data: guruData, error: guruError } = await supabase
            .from("guru")
            .select("*");

          if (guruError) {
            console.error("Error loading guru:", guruError);
            hideLoading();
            return;
          }

          // Get attendance data
          const { data: attendanceData, error: attendanceError } =
            await supabase
              .from("absensi_guru")
              .select("*")
              .eq("tanggal", tanggal)
              .eq("sesi", waktu);

          if (attendanceError) {
            console.error("Error loading attendance:", attendanceError);
            hideLoading();
            return;
          }

          // Create a map of attendance data
          const attendanceMap = {};
          attendanceData.forEach((attendance) => {
            attendanceMap[attendance.guru_id] = attendance;
          });

          // Update table
          const tbody = document.getElementById("absenGuruTableBody");
          tbody.innerHTML = "";

          guruData.forEach((guru) => {
            const attendance = attendanceMap[guru.id];
            const row = document.createElement("tr");
            row.innerHTML = `
                  <td>
                      <input type="checkbox" class="attendance-checkbox guru-checkbox" onchange="updateGuruSummary()">
                  </td>
                  <td>${guru.nama_lengkap}</td>
                  <td>${guru.nip}</td>
                  <td>${guru.mata_pelajaran}</td>
                  <td>
                      <select class="form-select form-select-sm" onchange="updateGuruStatus(this)">
                          <option value="hadir" ${
                            attendance && attendance.status === "hadir"
                              ? "selected"
                              : ""
                          }>Hadir</option>
                          <option value="tidak_hadir" ${
                            attendance && attendance.status === "tidak_hadir"
                              ? "selected"
                              : ""
                          }>Tidak Hadir</option>
                          <option value="izin" ${
                            attendance && attendance.status === "izin"
                              ? "selected"
                              : ""
                          }>Izin</option>
                      </select>
                  </td>
                  <td>
                      <input type="text" class="form-control form-control-sm" placeholder="Keterangan" value="${
                        attendance ? attendance.keterangan : ""
                      }">
                  </td>
              `;
            tbody.appendChild(row);
          });

          // Update summary
          updateGuruSummary();
        } catch (err) {
          console.error("Error loading absen guru:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data absensi",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi load data absen santri
      async function loadAbsenSantri() {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;
        const kelasId = document.getElementById("absenKelas").value;

        if (!tanggal) return;

        showLoading();

        try {
          // Get all santri
          let query = supabase.from("santri").select(`
              *,
              kelas (
                  id,
                  nama
              )
          `);

          // Filter by class if selected
          if (kelasId) {
            query = query.eq("kelas_id", kelasId);
          }

          const { data: santriData, error: santriError } = await query;

          if (santriError) {
            console.error("Error loading santri:", santriError);
            hideLoading();
            return;
          }

          // Get attendance data
          const { data: attendanceData, error: attendanceError } =
            await supabase
              .from("absensi_santri")
              .select("*")
              .eq("tanggal", tanggal)
              .eq("sesi", waktu);

          if (attendanceError) {
            console.error("Error loading attendance:", attendanceError);
            hideLoading();
            return;
          }

          // Create a map of attendance data
          const attendanceMap = {};
          attendanceData.forEach((attendance) => {
            attendanceMap[attendance.santri_id] = attendance;
          });

          // Update table
          const tbody = document.getElementById("absenSantriTableBody");
          tbody.innerHTML = "";

          santriData.forEach((santri) => {
            const attendance = attendanceMap[santri.id];
            const row = document.createElement("tr");
            row.innerHTML = `
                  <td>
                      <input type="checkbox" class="attendance-checkbox santri-checkbox" onchange="updateSantriSummary()">
                  </td>
                  <td>${santri.nama_lengkap}</td>
                  <td>${santri.nis}</td>
                  <td>${santri.kelas ? santri.kelas.nama : "-"}</td>
                  <td>
                      <select class="form-select form-select-sm" onchange="updateSantriStatus(this)">
                          <option value="hadir" ${
                            attendance && attendance.status === "hadir"
                              ? "selected"
                              : ""
                          }>Hadir</option>
                          <option value="tidak_hadir" ${
                            attendance && attendance.status === "tidak_hadir"
                              ? "selected"
                              : ""
                          }>Tidak Hadir</option>
                          <option value="izin" ${
                            attendance && attendance.status === "izin"
                              ? "selected"
                              : ""
                          }>Izin</option>
                      </select>
                  </td>
                  <td>
                      <input type="text" class="form-control form-control-sm" placeholder="Keterangan" value="${
                        attendance ? attendance.keterangan : ""
                      }">
                  </td>
              `;
            tbody.appendChild(row);
          });

          // Update summary
          updateSantriSummary();
        } catch (err) {
          console.error("Error loading absen santri:", err);
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data absensi",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi save absen guru menggunakan upsert
      async function saveAbsenGuru() {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;

        if (!tanggal) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon pilih tanggal absen",
          });
          return;
        }

        showLoading();

        try {
          // Get all guru rows
          const rows = document.querySelectorAll("#absenGuruTableBody tr");
          const attendanceData = [];

          // Get all guru data for mapping
          const { data: guruData } = await supabase
            .from("guru")
            .select("id, nama_lengkap");

          rows.forEach((row) => {
            const guruName = row.querySelector("td:nth-child(2)").textContent;
            const status = row.querySelector("select").value;
            const notes = row.querySelector('input[type="text"]').value;

            // Find guru by name
            const guru = guruData.find((g) => g.nama_lengkap === guruName);
            if (guru) {
              attendanceData.push({
                guru_id: guru.id,
                tanggal: tanggal,
                sesi: waktu,
                status: status,
                keterangan: notes,
              });
            }
          });

          // Use upsert to insert or update all records in a single operation
          const { error } = await supabase
            .from("absensi_guru")
            .upsert(attendanceData, {
              onConflict: "guru_id, tanggal, sesi",
            });

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Absen guru berhasil disimpan!",
            timer: 1500,
            showConfirmButton: false,
          });
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan absen",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi save absen santri menggunakan upsert
      async function saveAbsenSantri() {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;

        if (!tanggal) {
          Swal.fire({
            icon: "warning",
            title: "Peringatan",
            text: "Mohon pilih tanggal absen",
          });
          return;
        }

        showLoading();

        try {
          // Get all santri rows
          const rows = document.querySelectorAll("#absenSantriTableBody tr");
          const attendanceData = [];

          // Get all santri data for mapping
          const { data: santriData } = await supabase
            .from("santri")
            .select("id, nama_lengkap");

          rows.forEach((row) => {
            const santriName = row.querySelector("td:nth-child(2)").textContent;
            const status = row.querySelector("select").value;
            const notes = row.querySelector('input[type="text"]').value;

            // Find santri by name
            const santri = santriData.find(
              (s) => s.nama_lengkap === santriName
            );
            if (santri) {
              attendanceData.push({
                santri_id: santri.id,
                tanggal: tanggal,
                sesi: waktu,
                status: status,
                keterangan: notes,
              });
            }
          });

          // Use upsert to insert or update all records in a single operation
          const { error } = await supabase
            .from("absensi_santri")
            .upsert(attendanceData, {
              onConflict: "santri_id, tanggal, sesi",
            });

          if (error) {
            Swal.fire({
              icon: "error",
              title: "Kesalahan",
              text: "Error: " + error.message,
            });
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Absen santri berhasil disimpan!",
            timer: 1500,
            showConfirmButton: false,
          });
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat menyimpan absen",
          });
        } finally {
          hideLoading();
        }
      }

      // Fungsi filter absen
      function filterAbsen() {
        loadAbsenGuru();
        loadAbsenSantri();
      }

      // Fungsi filter absensi
      function filterAbsensi() {
        loadAbsensi();
      }

      // Fungsi filter kasus
      function filterKasus() {
        loadKasus();
      }

      // Fungsi filter karakter
      function filterKarakter() {
        loadKarakter();
      }

      // Fungsi update summary guru
      function updateGuruSummary() {
        const selects = document.querySelectorAll("#absenGuruTableBody select");
        let hadirCount = 0;
        let tidakHadirCount = 0;
        let izinCount = 0;

        selects.forEach((select) => {
          if (select.value === "hadir") hadirCount++;
          else if (select.value === "tidak_hadir") tidakHadirCount++;
          else if (select.value === "izin") izinCount++;
        });

        document.getElementById("guruHadirCount").textContent = hadirCount;
        document.getElementById("guruTidakHadirCount").textContent =
          tidakHadirCount;
        document.getElementById("guruIzinCount").textContent = izinCount;
      }

      // Fungsi update summary santri
      function updateSantriSummary() {
        const selects = document.querySelectorAll(
          "#absenSantriTableBody select"
        );
        let hadirCount = 0;
        let tidakHadirCount = 0;
        let izinCount = 0;

        selects.forEach((select) => {
          if (select.value === "hadir") hadirCount++;
          else if (select.value === "tidak_hadir") tidakHadirCount++;
          else if (select.value === "izin") izinCount++;
        });

        document.getElementById("santriHadirCount").textContent = hadirCount;
        document.getElementById("santriTidakHadirCount").textContent =
          tidakHadirCount;
        document.getElementById("santriIzinCount").textContent = izinCount;
      }

      // Fungsi toggle all checkboxes
      function toggleAllGuru() {
        const selectAllCheckbox = document.getElementById("selectAllGuru");
        const guruCheckboxes = document.querySelectorAll(".guru-checkbox");

        guruCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      }

      function toggleAllSantri() {
        const selectAllCheckbox = document.getElementById("selectAllSantri");
        const santriCheckboxes = document.querySelectorAll(".santri-checkbox");

        santriCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      }

      // Fungsi export PDF untuk data santri
      function exportSantriPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Tambahkan header
        let yPosition = addHeaderToPDF(doc);

        // Tambahkan judul laporan
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("Data Santri", 14, yPosition);
        yPosition += 10;

        // Tanggal export
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, yPosition);
        yPosition += 10;

        // Tabel data
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("NIS", 35, yPosition);
        doc.text("Nama Lengkap", 60, yPosition);
        doc.text("Kelas", 120, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("santri")
          .select(
            `
      *,
      kelas (
          id,
          nama
      )
  `
          )
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Data santri
            data.forEach((santri, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = addHeaderToPDF(doc);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Data Santri", 14, yPosition);
                yPosition += 10;

                doc.setFontSize(12);
                doc.text("No", 14, yPosition);
                doc.text("NIS", 35, yPosition);
                doc.text("Nama Lengkap", 60, yPosition);
                doc.text("Kelas", 120, yPosition);
                doc.text("Status", 160, yPosition);

                yPosition += 7;
                doc.line(14, yPosition, 195, yPosition);
                yPosition += 5;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(santri.nis, 35, yPosition);
              doc.text(santri.nama_lengkap, 60, yPosition);
              doc.text(santri.kelas ? santri.kelas.nama : "-", 120, yPosition);
              doc.text(
                santri.status === "aktif" ? "Aktif" : "Tidak Aktif",
                160,
                yPosition
              );

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_santri.pdf");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export PDF berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data guru
      function exportGuruPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Tambahkan header
        let yPosition = addHeaderToPDF(doc);

        // Tambahkan judul laporan
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("Data Guru", 14, yPosition);
        yPosition += 10;

        // Tanggal export
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, yPosition);
        yPosition += 10;

        // Tabel data
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("NIP", 35, yPosition);
        doc.text("Nama Lengkap", 60, yPosition);
        doc.text("Mata Pelajaran", 120, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("guru")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Data guru
            data.forEach((guru, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = addHeaderToPDF(doc);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Data Guru", 14, yPosition);
                yPosition += 10;

                doc.setFontSize(12);
                doc.text("No", 14, yPosition);
                doc.text("NIP", 35, yPosition);
                doc.text("Nama Lengkap", 60, yPosition);
                doc.text("Mata Pelajaran", 120, yPosition);
                doc.text("Status", 160, yPosition);

                yPosition += 7;
                doc.line(14, yPosition, 195, yPosition);
                yPosition += 5;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(guru.nip, 35, yPosition);
              doc.text(guru.nama_lengkap, 60, yPosition);
              doc.text(guru.mata_pelajaran || "-", 120, yPosition);
              doc.text(
                guru.status === "aktif" ? "Aktif" : "Tidak Aktif",
                160,
                yPosition
              );

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_guru.pdf");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export PDF berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data absensi
      function exportAbsensiPDF(type) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;
        const waktuText =
          waktu === "pagi" ? "Pagi" : waktu === "sore" ? "Sore" : "Malam";

        // Tambahkan header
        let yPosition = addHeaderToPDF(doc);

        // Tambahkan judul laporan
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(
          `Data Absensi ${type === "guru" ? "Guru" : "Santri"} Halaqoh`,
          14,
          yPosition
        );
        yPosition += 10;

        // Tanggal dan waktu
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Tanggal: ${formatDate(tanggal)}`, 14, yPosition);
        doc.text(`Sesi: ${waktuText}`, 14, yPosition + 5);
        yPosition += 15;

        // Tabel data
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text(type === "guru" ? "Nama Guru" : "Nama Santri", 35, yPosition);
        doc.text(type === "guru" ? "NIP" : "NIS", 90, yPosition);
        doc.text("Status", 130, yPosition);
        doc.text("Keterangan", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Ambil data dari tabel
        const tableId =
          type === "guru" ? "absenGuruTableBody" : "absenSantriTableBody";
        const rows = document.querySelectorAll(`#${tableId} tr`);

        // Data absensi
        rows.forEach((row, index) => {
          if (yPosition > 270) {
            doc.addPage();
            yPosition = addHeaderToPDF(doc);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(
              `Data Absensi ${type === "guru" ? "Guru" : "Santri"} Halaqoh`,
              14,
              yPosition
            );
            yPosition += 10;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Tanggal: ${formatDate(tanggal)}`, 14, yPosition);
            doc.text(`Sesi: ${waktuText}`, 14, yPosition + 5);
            yPosition += 15;

            doc.setFontSize(12);
            doc.text("No", 14, yPosition);
            doc.text(
              type === "guru" ? "Nama Guru" : "Nama Santri",
              35,
              yPosition
            );
            doc.text(type === "guru" ? "NIP" : "NIS", 90, yPosition);
            doc.text("Status", 130, yPosition);
            doc.text("Keterangan", 160, yPosition);

            yPosition += 7;
            doc.line(14, yPosition, 195, yPosition);
            yPosition += 5;
          }

          const cells = row.querySelectorAll("td");
          const statusSelect = cells[4].querySelector("select");
          const statusText = statusSelect
            ? statusSelect.options[statusSelect.selectedIndex].text
            : "-";
          const keterangan = cells[5].querySelector("input").value;

          doc.setFontSize(10);
          doc.text(`${index + 1}`, 14, yPosition);
          doc.text(cells[1].textContent, 35, yPosition);
          doc.text(cells[2].textContent, 90, yPosition);
          doc.text(statusText, 130, yPosition);
          doc.text(keterangan, 160, yPosition);

          yPosition += 7;
        });

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
            align: "center",
          });
        }

        // Save PDF
        doc.save(`absensi_${type}_${tanggal}.pdf`);
        Swal.fire({
          icon: "success",
          title: "Berhasil!",
          text: "Export PDF berhasil!",
          timer: 1500,
          showConfirmButton: false,
        });
      }

      // Fungsi export PDF untuk data absensi santri
      function exportAbsensiSantriPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Tambahkan header
        let yPosition = addHeaderToPDF(doc);

        // Tambahkan judul laporan
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("Data Absensi Santri", 14, yPosition);
        yPosition += 10;

        // Tanggal export
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, yPosition);
        yPosition += 10;

        // Tabel data
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("Nama", 35, yPosition);
        doc.text("NIS", 70, yPosition);
        doc.text("Kelas", 100, yPosition);
        doc.text("Tanggal", 130, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("absensi")
          .select(
            `
      *,
      santri (
          id,
          nama_lengkap,
          nis,
          kelas (
              id,
              nama
          )
      )
  `
          )
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Data absensi
            data.forEach((absensi, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = addHeaderToPDF(doc);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Data Absensi Santri", 14, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(
                  `Tanggal Export: ${formatDate(new Date())}`,
                  14,
                  yPosition
                );
                yPosition += 10;

                doc.setFontSize(12);
                doc.text("No", 14, yPosition);
                doc.text("Nama", 35, yPosition);
                doc.text("NIS", 70, yPosition);
                doc.text("Kelas", 100, yPosition);
                doc.text("Tanggal", 130, yPosition);
                doc.text("Status", 160, yPosition);

                yPosition += 7;
                doc.line(14, yPosition, 195, yPosition);
                yPosition += 5;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(absensi.santri.nama_lengkap, 35, yPosition);
              doc.text(absensi.santri.nis, 70, yPosition);
              doc.text(
                absensi.santri.kelas ? absensi.santri.kelas.nama : "-",
                100,
                yPosition
              );
              doc.text(formatDate(absensi.tanggal), 130, yPosition);
              doc.text(getAbsensiStatusText(absensi.status), 160, yPosition);

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_absensi_santri.pdf");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export PDF berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data kegiatan
      function exportKegiatanPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Tambahkan header
        let yPosition = addHeaderToPDF(doc);

        // Tambahkan judul laporan
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("Data Kegiatan", 14, yPosition);
        yPosition += 10;

        // Tanggal export
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, yPosition);
        yPosition += 10;

        // Tabel data
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("Tanggal", 35, yPosition);
        doc.text("Nama Kegiatan", 60, yPosition);
        doc.text("Penanggung Jawab", 120, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("kegiatan")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Data kegiatan
            data.forEach((kegiatan, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = addHeaderToPDF(doc);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Data Kegiatan", 14, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(
                  `Tanggal Export: ${formatDate(new Date())}`,
                  14,
                  yPosition
                );
                yPosition += 10;

                doc.setFontSize(12);
                doc.text("No", 14, yPosition);
                doc.text("Tanggal", 35, yPosition);
                doc.text("Nama Kegiatan", 60, yPosition);
                doc.text("Penanggung Jawab", 120, yPosition);
                doc.text("Status", 160, yPosition);

                yPosition += 7;
                doc.line(14, yPosition, 195, yPosition);
                yPosition += 5;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(formatDate(kegiatan.tanggal), 35, yPosition);
              doc.text(kegiatan.nama, 60, yPosition);
              doc.text(kegiatan.penanggung_jawab || "-", 120, yPosition);
              doc.text(getStatusText(kegiatan.status), 160, yPosition);

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_kegiatan.pdf");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export PDF berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data fasilitas
      function exportFasilitasPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Tambahkan header
        let yPosition = addHeaderToPDF(doc);

        // Tambahkan judul laporan
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("Data Fasilitas", 14, yPosition);
        yPosition += 10;

        // Tanggal export
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, yPosition);
        yPosition += 10;

        // Tabel data
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("Nama Fasilitas", 35, yPosition);
        doc.text("Kapasitas", 90, yPosition);
        doc.text("Kondisi", 120, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("fasilitas")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Data fasilitas
            data.forEach((fasilitas, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = addHeaderToPDF(doc);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Data Fasilitas", 14, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(
                  `Tanggal Export: ${formatDate(new Date())}`,
                  14,
                  yPosition
                );
                yPosition += 10;

                doc.setFontSize(12);
                doc.text("No", 14, yPosition);
                doc.text("Nama Fasilitas", 35, yPosition);
                doc.text("Kapasitas", 90, yPosition);
                doc.text("Kondisi", 120, yPosition);
                doc.text("Status", 160, yPosition);

                yPosition += 7;
                doc.line(14, yPosition, 195, yPosition);
                yPosition += 5;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(fasilitas.nama, 35, yPosition);
              doc.text(fasilitas.kapasitas || "-", 90, yPosition);
              doc.text(fasilitas.kondisi || "-", 120, yPosition);
              doc.text(getStatusText(fasilitas.status), 160, yPosition);

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_fasilitas.pdf");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export PDF berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data kasus
      function exportKasusPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Tambahkan header
        let yPosition = addHeaderToPDF(doc);

        // Tambahkan judul laporan
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("Data Kasus", 14, yPosition);
        yPosition += 10;

        // Tanggal export
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, yPosition);
        yPosition += 10;

        // Tabel data
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("Judul Kasus", 35, yPosition);
        doc.text("Santri", 90, yPosition);
        doc.text("Tanggal", 130, yPosition);
        doc.text("Prioritas", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("kasus")
          .select(
            `
      *,
      santri (
          id,
          nama_lengkap,
          nis
      )
  `
          )
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Data kasus
            data.forEach((kasus, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = addHeaderToPDF(doc);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Data Kasus", 14, yPosition);
                yPosition += 10;

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(
                  `Tanggal Export: ${formatDate(new Date())}`,
                  14,
                  yPosition
                );
                yPosition += 10;

                doc.setFontSize(12);
                doc.text("No", 14, yPosition);
                doc.text("Judul Kasus", 35, yPosition);
                doc.text("Santri", 90, yPosition);
                doc.text("Tanggal", 130, yPosition);
                doc.text("Prioritas", 160, yPosition);

                yPosition += 7;
                doc.line(14, yPosition, 195, yPosition);
                yPosition += 5;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(kasus.judul, 35, yPosition);
              doc.text(kasus.santri.nama_lengkap, 90, yPosition);
              doc.text(formatDate(kasus.tanggal), 130, yPosition);
              doc.text(getKasusPrioritasText(kasus.prioritas), 160, yPosition);

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_kasus.pdf");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export PDF berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data santri
      function exportSantriExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("santri")
          .select(
            `
      *,
      kelas (
          id,
          nama
      )
  `
          )
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((santri, index) => ({
              No: index + 1,
              NIS: santri.nis,
              "Nama Lengkap": santri.nama_lengkap,
              "Tempat Lahir": santri.tempat_lahir || "",
              "Tanggal Lahir": santri.tanggal_lahir || "",
              Kelas: santri.kelas ? santri.kelas.nama : "",
              Alamat: santri.alamat || "",
              "Nama Orang Tua": santri.nama_ortu || "",
              "HP Orang Tua": santri.hp_ortu || "",
              Status: santri.status === "aktif" ? "Aktif" : "Tidak Aktif",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Tambahkan header
            const startRow = addHeaderToExcel(ws);

            // Tambahkan judul tabel
            XLSX.utils.sheet_add_aoa(ws, [["Data Santri"]], {
              origin: `A${startRow}`,
            });

            // Atur style untuk judul tabel
            const titleCell = XLSX.utils.encode_cell({ r: startRow, c: 0 });
            ws[titleCell].s = {
              font: { bold: true, sz: 14 },
              alignment: { horizontal: "center" },
            };

            // Merge cells untuk judul tabel
            ws["!merges"].push({
              s: { r: startRow, c: 0 },
              e: { r: startRow, c: 9 },
            });

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 15 }, // NIS
              { wch: 25 }, // Nama Lengkap
              { wch: 15 }, // Tempat Lahir
              { wch: 15 }, // Tanggal Lahir
              { wch: 10 }, // Kelas
              { wch: 20 }, // Alamat
              { wch: 20 }, // Nama Orang Tua
              { wch: 15 }, // HP Orang Tua
              { wch: 10 }, // Status
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Santri");

            // Export file
            XLSX.writeFile(wb, "data_santri.xlsx");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export Excel berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data guru
      function exportGuruExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("guru")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((guru, index) => ({
              No: index + 1,
              NIP: guru.nip,
              "Nama Lengkap": guru.nama_lengkap,
              "Mata Pelajaran": guru.mata_pelajaran || "",
              "No. HP": guru.no_hp || "",
              Email: guru.email || "",
              Alamat: guru.alamat || "",
              Status: guru.status === "aktif" ? "Aktif" : "Tidak Aktif",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Tambahkan header
            const startRow = addHeaderToExcel(ws);

            // Tambahkan judul tabel
            XLSX.utils.sheet_add_aoa(ws, [["Data Guru"]], {
              origin: `A${startRow}`,
            });

            // Atur style untuk judul tabel
            const titleCell = XLSX.utils.encode_cell({ r: startRow, c: 0 });
            ws[titleCell].s = {
              font: { bold: true, sz: 14 },
              alignment: { horizontal: "center" },
            };

            // Merge cells untuk judul tabel
            ws["!merges"].push({
              s: { r: startRow, c: 0 },
              e: { r: startRow, c: 7 },
            });

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 20 }, // NIP
              { wch: 25 }, // Nama Lengkap
              { wch: 20 }, // Mata Pelajaran
              { wch: 15 }, // No. HP
              { wch: 25 }, // Email
              { wch: 30 }, // Alamat
              { wch: 10 }, // Status
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Guru");

            // Export file
            XLSX.writeFile(wb, "data_guru.xlsx");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export Excel berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data absensi
      function exportAbsensiExcel(type) {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;
        const waktuText =
          waktu === "pagi" ? "Pagi" : waktu === "sore" ? "Sore" : "Malam";

        // Ambil data dari tabel
        const tableId =
          type === "guru" ? "absenGuruTableBody" : "absenSantriTableBody";
        const rows = document.querySelectorAll(`#${tableId} tr`);

        // Siapkan data untuk Excel
        const data = Array.from(rows).map((row, index) => {
          const cells = row.querySelectorAll("td");
          const statusSelect = cells[4].querySelector("select");
          const statusText = statusSelect
            ? statusSelect.options[statusSelect.selectedIndex].text
            : "-";
          const keterangan = cells[5].querySelector("input").value;

          return {
            No: index + 1,
            [type === "guru" ? "Nama Guru" : "Nama Santri"]:
              cells[1].textContent,
            [type === "guru" ? "NIP" : "NIS"]: cells[2].textContent,
            Status: statusText,
            Keterangan: keterangan,
          };
        });

        // Buat workbook
        const wb = XLSX.utils.book_new();

        // Buat worksheet
        const ws = XLSX.utils.json_to_sheet(data);

        // Tambahkan header
        const startRow = addHeaderToExcel(ws);

        // Tambahkan judul tabel
        XLSX.utils.sheet_add_aoa(
          ws,
          [[`Data Absensi ${type === "guru" ? "Guru" : "Santri"} Halaqoh`]],
          { origin: `A${startRow}` }
        );

        // Tambahkan informasi tanggal dan waktu
        XLSX.utils.sheet_add_aoa(
          ws,
          [[`Tanggal: ${formatDate(tanggal)}`], [`Sesi: ${waktuText}`]],
          { origin: `A${startRow + 1}` }
        );

        // Atur style untuk judul tabel
        const titleCell = XLSX.utils.encode_cell({ r: startRow, c: 0 });
        ws[titleCell].s = {
          font: { bold: true, sz: 14 },
          alignment: { horizontal: "center" },
        };

        // Merge cells untuk judul tabel
        ws["!merges"].push({
          s: { r: startRow, c: 0 },
          e: { r: startRow, c: 4 },
        });

        // Atur lebar kolom
        const colWidths = [
          { wch: 5 }, // No
          { wch: 25 }, // Nama
          { wch: 20 }, // NIP/NIS
          { wch: 10 }, // Status
          { wch: 30 }, // Keterangan
        ];
        ws["!cols"] = colWidths;

        // Tambahkan worksheet ke workbook
        XLSX.utils.book_append_sheet(
          wb,
          ws,
          `Absensi ${type === "guru" ? "Guru" : "Santri"}`
        );

        // Export file
        XLSX.writeFile(wb, `absensi_${type}_${tanggal}.xlsx`);
        Swal.fire({
          icon: "success",
          title: "Berhasil!",
          text: "Export Excel berhasil!",
          timer: 1500,
          showConfirmButton: false,
        });
      }

      // Fungsi export Excel untuk data absensi santri
      function exportAbsensiSantriExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("absensi")
          .select(
            `
      *,
      santri (
          id,
          nama_lengkap,
          nis,
          kelas (
              id,
              nama
          )
      )
  `
          )
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((absensi, index) => ({
              No: index + 1,
              "Nama Santri": absensi.santri.nama_lengkap,
              NIS: absensi.santri.nis,
              Kelas: absensi.santri.kelas ? absensi.santri.kelas.nama : "",
              Tanggal: formatDate(absensi.tanggal),
              Status: getAbsensiStatusText(absensi.status),
              Keterangan: absensi.keterangan || "",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Tambahkan header
            const startRow = addHeaderToExcel(ws);

            // Tambahkan judul tabel
            XLSX.utils.sheet_add_aoa(ws, [["Data Absensi Santri"]], {
              origin: `A${startRow}`,
            });

            // Atur style untuk judul tabel
            const titleCell = XLSX.utils.encode_cell({ r: startRow, c: 0 });
            ws[titleCell].s = {
              font: { bold: true, sz: 14 },
              alignment: { horizontal: "center" },
            };

            // Merge cells untuk judul tabel
            ws["!merges"].push({
              s: { r: startRow, c: 0 },
              e: { r: startRow, c: 6 },
            });

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 25 }, // Nama Santri
              { wch: 15 }, // NIS
              { wch: 10 }, // Kelas
              { wch: 15 }, // Tanggal
              { wch: 10 }, // Status
              { wch: 30 }, // Keterangan
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Absensi Santri");

            // Export file
            XLSX.writeFile(wb, "data_absensi_santri.xlsx");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export Excel berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data kegiatan
      function exportKegiatanExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("kegiatan")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((kegiatan, index) => ({
              No: index + 1,
              "Nama Kegiatan": kegiatan.nama,
              Tanggal: formatDate(kegiatan.tanggal),
              Waktu: kegiatan.waktu || "",
              Lokasi: kegiatan.lokasi || "",
              "Penanggung Jawab": kegiatan.penanggung_jawab || "",
              Status: getStatusText(kegiatan.status),
              Deskripsi: kegiatan.deskripsi || "",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Tambahkan header
            const startRow = addHeaderToExcel(ws);

            // Tambahkan judul tabel
            XLSX.utils.sheet_add_aoa(ws, [["Data Kegiatan"]], {
              origin: `A${startRow}`,
            });

            // Atur style untuk judul tabel
            const titleCell = XLSX.utils.encode_cell({ r: startRow, c: 0 });
            ws[titleCell].s = {
              font: { bold: true, sz: 14 },
              alignment: { horizontal: "center" },
            };

            // Merge cells untuk judul tabel
            ws["!merges"].push({
              s: { r: startRow, c: 0 },
              e: { r: startRow, c: 8 },
            });

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 25 }, // Nama Kegiatan
              { wch: 15 }, // Tanggal
              { wch: 10 }, // Waktu
              { wch: 20 }, // Lokasi
              { wch: 20 }, // Penanggung Jawab
              { wch: 10 }, // Status
              { wch: 30 }, // Deskripsi
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Kegiatan");

            // Export file
            XLSX.writeFile(wb, "data_kegiatan.xlsx");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export Excel berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data fasilitas
      function exportFasilitasExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("fasilitas")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((fasilitas, index) => ({
              No: index + 1,
              "Nama Fasilitas": fasilitas.nama,
              Kapasitas: fasilitas.kapasitas || "",
              Kondisi: fasilitas.kondisi || "",
              "Penanggung Jawab": fasilitas.penanggung_jawab || "",
              "Pemeriksaan Terakhir": fasilitas.pemeriksaan_terakhir
                ? formatDate(fasilitas.pemeriksaan_terakhir)
                : "",
              Status: getStatusText(fasilitas.status),
              Deskripsi: fasilitas.deskripsi || "",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Tambahkan header
            const startRow = addHeaderToExcel(ws);

            // Tambahkan judul tabel
            XLSX.utils.sheet_add_aoa(ws, [["Data Fasilitas"]], {
              origin: `A${startRow}`,
            });

            // Atur style untuk judul tabel
            const titleCell = XLSX.utils.encode_cell({ r: startRow, c: 0 });
            ws[titleCell].s = {
              font: { bold: true, sz: 14 },
              alignment: { horizontal: "center" },
            };

            // Merge cells untuk judul tabel
            ws["!merges"].push({
              s: { r: startRow, c: 0 },
              e: { r: startRow, c: 8 },
            });

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 20 }, // Nama Fasilitas
              { wch: 10 }, // Kapasitas
              { wch: 10 }, // Kondisi
              { wch: 20 }, // Penanggung Jawab
              { wch: 20 }, // Pemeriksaan Terakhir
              { wch: 10 }, // Status
              { wch: 30 }, // Deskripsi
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Fasilitas");

            // Export file
            XLSX.writeFile(wb, "data_fasilitas.xlsx");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export Excel berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data kasus
      function exportKasusExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("kasus")
          .select(
            `
      *,
      santri (
          id,
          nama_lengkap,
          nis
      )
  `
          )
          .then(({ data, error }) => {
            if (error) {
              Swal.fire({
                icon: "error",
                title: "Kesalahan",
                text: "Error loading data for export: " + error.message,
              });
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((kasus, index) => ({
              No: index + 1,
              "Judul Kasus": kasus.judul,
              "Nama Santri": kasus.santri.nama_lengkap,
              NIS: kasus.santri.nis,
              "Tanggal Kejadian": formatDate(kasus.tanggal),
              "Jenis Pelanggaran": getKasusJenisText(kasus.jenis),
              Prioritas: getKasusPrioritasText(kasus.prioritas),
              Status: getKasusStatusText(kasus.status),
              "Deskripsi Kasus": kasus.deskripsi || "",
              "Tindakan yang Diambil": kasus.tindakan || "",
              "Penanggung Jawab": kasus.penanggung_jawab || "",
              "Tindak Lanjut": kasus.tindak_lanjut || "",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Tambahkan header
            const startRow = addHeaderToExcel(ws);

            // Tambahkan judul tabel
            XLSX.utils.sheet_add_aoa(ws, [["Data Kasus"]], {
              origin: `A${startRow}`,
            });

            // Atur style untuk judul tabel
            const titleCell = XLSX.utils.encode_cell({ r: startRow, c: 0 });
            ws[titleCell].s = {
              font: { bold: true, sz: 14 },
              alignment: { horizontal: "center" },
            };

            // Merge cells untuk judul tabel
            ws["!merges"].push({
              s: { r: startRow, c: 0 },
              e: { r: startRow, c: 11 },
            });

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 25 }, // Judul Kasus
              { wch: 25 }, // Nama Santri
              { wch: 15 }, // NIS
              { wch: 15 }, // Tanggal Kejadian
              { wch: 20 }, // Jenis Pelanggaran
              { wch: 10 }, // Prioritas
              { wch: 10 }, // Status
              { wch: 30 }, // Deskripsi Kasus
              { wch: 30 }, // Tindakan yang Diambil
              { wch: 20 }, // Penanggung Jawab
              { wch: 30 }, // Tindak Lanjut
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Kasus");

            // Export file
            XLSX.writeFile(wb, "data_kasus.xlsx");
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Export Excel berhasil!",
              timer: 1500,
              showConfirmButton: false,
            });
            hideLoading();
          });
      }

      // Fungsi helper
      function formatDate(dateString) {
        const options = { year: "numeric", month: "long", day: "numeric" };
        return new Date(dateString).toLocaleDateString("id-ID", options);
      }

      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }

      function getStatusClass(status) {
        switch (status) {
          case "aktif":
          case "selesai":
          case "tersedia":
          case "hadir":
            return "active";
          case "dalam_proses":
          case "izin":
            return "pending";
          case "tidak_aktif":
          case "dibatalkan":
          case "tidak_tersedia":
          case "tidak_hadir":
            return "inactive";
          default:
            return "active";
        }
      }

      function getStatusText(status) {
        switch (status) {
          case "aktif":
            return "Aktif";
          case "tidak_aktif":
            return "Tidak Aktif";
          case "dalam_proses":
            return "Dalam Proses";
          case "selesai":
            return "Selesai";
          case "dibatalkan":
            return "Dibatalkan";
          case "tersedia":
            return "Tersedia";
          case "tidak_tersedia":
            return "Tidak Tersedia";
          case "hadir":
            return "Hadir";
          case "tidak_hadir":
            return "Tidak Hadir";
          case "izin":
            return "Izin";
          default:
            return status;
        }
      }

      function getAbsensiStatusClass(status) {
        switch (status) {
          case "hadir":
            return "active";
          case "sakit":
            return "pending";
          case "pulang":
            return "pending";
          case "mangkir":
            return "inactive";
          default:
            return "active";
        }
      }

      function getAbsensiStatusText(status) {
        switch (status) {
          case "hadir":
            return "Hadir";
          case "sakit":
            return "Sakit";
          case "pulang":
            return "Pulang";
          case "mangkir":
            return "Mangkir";
          default:
            return status;
        }
      }

      function getKasusStatusClass(status) {
        switch (status) {
          case "terbuka":
            return "high";
          case "dalam-proses":
            return "medium";
          case "menunggu-konfirmasi":
            return "medium";
          case "selesai":
            return "low";
          default:
            return "medium";
        }
      }

      function getKasusStatusText(status) {
        switch (status) {
          case "terbuka":
            return "Terbuka";
          case "dalam-proses":
            return "Dalam Proses";
          case "menunggu-konfirmasi":
            return "Menunggu Konfirmasi";
          case "selesai":
            return "Selesai";
          default:
            return status;
        }
      }

      function getKasusPrioritasClass(prioritas) {
        switch (prioritas) {
          case "tinggi":
            return "high";
          case "sedang":
            return "medium";
          case "rendah":
            return "low";
          default:
            return "medium";
        }
      }

      function getKasusPrioritasText(prioritas) {
        switch (prioritas) {
          case "tinggi":
            return "Tinggi";
          case "sedang":
            return "Sedang";
          case "rendah":
            return "Rendah";
          default:
            return prioritas;
        }
      }

      function getKasusJenisText(jenis) {
        switch (jenis) {
          case "akademik":
            return "Akademik";
          case "disiplin":
            return "Disiplin";
          case "sosial":
            return "Sosial";
          case "kebersihan":
            return "Kebersihan";
          case "ibadah":
            return "Ibadah";
          case "lainnya":
            return "Lainnya";
          default:
            return jenis || "-";
        }
      }

      function getCharacterScoreClass(score) {
        if (score >= 80) return "excellent";
        if (score >= 60) return "good";
        if (score >= 40) return "fair";
        return "poor";
      }

      function getCharacterScoreText(score) {
        if (score >= 80) return "Sangat Baik";
        if (score >= 60) return "Baik";
        if (score >= 40) return "Cukup";
        return "Kurang";
      }

      // Fungsi helper untuk pagination
      function getPaginationRange(page, pageSize) {
        const from = (page - 1) * pageSize;
        const to = from + pageSize - 1;
        return { from, to };
      }

      function updatePagination(tableName) {
        const state = paginationState[tableName];
        const totalPages = Math.ceil(state.count / state.pageSize);
        const infoEl = document.getElementById(`${tableName}PaginationInfo`);
        const buttonsEl = document.getElementById(
          `${tableName}PaginationButtons`
        );

        // Update info text
        const startItem = (state.page - 1) * state.pageSize + 1;
        const endItem = Math.min(state.page * state.pageSize, state.count);
        infoEl.textContent = `Menampilkan ${startItem}-${endItem} dari ${state.count} data`;

        // Clear existing buttons
        buttonsEl.innerHTML = "";

        // Previous button
        const prevBtn = document.createElement("button");
        prevBtn.className = "pagination-btn";
        prevBtn.textContent = "Previous";
        prevBtn.disabled = state.page === 1;
        prevBtn.onclick = () => {
          if (state.page > 1) {
            loadTableData(tableName, state.page - 1);
          }
        };
        buttonsEl.appendChild(prevBtn);

        // Page number buttons
        const maxButtons = 5;
        let startPage = Math.max(1, state.page - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage + 1 < maxButtons) {
          startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement("button");
          pageBtn.className = `pagination-btn ${
            i === state.page ? "active" : ""
          }`;
          pageBtn.textContent = i;
          pageBtn.onclick = () => loadTableData(tableName, i);
          buttonsEl.appendChild(pageBtn);
        }

        // Next button
        const nextBtn = document.createElement("button");
        nextBtn.className = "pagination-btn";
        nextBtn.textContent = "Next";
        nextBtn.disabled = state.page === totalPages;
        nextBtn.onclick = () => {
          if (state.page < totalPages) {
            loadTableData(tableName, state.page + 1);
          }
        };
        buttonsEl.appendChild(nextBtn);
      }

      function loadTableData(tableName, page) {
        switch (tableName) {
          case "santri":
            loadSantri(page);
            break;
          case "guru":
            loadGuru(page);
            break;
          case "kegiatan":
            loadKegiatan(page);
            break;
          case "fasilitas":
            loadFasilitas(page);
            break;
          case "absensi":
            loadAbsensi(page);
            break;
          case "kasus":
            loadKasus(page);
            break;
        }
      }

      // Fungsi UI
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        sidebar.classList.toggle("collapsed");
        mainContent.classList.toggle("expanded");
      }

      // Fungsi untuk toggle sidebar di mobile
      function toggleMobileSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("active");
      }

      // Fungsi showSection dengan lazy loading
      async function showSection(sectionId) {
        // Hide all sections
        const sections = document.querySelectorAll(".content-section");
        sections.forEach((section) => {
          section.style.display = "none";
        });

        // Show selected section
        document.getElementById(sectionId).style.display = "block";

        // Update active nav link
        const navLinks = document.querySelectorAll(".nav-link");
        navLinks.forEach((link) => {
          link.classList.remove("active");
        });
        event.target.closest(".nav-link").classList.add("active");

        // Tutup sidebar di mobile setelah navigasi
        if (window.innerWidth <= 992) {
          const sidebar = document.getElementById("sidebar");
          sidebar.classList.remove("active");
        }

        // Lazy load data based on section
        showLoading();
        try {
          switch (sectionId) {
            case "dashboard":
              await loadDashboardData();
              break;
            case "santri":
              await loadSantri();
              await loadKelas(); // Load kelas for dropdown
              break;
            case "pengajar":
              await loadGuru();
              break;
            case "absen":
              // Load data for absen section
              await loadKelas(); // For kelas filter
              // Load absen data when filter is applied
              break;
            case "absensi":
              await loadAbsensi();
              await loadKelas(); // For kelas filter
              break;
            case "kasus":
              await loadKasus();
              await loadSantriOptions(); // For santri dropdown
              break;
            case "karakter":
              await loadSantriOptions(); // For santri dropdown
              break;
            case "kegiatan":
              await loadKegiatan();
              break;
            case "fasilitas":
              await loadFasilitas();
              break;
          }
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Kesalahan",
            text: "Terjadi kesalahan saat memuat data",
          });
        } finally {
          hideLoading();
        }
      }

      function switchTab(tabName) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll(".tab-content");
        tabContents.forEach((content) => {
          content.classList.remove("active");
        });

        // Remove active class from all tab buttons
        const tabButtons = document.querySelectorAll(".tab-btn");
        tabButtons.forEach((button) => {
          button.classList.remove("active");
        });

        // Show selected tab content
        document.getElementById(tabName + "Tab").classList.add("active");

        // Add active class to clicked tab button
        event.target.classList.add("active");
      }

      function openModal(modalId) {
        // Reset modal title if needed
        if (modalId === "santriModal") {
          document.getElementById("santriModalTitle").textContent =
            "Tambah Santri Baru";
        } else if (modalId === "pengajarModal") {
          document.getElementById("pengajarModalTitle").textContent =
            "Tambah Pengajar Baru";
        } else if (modalId === "kegiatanModal") {
          document.getElementById("kegiatanModalTitle").textContent =
            "Tambah Kegiatan Baru";
        } else if (modalId === "fasilitasModal") {
          document.getElementById("fasilitasModalTitle").textContent =
            "Tambah Fasilitas Baru";
        } else if (modalId === "absensiModal") {
          document.getElementById("absensiModalTitle").textContent =
            "Tambah Data Absensi";
        } else if (modalId === "kasusModal") {
          document.getElementById("kasusModalTitle").textContent =
            "Tambah Kasus Baru";
        } else if (modalId === "karakterModal") {
          document.getElementById("karakterModalTitle").textContent =
            "Tambah Penilaian Karakter";
        }

        document.getElementById(modalId).classList.add("active");
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
      }

      // Fungsi untuk load opsi santri
      async function loadSantriOptions() {
        try {
          const { data, error } = await supabase
            .from("santri")
            .select("id, nama_lengkap, nis");

          if (error) {
            console.error("Error loading santri options:", error);
            return;
          }

          // Update all santri select elements
          const selects = document.querySelectorAll('select[id*="Santri"]');
          selects.forEach((select) => {
            // Clear existing options except the first one
            while (select.children.length > 1) {
              select.removeChild(select.lastChild);
            }

            // Add new options
            data.forEach((santri) => {
              const option = document.createElement("option");
              option.value = santri.id;
              option.textContent = `${santri.nama_lengkap} (${santri.nis})`;
              select.appendChild(option);
            });
          });
        } catch (err) {
          console.error("Error loading santri options:", err);
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", async function () {
        // Set current date for date inputs
        const today = new Date().toISOString().split("T")[0];
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach((input) => {
          input.value = today;
        });

        // Set up range input listeners for character assessment
        const rangeInputs = [
          { range: "sikapRange", score: "sikapScore" },
          { range: "komunikasiRange", score: "komunikasiScore" },
          { range: "etosKerjaRange", score: "etosKerjaScore" },
          { range: "disiplinRange", score: "disiplinScore" },
        ];

        rangeInputs.forEach((input) => {
          const rangeElement = document.getElementById(input.range);
          const scoreElement = document.getElementById(input.score);

          if (rangeElement && scoreElement) {
            rangeElement.addEventListener("input", function () {
              scoreElement.textContent = this.value;

              // Update color based on score
              if (this.value >= 80) {
                scoreElement.style.backgroundColor = "var(--success-color)";
              } else if (this.value >= 60) {
                scoreElement.style.backgroundColor = "var(--secondary-color)";
              } else if (this.value >= 40) {
                scoreElement.style.backgroundColor = "var(--warning-color)";
              } else {
                scoreElement.style.backgroundColor = "var(--danger-color)";
              }
            });
          }
        });

        // Check if user is logged in
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (session) {
          currentUser = session.user;
          await loadUserProfile();
          // Hanya load dashboard data saat awal
          await loadDashboardData();
        } else {
          // Show login modal
          document.getElementById("loginModal").classList.add("active");
        }

        // Pantau perubahan status autentikasi
        supabase.auth.onAuthStateChange(async (event, session) => {
          console.log("Auth state changed:", event, session);

          if (event === "SIGNED_IN" && session) {
            currentUser = session.user;
            closeModal("loginModal");
            await loadUserProfile();
            // Hanya load dashboard data saat login
            await loadDashboardData();
          } else if (event === "SIGNED_OUT") {
            currentUser = null;
            // Hanya tampilkan modal jika tidak sedang dalam proses logout manual
            const loginModal = document.getElementById("loginModal");
            if (!loginModal.classList.contains("active")) {
              loginModal.classList.add("active");
            }
          }
        });
      });
    </script>
  </body>
</html>
