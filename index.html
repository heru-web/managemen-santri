<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Manajemen Pesantren Al-Hikmah</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --primary-color: #2c5f2d;
        --secondary-color: #97bc62;
        --accent-color: #4a7c59;
        --light-bg: #f8f9fa;
        --dark-text: #333;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--light-bg);
        color: var(--dark-text);
      }

      /* Sidebar Styles */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 250px;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--accent-color)
        );
        padding: 20px;
        overflow-y: auto;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .sidebar.collapsed {
        width: 70px;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .logo {
        display: flex;
        align-items: center;
        color: white;
        text-decoration: none;
      }

      .logo i {
        font-size: 28px;
        margin-right: 10px;
      }

      .logo-text {
        font-size: 20px;
        font-weight: bold;
        transition: opacity 0.3s;
      }

      .sidebar.collapsed .logo-text {
        opacity: 0;
        display: none;
      }

      .toggle-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
      }

      .nav-menu {
        list-style: none;
      }

      .nav-item {
        margin-bottom: 5px;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .nav-link:hover,
      .nav-link.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      .nav-link i {
        font-size: 20px;
        margin-right: 15px;
        width: 20px;
      }

      .sidebar.collapsed .nav-link span {
        display: none;
      }

      /* Main Content */
      .main-content {
        margin-left: 250px;
        padding: 20px;
        transition: margin-left 0.3s ease;
      }

      .main-content.expanded {
        margin-left: 70px;
      }

      /* Header */
      .header {
        background: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .search-bar {
        position: relative;
        width: 300px;
      }

      .search-bar input {
        width: 100%;
        padding: 10px 40px 10px 15px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        transition: border-color 0.3s;
      }

      .search-bar input:focus {
        border-color: var(--secondary-color);
      }

      .search-bar i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .notification-icon {
        position: relative;
        cursor: pointer;
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff4757;
        color: white;
        font-size: 10px;
        padding: 2px 5px;
        border-radius: 10px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      /* Dashboard Cards */
      .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .card-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      .card-icon.blue {
        background: rgba(52, 152, 219, 0.1);
        color: #3498db;
      }

      .card-icon.green {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
      }

      .card-icon.orange {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
      }

      .card-icon.red {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      .card-title {
        color: #999;
        font-size: 14px;
        margin-bottom: 5px;
      }

      .card-value {
        font-size: 28px;
        font-weight: bold;
        color: var(--dark-text);
      }

      /* Tables */
      .table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .table-title {
        font-size: 20px;
        font-weight: bold;
      }

      .btn-primary-custom {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-primary-custom:hover {
        background: var(--accent-color);
      }

      .custom-table {
        width: 100%;
        border-collapse: collapse;
      }

      .custom-table th {
        background: var(--light-bg);
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #666;
        border-bottom: 2px solid #eee;
      }

      .custom-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
      }

      .custom-table tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-badge.active {
        background: rgba(46, 204, 113, 0.1);
        color: #2ecc71;
      }

      .status-badge.pending {
        background: rgba(243, 156, 18, 0.1);
        color: #f39c12;
      }

      .status-badge.inactive {
        background: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 20px;
        font-weight: bold;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .modal-body {
        padding: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        outline: none;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--secondary-color);
      }

      .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      /* Tab Navigation */
      .tab-navigation {
        display: flex;
        border-bottom: 1px solid #eee;
        margin-bottom: 20px;
      }

      .tab-btn {
        background: none;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 500;
        color: #666;
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
      }

      .tab-btn.active {
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Checkbox for attendance */
      .attendance-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      /* Filter section */
      .filter-section {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
      }

      .filter-group {
        flex: 1;
        min-width: 200px;
      }

      .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .filter-group select,
      .filter-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        outline: none;
      }

      .btn-filter {
        background: var(--secondary-color);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn-filter:hover {
        background: var(--accent-color);
      }

      /* Attendance summary */
      .attendance-summary {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .summary-card {
        flex: 1;
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
      }

      .summary-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .summary-label {
        color: #666;
        font-size: 14px;
      }

      .summary-card.present .summary-value {
        color: #2ecc71;
      }

      .summary-card.absent .summary-value {
        color: #e74c3c;
      }

      .summary-card.permission .summary-value {
        color: #f39c12;
      }

      /* Toast Notification */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
      }

      .toast {
        background: white;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        min-width: 300px;
        animation: slideInRight 0.3s ease;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .toast.success {
        border-left: 4px solid #2ecc71;
      }

      .toast.error {
        border-left: 4px solid #e74c3c;
      }

      .toast.warning {
        border-left: 4px solid #f39c12;
      }

      .toast-icon {
        margin-right: 10px;
        font-size: 20px;
      }

      .toast.success .toast-icon {
        color: #2ecc71;
      }

      .toast.error .toast-icon {
        color: #e74c3c;
      }

      .toast.warning .toast-icon {
        color: #f39c12;
      }

      .toast-message {
        flex: 1;
      }

      .toast-close {
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
        color: #999;
      }

      /* Loading indicator */
      .loading-indicator {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 4000;
        justify-content: center;
        align-items: center;
      }

      .loading-indicator.active {
        display: flex;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Pagination */
      .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
      }

      .pagination-info {
        color: #666;
      }

      .pagination-buttons {
        display: flex;
        gap: 5px;
      }

      .pagination-btn {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 5px;
      }

      .pagination-btn:hover:not(:disabled) {
        background: var(--light-bg);
      }

      .pagination-btn:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }

      .pagination-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .dashboard-cards {
          grid-template-columns: 1fr;
        }

        .search-bar {
          width: 100%;
        }

        .header {
          flex-direction: column;
          gap: 15px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loadingIndicator">
      <div class="spinner"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="#" class="logo">
          <i class="bi bi-mosque"></i>
          <span class="logo-text">Pesantren</span>
        </a>
        <button class="toggle-btn" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
      </div>
      <nav>
        <ul class="nav-menu">
          <li class="nav-item">
            <a
              href="#"
              class="nav-link active"
              onclick="showSection('dashboard')"
            >
              <i class="bi bi-speedometer2"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('santri')">
              <i class="bi bi-people"></i>
              <span>Data Santri</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('pengajar')">
              <i class="bi bi-person-workspace"></i>
              <span>Pengajar</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('absen')">
              <i class="bi bi-calendar-check"></i>
              <span>Absen Halaqoh</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('kegiatan')">
              <i class="bi bi-calendar-event"></i>
              <span>Kegiatan</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('fasilitas')">
              <i class="bi bi-building"></i>
              <span>Fasilitas</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('keuangan')">
              <i class="bi bi-cash-stack"></i>
              <span>Keuangan</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('laporan')">
              <i class="bi bi-file-earmark-text"></i>
              <span>Laporan</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" onclick="showSection('pengaturan')">
              <i class="bi bi-gear"></i>
              <span>Pengaturan</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
      <!-- Header -->
      <header class="header">
        <div class="search-bar">
          <input type="text" placeholder="Cari data..." />
          <i class="bi bi-search"></i>
        </div>
        <div class="user-info">
          <div class="notification-icon">
            <i class="bi bi-bell"></i>
            <span class="notification-badge">3</span>
          </div>
          <img
            src="https://picsum.photos/seed/user1/40/40"
            alt="User"
            class="user-avatar"
          />
          <div>
            <div style="font-weight: 500">Admin</div>
            <div style="font-size: 12px; color: #999">Administrator</div>
          </div>
          <button class="btn btn-sm btn-outline-secondary" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </header>

      <!-- Dashboard Section -->
      <section id="dashboard" class="content-section">
        <h2 style="margin-bottom: 25px">Dashboard</h2>

        <!-- Dashboard Cards -->
        <div class="dashboard-cards">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Total Santri</div>
                <div class="card-value" id="totalSantriCount">0</div>
              </div>
              <div class="card-icon blue">
                <i class="bi bi-people"></i>
              </div>
            </div>
            <div style="color: #2ecc71; font-size: 14px">
              <i class="bi bi-arrow-up"></i> 12% dari bulan lalu
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Total Pengajar</div>
                <div class="card-value" id="totalGuruCount">0</div>
              </div>
              <div class="card-icon green">
                <i class="bi bi-person-workspace"></i>
              </div>
            </div>
            <div style="color: #2ecc71; font-size: 14px">
              <i class="bi bi-arrow-up"></i> 5% dari bulan lalu
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Kegiatan Bulan Ini</div>
                <div class="card-value" id="totalKegiatanCount">0</div>
              </div>
              <div class="card-icon orange">
                <i class="bi bi-calendar-event"></i>
              </div>
            </div>
            <div style="color: #f39c12; font-size: 14px">
              <i class="bi bi-dash"></i> Sama dengan bulan lalu
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Pemasukan Bulan Ini</div>
                <div class="card-value" id="totalPemasukanCount">Rp 0</div>
              </div>
              <div class="card-icon red">
                <i class="bi bi-cash-stack"></i>
              </div>
            </div>
            <div style="color: #2ecc71; font-size: 14px">
              <i class="bi bi-arrow-up"></i> 20% dari bulan lalu
            </div>
          </div>
        </div>
      </section>

      <!-- Santri Section -->
      <section id="santri" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px">Data Santri</h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Daftar Santri</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportSantriPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportSantriExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('santriModal')"
              >
                <i class="bi bi-plus"></i> Tambah Santri
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>NIS</th>
                <th>Nama Lengkap</th>
                <th>Kelas</th>
                <th>Alamat</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="santriTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Santri -->
          <div class="pagination-container">
            <div class="pagination-info" id="santriPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="santriPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Pengajar Section -->
      <section id="pengajar" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px">Data Pengajar</h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Daftar Pengajar</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportGuruPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportGuruExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('pengajarModal')"
              >
                <i class="bi bi-plus"></i> Tambah Pengajar
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>NIP</th>
                <th>Nama</th>
                <th>Mata Pelajaran</th>
                <th>No. HP</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="guruTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Guru -->
          <div class="pagination-container">
            <div class="pagination-info" id="guruPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="guruPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Absen Halaqoh Section -->
      <section id="absen" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px">Absen Halaqoh</h2>

        <!-- Filter Section -->
        <div class="filter-section">
          <div class="filter-row">
            <div class="filter-group">
              <label>Tanggal</label>
              <input type="date" id="absenTanggal" value="" />
            </div>
            <div class="filter-group">
              <label>Waktu</label>
              <select id="absenWaktu">
                <option value="pagi">Pagi (07:00-09:00)</option>
                <option value="sore">Sore (16:00-18:00)</option>
                <option value="malam">Malam (20:00-22:00)</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Kelas</label>
              <select id="absenKelas">
                <option value="">Semua Kelas</option>
              </select>
            </div>
            <button class="btn-filter" onclick="filterAbsen()">
              <i class="bi bi-funnel"></i> Filter
            </button>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
          <button class="tab-btn active" onclick="switchTab('guru')">
            Absen Guru
          </button>
          <button class="tab-btn" onclick="switchTab('santri')">
            Absen Santri
          </button>
        </div>

        <!-- Tab Content -->
        <div id="guruTab" class="tab-content active">
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Absen Guru Halaqoh</h3>
              <div>
                <button
                  class="btn btn-sm btn-outline-success me-2"
                  onclick="exportAbsensiPDF('guru')"
                >
                  <i class="bi bi-file-earmark-pdf"></i> Export PDF
                </button>
                <button
                  class="btn btn-sm btn-outline-success me-2"
                  onclick="exportAbsensiExcel('guru')"
                >
                  <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>
                <button class="btn-primary-custom" onclick="saveAbsenGuru()">
                  <i class="bi bi-check"></i> Simpan Absen
                </button>
              </div>
            </div>

            <!-- Attendance Summary -->
            <div class="attendance-summary">
              <div class="summary-card present">
                <div class="summary-value" id="guruHadirCount">0</div>
                <div class="summary-label">Hadir</div>
              </div>
              <div class="summary-card absent">
                <div class="summary-value" id="guruTidakHadirCount">0</div>
                <div class="summary-label">Tidak Hadir</div>
              </div>
              <div class="summary-card permission">
                <div class="summary-value" id="guruIzinCount">0</div>
                <div class="summary-label">Izin</div>
              </div>
            </div>

            <table class="custom-table">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      class="attendance-checkbox"
                      id="selectAllGuru"
                      onchange="toggleAllGuru()"
                    />
                  </th>
                  <th>Nama</th>
                  <th>NIP</th>
                  <th>Mata Pelajaran</th>
                  <th>Status</th>
                  <th>Keterangan</th>
                </tr>
              </thead>
              <tbody id="absenGuruTableBody">
                <!-- Data akan dimuat dengan JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <div id="santriTab" class="tab-content">
          <div class="table-container">
            <div class="table-header">
              <h3 class="table-title">Absen Santri Halaqoh</h3>
              <div>
                <button
                  class="btn btn-sm btn-outline-success me-2"
                  onclick="exportAbsensiPDF('santri')"
                >
                  <i class="bi bi-file-earmark-pdf"></i> Export PDF
                </button>
                <button
                  class="btn btn-sm btn-outline-success me-2"
                  onclick="exportAbsensiExcel('santri')"
                >
                  <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>
                <button class="btn-primary-custom" onclick="saveAbsenSantri()">
                  <i class="bi bi-check"></i> Simpan Absen
                </button>
              </div>
            </div>

            <!-- Attendance Summary -->
            <div class="attendance-summary">
              <div class="summary-card present">
                <div class="summary-value" id="santriHadirCount">0</div>
                <div class="summary-label">Hadir</div>
              </div>
              <div class="summary-card absent">
                <div class="summary-value" id="santriTidakHadirCount">0</div>
                <div class="summary-label">Tidak Hadir</div>
              </div>
              <div class="summary-card permission">
                <div class="summary-value" id="santriIzinCount">0</div>
                <div class="summary-label">Izin</div>
              </div>
            </div>

            <table class="custom-table">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      class="attendance-checkbox"
                      id="selectAllSantri"
                      onchange="toggleAllSantri()"
                    />
                  </th>
                  <th>Nama</th>
                  <th>NIS</th>
                  <th>Kelas</th>
                  <th>Status</th>
                  <th>Keterangan</th>
                </tr>
              </thead>
              <tbody id="absenSantriTableBody">
                <!-- Data akan dimuat dengan JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Kegiatan Section -->
      <section id="kegiatan" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px">Manajemen Kegiatan</h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Jadwal Kegiatan</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportKegiatanPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportKegiatanExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('kegiatanModal')"
              >
                <i class="bi bi-plus"></i> Tambah Kegiatan
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Nama Kegiatan</th>
                <th>Penanggung Jawab</th>
                <th>Lokasi</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="kegiatanTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Kegiatan -->
          <div class="pagination-container">
            <div class="pagination-info" id="kegiatanPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="kegiatanPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Fasilitas Section -->
      <section id="fasilitas" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px">Manajemen Fasilitas</h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Daftar Fasilitas</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportFasilitasPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportFasilitasExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('fasilitasModal')"
              >
                <i class="bi bi-plus"></i> Tambah Fasilitas
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>Nama Fasilitas</th>
                <th>Kapasitas</th>
                <th>Kondisi</th>
                <th>Penanggung Jawab</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="fasilitasTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Fasilitas -->
          <div class="pagination-container">
            <div class="pagination-info" id="fasilitasPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="fasilitasPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Keuangan Section -->
      <section id="keuangan" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px">Manajemen Keuangan</h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Transaksi Terkini</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportTransaksiPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportTransaksiExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Export Excel
              </button>
              <button
                class="btn-primary-custom"
                onclick="openModal('transaksiModal')"
              >
                <i class="bi bi-plus"></i> Tambah Transaksi
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Keterangan</th>
                <th>Kategori</th>
                <th>Jenis</th>
                <th>Jumlah</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="transaksiTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Transaksi -->
          <div class="pagination-container">
            <div class="pagination-info" id="transaksiPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="transaksiPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Laporan Section -->
      <section id="laporan" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px">Laporan</h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Laporan Tersedia</h3>
            <div>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportLaporanKeuanganPDF()"
              >
                <i class="bi bi-file-earmark-pdf"></i> Laporan Keuangan PDF
              </button>
              <button
                class="btn btn-sm btn-outline-success me-2"
                onclick="exportLaporanKeuanganExcel()"
              >
                <i class="bi bi-file-earmark-excel"></i> Laporan Keuangan Excel
              </button>
              <button class="btn-primary-custom" onclick="generateReport()">
                <i class="bi bi-file-earmark-plus"></i> Buat Laporan Baru
              </button>
            </div>
          </div>
          <table class="custom-table">
            <thead>
              <tr>
                <th>Nama Laporan</th>
                <th>Tipe</th>
                <th>Periode</th>
                <th>Tanggal Buat</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="laporanTableBody">
              <!-- Data akan dimuat dengan JavaScript -->
            </tbody>
          </table>
          <!-- Pagination for Laporan -->
          <div class="pagination-container">
            <div class="pagination-info" id="laporanPaginationInfo">
              Menampilkan 0 dari 0 data
            </div>
            <div class="pagination-buttons" id="laporanPaginationButtons">
              <!-- Pagination buttons will be generated here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Pengaturan Section -->
      <section id="pengaturan" class="content-section" style="display: none">
        <h2 style="margin-bottom: 25px">Pengaturan</h2>

        <div class="table-container">
          <div class="table-header">
            <h3 class="table-title">Pengaturan Sistem</h3>
          </div>
          <div style="padding: 20px">
            <div class="form-group">
              <label>Nama Pesantren</label>
              <input
                type="text"
                id="pengaturanNamaPesantren"
                value="Pesantren Al-Hikmah"
              />
            </div>
            <div class="form-group">
              <label>Alamat</label>
              <input
                type="text"
                id="pengaturanAlamat"
                value="Jl. Pendidikan No. 123, Jakarta"
              />
            </div>
            <div class="form-group">
              <label>Email</label>
              <input
                type="email"
                id="pengaturanEmail"
                value="info@alhikmah.sch.id"
              />
            </div>
            <div class="form-group">
              <label>Telepon</label>
              <input type="tel" id="pengaturanTelepon" value="(021) 1234567" />
            </div>
            <button class="btn-primary-custom" onclick="saveSettings()">
              <i class="bi bi-check"></i> Simpan Pengaturan
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Login Sistem</h3>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="loginEmail"
              class="form-control"
              value="admin@pesantren.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="loginPassword"
              class="form-control"
              value="admin123"
            />
          </div>
          <div id="loginError" class="alert alert-danger d-none"></div>
        </div>
        <div class="modal-footer">
          <button class="btn-primary-custom" onclick="login()">Login</button>
        </div>
      </div>
    </div>

    <!-- Santri Modal -->
    <div class="modal" id="santriModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="santriModalTitle">Tambah Santri Baru</h3>
          <button class="close-btn" onclick="closeModal('santriModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="santriId" />
          <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="santriNama" />
          </div>
          <div class="form-group">
            <label>NIS</label>
            <input type="text" id="santriNIS" />
          </div>
          <div class="form-group">
            <label>Tempat Lahir</label>
            <input type="text" id="santriTempatLahir" />
          </div>
          <div class="form-group">
            <label>Tanggal Lahir</label>
            <input type="date" id="santriTanggalLahir" />
          </div>
          <div class="form-group">
            <label>Kelas</label>
            <select id="santriKelas">
              <option value="">Pilih Kelas</option>
            </select>
          </div>
          <div class="form-group">
            <label>Alamat</label>
            <input type="text" id="santriAlamat" />
          </div>
          <div class="form-group">
            <label>Nama Orang Tua/Wali</label>
            <input type="text" id="santriOrtu" />
          </div>
          <div class="form-group">
            <label>No. HP Orang Tua/Wali</label>
            <input type="tel" id="santriHPOrtu" />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="santriStatus">
              <option value="aktif">Aktif</option>
              <option value="tidak_aktif">Tidak Aktif</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal('santriModal')">
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveSantri()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Pengajar Modal -->
    <div class="modal" id="pengajarModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="pengajarModalTitle">
            Tambah Pengajar Baru
          </h3>
          <button class="close-btn" onclick="closeModal('pengajarModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="pengajarId" />
          <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="pengajarNama" />
          </div>
          <div class="form-group">
            <label>NIP</label>
            <input type="text" id="pengajarNIP" />
          </div>
          <div class="form-group">
            <label>Mata Pelajaran</label>
            <input type="text" id="pengajarMapel" />
          </div>
          <div class="form-group">
            <label>No. HP</label>
            <input type="tel" id="pengajarHP" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="pengajarEmail" />
          </div>
          <div class="form-group">
            <label>Alamat</label>
            <textarea id="pengajarAlamat" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="pengajarStatus">
              <option value="aktif">Aktif</option>
              <option value="tidak_aktif">Tidak Aktif</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('pengajarModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveGuru()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Kegiatan Modal -->
    <div class="modal" id="kegiatanModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="kegiatanModalTitle">
            Tambah Kegiatan Baru
          </h3>
          <button class="close-btn" onclick="closeModal('kegiatanModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="kegiatanId" />
          <div class="form-group">
            <label>Nama Kegiatan</label>
            <input type="text" id="kegiatanNama" />
          </div>
          <div class="form-group">
            <label>Tanggal</label>
            <input type="date" id="kegiatanTanggal" />
          </div>
          <div class="form-group">
            <label>Waktu</label>
            <input type="time" id="kegiatanWaktu" />
          </div>
          <div class="form-group">
            <label>Lokasi</label>
            <input type="text" id="kegiatanLokasi" />
          </div>
          <div class="form-group">
            <label>Penanggung Jawab</label>
            <input type="text" id="kegiatanPJ" />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="kegiatanStatus">
              <option value="dalam_proses">Dalam Proses</option>
              <option value="selesai">Selesai</option>
              <option value="dibatalkan">Dibatalkan</option>
            </select>
          </div>
          <div class="form-group">
            <label>Deskripsi</label>
            <textarea id="kegiatanDeskripsi" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('kegiatanModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveKegiatan()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Fasilitas Modal -->
    <div class="modal" id="fasilitasModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="fasilitasModalTitle">
            Tambah Fasilitas Baru
          </h3>
          <button class="close-btn" onclick="closeModal('fasilitasModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="fasilitasId" />
          <div class="form-group">
            <label>Nama Fasilitas</label>
            <input type="text" id="fasilitasNama" />
          </div>
          <div class="form-group">
            <label>Kapasitas</label>
            <input type="text" id="fasilitasKapasitas" />
          </div>
          <div class="form-group">
            <label>Kondisi</label>
            <select id="fasilitasKondisi">
              <option value="">Pilih Kondisi</option>
              <option value="baik">Baik</option>
              <option value="sedang">Sedang</option>
              <option value="rusak">Rusak</option>
            </select>
          </div>
          <div class="form-group">
            <label>Penanggung Jawab</label>
            <input type="text" id="fasilitasPJ" />
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="fasilitasStatus">
              <option value="tersedia">Tersedia</option>
              <option value="tidak_tersedia">Tidak Tersedia</option>
            </select>
          </div>
          <div class="form-group">
            <label>Deskripsi</label>
            <textarea id="fasilitasDeskripsi" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('fasilitasModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveFasilitas()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Transaksi Modal -->
    <div class="modal" id="transaksiModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="transaksiModalTitle">
            Tambah Transaksi Baru
          </h3>
          <button class="close-btn" onclick="closeModal('transaksiModal')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="transaksiId" />
          <div class="form-group">
            <label>Tanggal</label>
            <input type="date" id="transaksiTanggal" />
          </div>
          <div class="form-group">
            <label>Keterangan</label>
            <input type="text" id="transaksiKeterangan" />
          </div>
          <div class="form-group">
            <label>Kategori</label>
            <select id="transaksiKategori">
              <option value="">Pilih Kategori</option>
              <option value="pendidikan">Pendidikan</option>
              <option value="operasional">Operasional</option>
              <option value="donasi">Donasi</option>
              <option value="lainnya">Lainnya</option>
            </select>
          </div>
          <div class="form-group">
            <label>Jenis</label>
            <select id="transaksiJenis">
              <option value="">Pilih Jenis</option>
              <option value="pemasukan">Pemasukan</option>
              <option value="pengeluaran">Pengeluaran</option>
            </select>
          </div>
          <div class="form-group">
            <label>Jumlah</label>
            <input type="number" id="transaksiJumlah" />
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="closeModal('transaksiModal')"
          >
            Batal
          </button>
          <button class="btn-primary-custom" onclick="saveTransaksi()">
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Library untuk export PDF dan Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
      // Ganti dengan URL dan API Key dari Supabase Anda
      const supabaseUrl = "https://tttzvlgswqieglyeasoy.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0dHp2bGdzd3FpZWdseWVhc295Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDkxMzUsImV4cCI6MjA3NzA4NTEzNX0.-xGPp_F76nEbqAkQXjOnpJwW_z12JMvF3x75ljf81OE";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // State aplikasi
      let currentUser = null;
      // Hapus variabel array global yang tidak perlu, data akan dikelola per halaman
      let dataKelas = [];
      let dataPengaturan = {};

      // Pagination state
      const paginationState = {
        santri: { page: 1, pageSize: 10, count: 0 },
        guru: { page: 1, pageSize: 10, count: 0 },
        kegiatan: { page: 1, pageSize: 10, count: 0 },
        fasilitas: { page: 1, pageSize: 10, count: 0 },
        transaksi: { page: 1, pageSize: 10, count: 0 },
        laporan: { page: 1, pageSize: 10, count: 0 },
      };

      // Fungsi untuk menampilkan toast
      function showToast(message, type = "success") {
        const toastContainer = document.getElementById("toastContainer");

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        let icon = "";
        if (type === "success")
          icon = '<i class="bi bi-check-circle-fill toast-icon"></i>';
        else if (type === "error")
          icon = '<i class="bi bi-x-circle-fill toast-icon"></i>';
        else if (type === "warning")
          icon = '<i class="bi bi-exclamation-triangle-fill toast-icon"></i>';

        toast.innerHTML = `
                ${icon}
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="bi bi-x"></i>
                </button>
            `;

        toastContainer.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 5000);
      }

      // Fungsi untuk menampilkan/menyembunyikan loading indicator
      function showLoading() {
        document.getElementById("loadingIndicator").classList.add("active");
      }

      function hideLoading() {
        document.getElementById("loadingIndicator").classList.remove("active");
      }

      // Fungsi login
      async function login() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const errorDiv = document.getElementById("loginError");

        if (!email || !password) {
          errorDiv.textContent = "Email dan password harus diisi";
          errorDiv.classList.remove("d-none");
          return;
        }

        showLoading();

        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            errorDiv.textContent = error.message;
            errorDiv.classList.remove("d-none");
            hideLoading();
            return;
          }

          // Login berhasil
          currentUser = data.user;
          closeModal("loginModal");
          showToast("Login berhasil!", "success");

          // Load data user
          await loadUserProfile();

          // Load data dashboard saja saat awal
          await loadDashboardData();
        } catch (err) {
          errorDiv.textContent = "Terjadi kesalahan saat login";
          errorDiv.classList.remove("d-none");
        } finally {
          hideLoading();
        }
      }

      // Fungsi logout yang diperbaiki
      async function logout() {
        try {
          showLoading();
          await supabase.auth.signOut();
          // Tunggu sebentar agar onAuthStateChange selesai diproses
          setTimeout(() => {
            currentUser = null;
            showToast("Logout berhasil!", "success");
            // Pastikan modal login ditampilkan
            const loginModal = document.getElementById("loginModal");
            loginModal.classList.add("active");
            hideLoading();
          }, 500);
        } catch (error) {
          console.error("Error during logout:", error);
          showToast("Gagal logout", "error");
          hideLoading();
        }
      }

      // Fungsi load profile user
      async function loadUserProfile() {
        try {
          const { data, error } = await supabase
            .from("users")
            .select("*")
            .eq("id", currentUser.id)
            .single();

          if (error) {
            console.error("Error loading user profile:", error);
            return;
          }

          // Update UI dengan data user
          document.querySelector(".user-avatar").src =
            data.avatar_url || "https://picsum.photos/seed/user1/40/40";
          document.querySelector(".user-info div div").textContent =
            data.full_name;
          document.querySelector(".user-info div div:last-child").textContent =
            data.role;
        } catch (err) {
          console.error("Error loading user profile:", err);
        }
      }

      // OPTIMASI: Hanya memuat data yang diperlukan untuk dashboard
      async function loadDashboardData() {
        showLoading();
        try {
          const currentMonth = new Date().getMonth();
          const currentYear = new Date().getFullYear();

          // Gunakan count untuk menghemat bandwidth, kita hanya butuh jumlahnya
          const [
            { count: santriCount },
            { count: guruCount },
            { data: kegiatanData },
            { data: transaksiData },
          ] = await Promise.all([
            supabase.from("santri").select("id", { count: "exact", head: true }),
            supabase.from("guru").select("id", { count: "exact", head: true }),
            supabase
              .from("kegiatan")
              .select("id")
              .gte("tanggal", new Date(currentYear, currentMonth, 1))
              .lte("tanggal", new Date(currentYear, currentMonth + 1, 0)),
            supabase
              .from("transaksi")
              .select("jumlah")
              .eq("jenis", "pemasukan")
              .gte("tanggal", new Date(currentYear, currentMonth, 1))
              .lte("tanggal", new Date(currentYear, currentMonth + 1, 0)),
          ]);

          // Update dashboard
          document.getElementById("totalSantriCount").textContent = santriCount || 0;
          document.getElementById("totalGuruCount").textContent = guruCount || 0;
          document.getElementById("totalKegiatanCount").textContent =
            kegiatanData.length || 0;

          const totalPemasukan = transaksiData.reduce(
            (sum, t) => sum + parseFloat(t.jumlah),
            0
          );
          document.getElementById(
            "totalPemasukanCount"
          ).textContent = `Rp ${formatNumber(totalPemasukan)}`;
        } catch (err) {
          console.error("Error loading dashboard data:", err);
          showToast("Terjadi kesalahan saat memuat data dashboard", "error");
        } finally {
          hideLoading();
        }
      }

      // OPTIMASI: Fungsi load data santri dengan pagination
      async function loadSantri(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(page, paginationState.santri.pageSize);
          
          const { data, error, count } = await supabase
            .from("santri")
            .select(`
                        *,
                        kelas (
                            id,
                            nama
                        )
                    `, { count: 'exact' })
            .range(from, to)
            .order('nama_lengkap');

          if (error) {
            console.error("Error loading santri:", error);
            showToast("Error loading santri: " + error.message, "error");
            return;
          }

          paginationState.santri.count = count || 0;
          paginationState.santri.page = page;

          updateSantriTable(data);
          updatePagination('santri');
        } catch (err) {
          console.error("Error loading santri:", err);
          showToast("Terjadi kesalahan saat memuat data santri", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel santri
      function updateSantriTable(data) {
        const tbody = document.getElementById("santriTableBody");
        tbody.innerHTML = "";

        data.forEach((santri) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${santri.nis}</td>
                    <td>${santri.nama_lengkap}</td>
                    <td>${santri.kelas ? santri.kelas.nama : "-"}</td>
                    <td>${santri.alamat || "-"}</td>
                    <td><span class="status-badge ${
                      santri.status === "aktif" ? "active" : "inactive"
                    }">${
            santri.status === "aktif" ? "Aktif" : "Tidak Aktif"
          }</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editSantri('${
                          santri.id
                        }')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSantri('${
                          santri.id
                        }')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // OPTIMASI: Fungsi load data guru dengan pagination
      async function loadGuru(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(page, paginationState.guru.pageSize);

          const { data, error, count } = await supabase
            .from("guru")
            .select("*", { count: 'exact' })
            .range(from, to)
            .order('nama_lengkap');

          if (error) {
            console.error("Error loading guru:", error);
            showToast("Error loading guru: " + error.message, "error");
            return;
          }

          paginationState.guru.count = count || 0;
          paginationState.guru.page = page;

          updateGuruTable(data);
          updatePagination('guru');
        } catch (err) {
          console.error("Error loading guru:", err);
          showToast("Terjadi kesalahan saat memuat data guru", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel guru
      function updateGuruTable(data) {
        const tbody = document.getElementById("guruTableBody");
        tbody.innerHTML = "";

        data.forEach((guru) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${guru.nip}</td>
                    <td>${guru.nama_lengkap}</td>
                    <td>${guru.mata_pelajaran || "-"}</td>
                    <td>${guru.no_hp || "-"}</td>
                    <td><span class="status-badge ${
                      guru.status === "aktif" ? "active" : "inactive"
                    }">${
            guru.status === "aktif" ? "Aktif" : "Tidak Aktif"
          }</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editGuru('${
                          guru.id
                        }')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteGuru('${
                          guru.id
                        }')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // Fungsi load data kelas
      async function loadKelas() {
        try {
          const { data, error } = await supabase.from("kelas").select("*");

          if (error) {
            console.error("Error loading kelas:", error);
            showToast("Error loading kelas: " + error.message, "error");
            return;
          }

          dataKelas = data;
          updateKelasOptions();
        } catch (err) {
          console.error("Error loading kelas:", err);
          showToast("Terjadi kesalahan saat memuat data kelas", "error");
        }
      }

      // Fungsi update opsi kelas
      function updateKelasOptions() {
        const selects = document.querySelectorAll('select[id*="Kelas"]');

        selects.forEach((select) => {
          // Clear existing options except the first one
          while (select.children.length > 1) {
            select.removeChild(select.lastChild);
          }

          // Add new options
          dataKelas.forEach((kelas) => {
            const option = document.createElement("option");
            option.value = kelas.id;
            option.textContent = kelas.nama;
            select.appendChild(option);
          });
        });
      }

      // OPTIMASI: Fungsi load data kegiatan dengan pagination
      async function loadKegiatan(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(page, paginationState.kegiatan.pageSize);

          const { data, error, count } = await supabase
            .from("kegiatan")
            .select("*", { count: 'exact' })
            .range(from, to)
            .order('tanggal', { ascending: false });

          if (error) {
            console.error("Error loading kegiatan:", error);
            showToast("Error loading kegiatan: " + error.message, "error");
            return;
          }

          paginationState.kegiatan.count = count || 0;
          paginationState.kegiatan.page = page;

          updateKegiatanTable(data);
          updatePagination('kegiatan');
        } catch (err) {
          console.error("Error loading kegiatan:", err);
          showToast("Terjadi kesalahan saat memuat data kegiatan", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel kegiatan
      function updateKegiatanTable(data) {
        const tbody = document.getElementById("kegiatanTableBody");
        tbody.innerHTML = "";

        data.forEach((kegiatan) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${formatDate(kegiatan.tanggal)}</td>
                    <td>${kegiatan.nama}</td>
                    <td>${kegiatan.penanggung_jawab || "-"}</td>
                    <td>${kegiatan.lokasi || "-"}</td>
                    <td><span class="status-badge ${getStatusClass(
                      kegiatan.status
                    )}">${getStatusText(kegiatan.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editKegiatan('${
                          kegiatan.id
                        }')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteKegiatan('${
                          kegiatan.id
                        }')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // OPTIMASI: Fungsi load data fasilitas dengan pagination
      async function loadFasilitas(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(page, paginationState.fasilitas.pageSize);

          const { data, error, count } = await supabase
            .from("fasilitas")
            .select("*", { count: 'exact' })
            .range(from, to)
            .order('nama');

          if (error) {
            console.error("Error loading fasilitas:", error);
            showToast("Error loading fasilitas: " + error.message, "error");
            return;
          }

          paginationState.fasilitas.count = count || 0;
          paginationState.fasilitas.page = page;

          updateFasilitasTable(data);
          updatePagination('fasilitas');
        } catch (err) {
          console.error("Error loading fasilitas:", err);
          showToast("Terjadi kesalahan saat memuat data fasilitas", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel fasilitas
      function updateFasilitasTable(data) {
        const tbody = document.getElementById("fasilitasTableBody");
        tbody.innerHTML = "";

        data.forEach((fasilitas) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${fasilitas.nama}</td>
                    <td>${fasilitas.kapasitas || "-"}</td>
                    <td>${fasilitas.kondisi || "-"}</td>
                    <td>${fasilitas.penanggung_jawab || "-"}</td>
                    <td><span class="status-badge ${getStatusClass(
                      fasilitas.status
                    )}">${getStatusText(fasilitas.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editFasilitas('${
                          fasilitas.id
                        }')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFasilitas('${
                          fasilitas.id
                        }')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // OPTIMASI: Fungsi load data transaksi dengan pagination
      async function loadTransaksi(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(page, paginationState.transaksi.pageSize);

          const { data, error, count } = await supabase
            .from("transaksi")
            .select("*", { count: 'exact' })
            .range(from, to)
            .order('tanggal', { ascending: false });

          if (error) {
            console.error("Error loading transaksi:", error);
            showToast("Error loading transaksi: " + error.message, "error");
            return;
          }

          paginationState.transaksi.count = count || 0;
          paginationState.transaksi.page = page;

          updateTransaksiTable(data);
          updatePagination('transaksi');
        } catch (err) {
          console.error("Error loading transaksi:", err);
          showToast("Terjadi kesalahan saat memuat data transaksi", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel transaksi
      function updateTransaksiTable(data) {
        const tbody = document.getElementById("transaksiTableBody");
        tbody.innerHTML = "";

        data.forEach((transaksi) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${formatDate(transaksi.tanggal)}</td>
                    <td>${transaksi.keterangan}</td>
                    <td>${transaksi.kategori}</td>
                    <td><span style="color: ${
                      transaksi.jenis === "pemasukan" ? "#2ecc71" : "#e74c3c"
                    };">${
            transaksi.jenis === "pemasukan" ? "Pemasukan" : "Pengeluaran"
          }</span></td>
                    <td>Rp ${formatNumber(transaksi.jumlah)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editTransaksi('${
                          transaksi.id
                        }')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTransaksi('${
                          transaksi.id
                        }')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // OPTIMASI: Fungsi load data laporan dengan pagination
      async function loadLaporan(page = 1) {
        showLoading();
        try {
          const { from, to } = getPaginationRange(page, paginationState.laporan.pageSize);

          const { data, error, count } = await supabase
            .from("laporan")
            .select("*", { count: 'exact' })
            .range(from, to)
            .order('created_at', { ascending: false });

          if (error) {
            console.error("Error loading laporan:", error);
            showToast("Error loading laporan: " + error.message, "error");
            return;
          }

          paginationState.laporan.count = count || 0;
          paginationState.laporan.page = page;

          updateLaporanTable(data);
          updatePagination('laporan');
        } catch (err) {
          console.error("Error loading laporan:", err);
          showToast("Terjadi kesalahan saat memuat data laporan", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi update tabel laporan
      function updateLaporanTable(data) {
        const tbody = document.getElementById("laporanTableBody");
        tbody.innerHTML = "";

        data.forEach((laporan) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${laporan.nama}</td>
                    <td>${laporan.tipe}</td>
                    <td>${laporan.periode || "-"}</td>
                    <td>${formatDate(laporan.created_at)}</td>
                    <td><span class="status-badge ${getStatusClass(
                      laporan.status
                    )}">${getStatusText(laporan.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="downloadLaporan('${
                          laporan.id
                        }')" ${laporan.status !== "selesai" ? "disabled" : ""}>
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="viewLaporan('${
                          laporan.id
                        }')" ${laporan.status !== "selesai" ? "disabled" : ""}>
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                `;
          tbody.appendChild(row);
        });
      }

      // Fungsi load data pengaturan
      async function loadPengaturan() {
        try {
          const { data, error } = await supabase.from("pengaturan").select("*");

          if (error) {
            console.error("Error loading pengaturan:", error);
            showToast("Error loading pengaturan: " + error.message, "error");
            return;
          }

          // Convert to object
          dataPengaturan = {};
          data.forEach((item) => {
            dataPengaturan[item.kunci] = item.nilai;
          });

          updatePengaturanForm();
        } catch (err) {
          console.error("Error loading pengaturan:", err);
          showToast("Terjadi kesalahan saat memuat data pengaturan", "error");
        }
      }

      // Fungsi update form pengaturan
      function updatePengaturanForm() {
        document.getElementById("pengaturanNamaPesantren").value =
          dataPengaturan.nama_pesantren || "Pesantren Al-Hikmah";
        document.getElementById("pengaturanAlamat").value =
          dataPengaturan.alamat || "Jl. Pendidikan No. 123, Jakarta";
        document.getElementById("pengaturanEmail").value =
          dataPengaturan.email || "info@alhikmah.sch.id";
        document.getElementById("pengaturanTelepon").value =
          dataPengaturan.telepon || "(021) 1234567";
      }

      // Fungsi save santri
      async function saveSantri() {
        const id = document.getElementById("santriId").value;
        const nis = document.getElementById("santriNIS").value;
        const fullName = document.getElementById("santriNama").value;
        const birthPlace = document.getElementById("santriTempatLahir").value;
        const birthDate = document.getElementById("santriTanggalLahir").value;
        const kelasId = document.getElementById("santriKelas").value;
        const address = document.getElementById("santriAlamat").value;
        const parentName = document.getElementById("santriOrtu").value;
        const parentPhone = document.getElementById("santriHPOrtu").value;
        const status = document.getElementById("santriStatus").value;

        if (!nis || !fullName || !kelasId) {
          showToast("Mohon lengkapi semua field yang diperlukan", "warning");
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing santri
            result = await supabase
              .from("santri")
              .update({
                nis: nis,
                nama_lengkap: fullName,
                tempat_lahir: birthPlace,
                tanggal_lahir: birthDate,
                kelas_id: kelasId,
                alamat: address,
                nama_ortu: parentName,
                hp_ortu: parentPhone,
                status: status,
              })
              .eq("id", id);
          } else {
            // Insert new santri
            result = await supabase.from("santri").insert([
              {
                nis: nis,
                nama_lengkap: fullName,
                tempat_lahir: birthPlace,
                tanggal_lahir: birthDate,
                kelas_id: kelasId,
                alamat: address,
                nama_ortu: parentName,
                hp_ortu: parentPhone,
                status: status,
              },
            ]);
          }

          if (result.error) {
            showToast("Error: " + result.error.message, "error");
            return;
          }

          showToast(
            `Data santri berhasil ${id ? "diperbarui" : "disimpan"}!`,
            "success"
          );
          closeModal("santriModal");

          // Clear form
          document.getElementById("santriId").value = "";
          document.getElementById("santriNIS").value = "";
          document.getElementById("santriNama").value = "";
          document.getElementById("santriTempatLahir").value = "";
          document.getElementById("santriTanggalLahir").value = "";
          document.getElementById("santriKelas").value = "";
          document.getElementById("santriAlamat").value = "";
          document.getElementById("santriOrtu").value = "";
          document.getElementById("santriHPOrtu").value = "";
          document.getElementById("santriStatus").value = "aktif";

          // Reload data
          await loadSantri(paginationState.santri.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menyimpan data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit santri
      async function editSantri(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("santri")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            showToast("Error: " + error.message, "error");
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("santriId").value = data.id;
          document.getElementById("santriNIS").value = data.nis;
          document.getElementById("santriNama").value = data.nama_lengkap;
          document.getElementById("santriTempatLahir").value =
            data.tempat_lahir || "";
          document.getElementById("santriTanggalLahir").value =
            data.tanggal_lahir || "";
          document.getElementById("santriKelas").value = data.kelas_id || "";
          document.getElementById("santriAlamat").value = data.alamat || "";
          document.getElementById("santriOrtu").value = data.nama_ortu || "";
          document.getElementById("santriHPOrtu").value = data.hp_ortu || "";
          document.getElementById("santriStatus").value =
            data.status || "aktif";

          // Update modal title
          document.getElementById("santriModalTitle").textContent =
            "Edit Data Santri";

          // Open modal
          openModal("santriModal");
        } catch (err) {
          showToast("Terjadi kesalahan saat memuat data santri", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete santri
      async function deleteSantri(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus data santri ini?")) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase.from("santri").delete().eq("id", id);

          if (error) {
            showToast("Error: " + error.message, "error");
            return;
          }

          showToast("Data santri berhasil dihapus!", "success");

          // Reload data
          await loadSantri(paginationState.santri.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menghapus data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi save guru
      async function saveGuru() {
        const id = document.getElementById("pengajarId").value;
        const nip = document.getElementById("pengajarNIP").value;
        const fullName = document.getElementById("pengajarNama").value;
        const subject = document.getElementById("pengajarMapel").value;
        const phone = document.getElementById("pengajarHP").value;
        const email = document.getElementById("pengajarEmail").value;
        const address = document.getElementById("pengajarAlamat").value;
        const status = document.getElementById("pengajarStatus").value;

        if (!nip || !fullName || !subject) {
          showToast("Mohon lengkapi semua field yang diperlukan", "warning");
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing guru
            result = await supabase
              .from("guru")
              .update({
                nip: nip,
                nama_lengkap: fullName,
                mata_pelajaran: subject,
                no_hp: phone,
                email: email,
                alamat: address,
                status: status,
              })
              .eq("id", id);
          } else {
            // Insert new guru
            result = await supabase.from("guru").insert([
              {
                nip: nip,
                nama_lengkap: fullName,
                mata_pelajaran: subject,
                no_hp: phone,
                email: email,
                alamat: address,
                status: status,
              },
            ]);
          }

          if (result.error) {
            showToast("Error: " + result.error.message, "error");
            return;
          }

          showToast(
            `Data guru berhasil ${id ? "diperbarui" : "disimpan"}!`,
            "success"
          );
          closeModal("pengajarModal");

          // Clear form
          document.getElementById("pengajarId").value = "";
          document.getElementById("pengajarNIP").value = "";
          document.getElementById("pengajarNama").value = "";
          document.getElementById("pengajarMapel").value = "";
          document.getElementById("pengajarHP").value = "";
          document.getElementById("pengajarEmail").value = "";
          document.getElementById("pengajarAlamat").value = "";
          document.getElementById("pengajarStatus").value = "aktif";

          // Reload data
          await loadGuru(paginationState.guru.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menyimpan data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit guru
      async function editGuru(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("guru")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            showToast("Error: " + error.message, "error");
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("pengajarId").value = data.id;
          document.getElementById("pengajarNIP").value = data.nip;
          document.getElementById("pengajarNama").value = data.nama_lengkap;
          document.getElementById("pengajarMapel").value =
            data.mata_pelajaran || "";
          document.getElementById("pengajarHP").value = data.no_hp || "";
          document.getElementById("pengajarEmail").value = data.email || "";
          document.getElementById("pengajarAlamat").value = data.alamat || "";
          document.getElementById("pengajarStatus").value =
            data.status || "aktif";

          // Update modal title
          document.getElementById("pengajarModalTitle").textContent =
            "Edit Data Pengajar";

          // Open modal
          openModal("pengajarModal");
        } catch (err) {
          showToast("Terjadi kesalahan saat memuat data guru", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete guru
      async function deleteGuru(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus data guru ini?")) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase.from("guru").delete().eq("id", id);

          if (error) {
            showToast("Error: " + error.message, "error");
            return;
          }

          showToast("Data guru berhasil dihapus!", "success");

          // Reload data
          await loadGuru(paginationState.guru.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menghapus data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi save kegiatan
      async function saveKegiatan() {
        const id = document.getElementById("kegiatanId").value;
        const name = document.getElementById("kegiatanNama").value;
        const date = document.getElementById("kegiatanTanggal").value;
        const time = document.getElementById("kegiatanWaktu").value;
        const location = document.getElementById("kegiatanLokasi").value;
        const organizer = document.getElementById("kegiatanPJ").value;
        const status = document.getElementById("kegiatanStatus").value;
        const description = document.getElementById("kegiatanDeskripsi").value;

        if (!name || !date || !location) {
          showToast("Mohon lengkapi semua field yang diperlukan", "warning");
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing kegiatan
            result = await supabase
              .from("kegiatan")
              .update({
                nama: name,
                tanggal: date,
                waktu: time,
                lokasi: location,
                penanggung_jawab: organizer,
                status: status,
                deskripsi: description,
              })
              .eq("id", id);
          } else {
            // Insert new kegiatan
            result = await supabase.from("kegiatan").insert([
              {
                nama: name,
                tanggal: date,
                waktu: time,
                lokasi: location,
                penanggung_jawab: organizer,
                status: status,
                deskripsi: description,
              },
            ]);
          }

          if (result.error) {
            showToast("Error: " + result.error.message, "error");
            return;
          }

          showToast(
            `Data kegiatan berhasil ${id ? "diperbarui" : "disimpan"}!`,
            "success"
          );
          closeModal("kegiatanModal");

          // Clear form
          document.getElementById("kegiatanId").value = "";
          document.getElementById("kegiatanNama").value = "";
          document.getElementById("kegiatanTanggal").value = "";
          document.getElementById("kegiatanWaktu").value = "";
          document.getElementById("kegiatanLokasi").value = "";
          document.getElementById("kegiatanPJ").value = "";
          document.getElementById("kegiatanStatus").value = "dalam_proses";
          document.getElementById("kegiatanDeskripsi").value = "";

          // Reload data
          await loadKegiatan(paginationState.kegiatan.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menyimpan data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit kegiatan
      async function editKegiatan(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("kegiatan")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            showToast("Error: " + error.message, "error");
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("kegiatanId").value = data.id;
          document.getElementById("kegiatanNama").value = data.nama;
          document.getElementById("kegiatanTanggal").value = data.tanggal;
          document.getElementById("kegiatanWaktu").value = data.waktu || "";
          document.getElementById("kegiatanLokasi").value = data.lokasi || "";
          document.getElementById("kegiatanPJ").value =
            data.penanggung_jawab || "";
          document.getElementById("kegiatanStatus").value =
            data.status || "dalam_proses";
          document.getElementById("kegiatanDeskripsi").value =
            data.deskripsi || "";

          // Update modal title
          document.getElementById("kegiatanModalTitle").textContent =
            "Edit Data Kegiatan";

          // Open modal
          openModal("kegiatanModal");
        } catch (err) {
          showToast("Terjadi kesalahan saat memuat data kegiatan", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete kegiatan
      async function deleteKegiatan(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus data kegiatan ini?")) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase
            .from("kegiatan")
            .delete()
            .eq("id", id);

          if (error) {
            showToast("Error: " + error.message, "error");
            return;
          }

          showToast("Data kegiatan berhasil dihapus!", "success");

          // Reload data
          await loadKegiatan(paginationState.kegiatan.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menghapus data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi save fasilitas
      async function saveFasilitas() {
        const id = document.getElementById("fasilitasId").value;
        const name = document.getElementById("fasilitasNama").value;
        const capacity = document.getElementById("fasilitasKapasitas").value;
        const condition = document.getElementById("fasilitasKondisi").value;
        const pic = document.getElementById("fasilitasPJ").value;
        const status = document.getElementById("fasilitasStatus").value;
        const description = document.getElementById("fasilitasDeskripsi").value;

        if (!name || !capacity || !condition) {
          showToast("Mohon lengkapi semua field yang diperlukan", "warning");
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing fasilitas
            result = await supabase
              .from("fasilitas")
              .update({
                nama: name,
                kapasitas: capacity,
                kondisi: condition,
                penanggung_jawab: pic,
                status: status,
                deskripsi: description,
              })
              .eq("id", id);
          } else {
            // Insert new fasilitas
            result = await supabase.from("fasilitas").insert([
              {
                nama: name,
                kapasitas: capacity,
                kondisi: condition,
                penanggung_jawab: pic,
                status: status,
                deskripsi: description,
              },
            ]);
          }

          if (result.error) {
            showToast("Error: " + result.error.message, "error");
            return;
          }

          showToast(
            `Data fasilitas berhasil ${id ? "diperbarui" : "disimpan"}!`,
            "success"
          );
          closeModal("fasilitasModal");

          // Clear form
          document.getElementById("fasilitasId").value = "";
          document.getElementById("fasilitasNama").value = "";
          document.getElementById("fasilitasKapasitas").value = "";
          document.getElementById("fasilitasKondisi").value = "";
          document.getElementById("fasilitasPJ").value = "";
          document.getElementById("fasilitasStatus").value = "tersedia";
          document.getElementById("fasilitasDeskripsi").value = "";

          // Reload data
          await loadFasilitas(paginationState.fasilitas.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menyimpan data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit fasilitas
      async function editFasilitas(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("fasilitas")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            showToast("Error: " + error.message, "error");
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("fasilitasId").value = data.id;
          document.getElementById("fasilitasNama").value = data.nama;
          document.getElementById("fasilitasKapasitas").value =
            data.kapasitas || "";
          document.getElementById("fasilitasKondisi").value =
            data.kondisi || "";
          document.getElementById("fasilitasPJ").value =
            data.penanggung_jawab || "";
          document.getElementById("fasilitasStatus").value =
            data.status || "tersedia";
          document.getElementById("fasilitasDeskripsi").value =
            data.deskripsi || "";

          // Update modal title
          document.getElementById("fasilitasModalTitle").textContent =
            "Edit Data Fasilitas";

          // Open modal
          openModal("fasilitasModal");
        } catch (err) {
          showToast("Terjadi kesalahan saat memuat data fasilitas", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete fasilitas
      async function deleteFasilitas(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus data fasilitas ini?")) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase
            .from("fasilitas")
            .delete()
            .eq("id", id);

          if (error) {
            showToast("Error: " + error.message, "error");
            return;
          }

          showToast("Data fasilitas berhasil dihapus!", "success");

          // Reload data
          await loadFasilitas(paginationState.fasilitas.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menghapus data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi save transaksi
      async function saveTransaksi() {
        const id = document.getElementById("transaksiId").value;
        const date = document.getElementById("transaksiTanggal").value;
        const description = document.getElementById(
          "transaksiKeterangan"
        ).value;
        const category = document.getElementById("transaksiKategori").value;
        const type = document.getElementById("transaksiJenis").value;
        const amount = document.getElementById("transaksiJumlah").value;

        if (!date || !description || !category || !type || !amount) {
          showToast("Mohon lengkapi semua field yang diperlukan", "warning");
          return;
        }

        showLoading();

        try {
          let result;

          if (id) {
            // Update existing transaksi
            result = await supabase
              .from("transaksi")
              .update({
                tanggal: date,
                keterangan: description,
                kategori: category,
                jenis: type,
                jumlah: amount,
              })
              .eq("id", id);
          } else {
            // Insert new transaksi
            result = await supabase.from("transaksi").insert([
              {
                tanggal: date,
                keterangan: description,
                kategori: category,
                jenis: type,
                jumlah: amount,
              },
            ]);
          }

          if (result.error) {
            showToast("Error: " + result.error.message, "error");
            return;
          }

          showToast(
            `Data transaksi berhasil ${id ? "diperbarui" : "disimpan"}!`,
            "success"
          );
          closeModal("transaksiModal");

          // Clear form
          document.getElementById("transaksiId").value = "";
          document.getElementById("transaksiTanggal").value = "";
          document.getElementById("transaksiKeterangan").value = "";
          document.getElementById("transaksiKategori").value = "";
          document.getElementById("transaksiJenis").value = "";
          document.getElementById("transaksiJumlah").value = "";

          // Reload data
          await loadTransaksi(paginationState.transaksi.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menyimpan data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi edit transaksi
      async function editTransaksi(id) {
        showLoading();

        try {
          const { data, error } = await supabase
            .from("transaksi")
            .select("*")
            .eq("id", id)
            .single();

          if (error) {
            showToast("Error: " + error.message, "error");
            hideLoading();
            return;
          }

          // Fill form with data
          document.getElementById("transaksiId").value = data.id;
          document.getElementById("transaksiTanggal").value = data.tanggal;
          document.getElementById("transaksiKeterangan").value =
            data.keterangan;
          document.getElementById("transaksiKategori").value = data.kategori;
          document.getElementById("transaksiJenis").value = data.jenis;
          document.getElementById("transaksiJumlah").value = data.jumlah;

          // Update modal title
          document.getElementById("transaksiModalTitle").textContent =
            "Edit Data Transaksi";

          // Open modal
          openModal("transaksiModal");
        } catch (err) {
          showToast("Terjadi kesalahan saat memuat data transaksi", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi delete transaksi
      async function deleteTransaksi(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus data transaksi ini?")) {
          return;
        }

        showLoading();

        try {
          const { error } = await supabase
            .from("transaksi")
            .delete()
            .eq("id", id);

          if (error) {
            showToast("Error: " + error.message, "error");
            return;
          }

          showToast("Data transaksi berhasil dihapus!", "success");

          // Reload data
          await loadTransaksi(paginationState.transaksi.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat menghapus data", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi save pengaturan
      async function saveSettings() {
        const namaPesantren = document.getElementById(
          "pengaturanNamaPesantren"
        ).value;
        const alamat = document.getElementById("pengaturanAlamat").value;
        const email = document.getElementById("pengaturanEmail").value;
        const telepon = document.getElementById("pengaturanTelepon").value;

        showLoading();

        try {
          // Update each setting
          await updateSetting("nama_pesantren", namaPesantren);
          await updateSetting("alamat", alamat);
          await updateSetting("email", email);
          await updateSetting("telepon", telepon);

          showToast("Pengaturan berhasil disimpan!", "success");

          // Reload data
          await loadPengaturan();
        } catch (err) {
          showToast("Terjadi kesalahan saat menyimpan pengaturan", "error");
        } finally {
          hideLoading();
        }
      }

      // Helper function to update a single setting
      async function updateSetting(key, value) {
        // Check if setting already exists
        const { data: existingData, error: checkError } = await supabase
          .from("pengaturan")
          .select("*")
          .eq("kunci", key);

        if (checkError) {
          console.error("Error checking setting:", checkError);
          return;
        }

        if (existingData.length > 0) {
          // Update existing setting
          const { error: updateError } = await supabase
            .from("pengaturan")
            .update({ nilai: value })
            .eq("kunci", key);

          if (updateError) {
            console.error("Error updating setting:", updateError);
          }
        } else {
          // Insert new setting
          const { error: insertError } = await supabase
            .from("pengaturan")
            .insert([
              {
                kunci: key,
                nilai: value,
              },
            ]);

          if (insertError) {
            console.error("Error inserting setting:", insertError);
          }
        }
      }

      // OPTIMASI: Fungsi load data absen guru
      async function loadAbsenGuru() {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;

        if (!tanggal) return;

        showLoading();

        try {
          // Get all guru
          const { data: guruData, error: guruError } = await supabase
            .from("guru")
            .select("*");

          if (guruError) {
            console.error("Error loading guru:", guruError);
            hideLoading();
            return;
          }

          // Get attendance data
          const { data: attendanceData, error: attendanceError } =
            await supabase
              .from("absensi_guru")
              .select("*")
              .eq("tanggal", tanggal)
              .eq("sesi", waktu);

          if (attendanceError) {
            console.error("Error loading attendance:", attendanceError);
            hideLoading();
            return;
          }

          // Create a map of attendance data
          const attendanceMap = {};
          attendanceData.forEach((attendance) => {
            attendanceMap[attendance.guru_id] = attendance;
          });

          // Update table
          const tbody = document.getElementById("absenGuruTableBody");
          tbody.innerHTML = "";

          guruData.forEach((guru) => {
            const attendance = attendanceMap[guru.id];
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>
                            <input type="checkbox" class="attendance-checkbox guru-checkbox" onchange="updateGuruSummary()">
                        </td>
                        <td>${guru.nama_lengkap}</td>
                        <td>${guru.nip}</td>
                        <td>${guru.mata_pelajaran}</td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateGuruStatus(this)">
                                <option value="hadir" ${
                                  attendance && attendance.status === "hadir"
                                    ? "selected"
                                    : ""
                                }>Hadir</option>
                                <option value="tidak_hadir" ${
                                  attendance &&
                                  attendance.status === "tidak_hadir"
                                    ? "selected"
                                    : ""
                                }>Tidak Hadir</option>
                                <option value="izin" ${
                                  attendance && attendance.status === "izin"
                                    ? "selected"
                                    : ""
                                }>Izin</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm" placeholder="Keterangan" value="${
                              attendance ? attendance.keterangan : ""
                            }">
                        </td>
                    `;
            tbody.appendChild(row);
          });

          // Update summary
          updateGuruSummary();
        } catch (err) {
          console.error("Error loading absen guru:", err);
          showToast("Terjadi kesalahan saat memuat data absensi", "error");
        } finally {
          hideLoading();
        }
      }

      // OPTIMASI: Fungsi load data absen santri
      async function loadAbsenSantri() {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;
        const kelasId = document.getElementById("absenKelas").value;

        if (!tanggal) return;

        showLoading();

        try {
          // Get all santri
          let query = supabase.from("santri").select(`
                    *,
                    kelas (
                        id,
                        nama
                    )
                `);

          // Filter by class if selected
          if (kelasId) {
            query = query.eq("kelas_id", kelasId);
          }

          const { data: santriData, error: santriError } = await query;

          if (santriError) {
            console.error("Error loading santri:", santriError);
            hideLoading();
            return;
          }

          // Get attendance data
          const { data: attendanceData, error: attendanceError } =
            await supabase
              .from("absensi_santri")
              .select("*")
              .eq("tanggal", tanggal)
              .eq("sesi", waktu);

          if (attendanceError) {
            console.error("Error loading attendance:", attendanceError);
            hideLoading();
            return;
          }

          // Create a map of attendance data
          const attendanceMap = {};
          attendanceData.forEach((attendance) => {
            attendanceMap[attendance.santri_id] = attendance;
          });

          // Update table
          const tbody = document.getElementById("absenSantriTableBody");
          tbody.innerHTML = "";

          santriData.forEach((santri) => {
            const attendance = attendanceMap[santri.id];
            const row = document.createElement("tr");
            row.innerHTML = `
                        <td>
                            <input type="checkbox" class="attendance-checkbox santri-checkbox" onchange="updateSantriSummary()">
                        </td>
                        <td>${santri.nama_lengkap}</td>
                        <td>${santri.nis}</td>
                        <td>${santri.kelas ? santri.kelas.nama : "-"}</td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateSantriStatus(this)">
                                <option value="hadir" ${
                                  attendance && attendance.status === "hadir"
                                    ? "selected"
                                    : ""
                                }>Hadir</option>
                                <option value="tidak_hadir" ${
                                  attendance &&
                                  attendance.status === "tidak_hadir"
                                    ? "selected"
                                    : ""
                                }>Tidak Hadir</option>
                                <option value="izin" ${
                                  attendance && attendance.status === "izin"
                                    ? "selected"
                                    : ""
                                }>Izin</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm" placeholder="Keterangan" value="${
                              attendance ? attendance.keterangan : ""
                            }">
                        </td>
                    `;
            tbody.appendChild(row);
          });

          // Update summary
          updateSantriSummary();
        } catch (err) {
          console.error("Error loading absen santri:", err);
          showToast("Terjadi kesalahan saat memuat data absensi", "error");
        } finally {
          hideLoading();
        }
      }

      // OPTIMASI: Fungsi save absen guru menggunakan upsert
      async function saveAbsenGuru() {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;

        if (!tanggal) {
          showToast("Mohon pilih tanggal absen", "warning");
          return;
        }

        showLoading();

        try {
          // Get all guru rows
          const rows = document.querySelectorAll("#absenGuruTableBody tr");
          const attendanceData = [];

          // Get all guru data for mapping
          const { data: guruData } = await supabase.from("guru").select("id, nama_lengkap");

          rows.forEach((row) => {
            const guruName = row.querySelector("td:nth-child(2)").textContent;
            const status = row.querySelector("select").value;
            const notes = row.querySelector('input[type="text"]').value;

            // Find guru by name
            const guru = guruData.find((g) => g.nama_lengkap === guruName);
            if (guru) {
              attendanceData.push({
                guru_id: guru.id,
                tanggal: tanggal,
                sesi: waktu,
                status: status,
                keterangan: notes,
              });
            }
          });

          // Use upsert to insert or update all records in a single operation
          const { error } = await supabase
            .from("absensi_guru")
            .upsert(attendanceData, {
              onConflict: "guru_id, tanggal, sesi",
            });

          if (error) {
            showToast("Error: " + error.message, "error");
            return;
          }

          showToast("Absen guru berhasil disimpan!", "success");
        } catch (err) {
          showToast("Terjadi kesalahan saat menyimpan absen", "error");
        } finally {
          hideLoading();
        }
      }

      // OPTIMASI: Fungsi save absen santri menggunakan upsert
      async function saveAbsenSantri() {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;

        if (!tanggal) {
          showToast("Mohon pilih tanggal absen", "warning");
          return;
        }

        showLoading();

        try {
          // Get all santri rows
          const rows = document.querySelectorAll("#absenSantriTableBody tr");
          const attendanceData = [];

          // Get all santri data for mapping
          const { data: santriData } = await supabase.from("santri").select("id, nama_lengkap");

          rows.forEach((row) => {
            const santriName = row.querySelector("td:nth-child(2)").textContent;
            const status = row.querySelector("select").value;
            const notes = row.querySelector('input[type="text"]').value;

            // Find santri by name
            const santri = santriData.find((s) => s.nama_lengkap === santriName);
            if (santri) {
              attendanceData.push({
                santri_id: santri.id,
                tanggal: tanggal,
                sesi: waktu,
                status: status,
                keterangan: notes,
              });
            }
          });

          // Use upsert to insert or update all records in a single operation
          const { error } = await supabase
            .from("absensi_santri")
            .upsert(attendanceData, {
              onConflict: "santri_id, tanggal, sesi",
            });

          if (error) {
            showToast("Error: " + error.message, "error");
            return;
          }

          showToast("Absen santri berhasil disimpan!", "success");
        } catch (err) {
          showToast("Terjadi kesalahan saat menyimpan absen", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi filter absen
      function filterAbsen() {
        loadAbsenGuru();
        loadAbsenSantri();
      }

      // Fungsi update summary guru
      function updateGuruSummary() {
        const selects = document.querySelectorAll("#absenGuruTableBody select");
        let hadirCount = 0;
        let tidakHadirCount = 0;
        let izinCount = 0;

        selects.forEach((select) => {
          if (select.value === "hadir") hadirCount++;
          else if (select.value === "tidak_hadir") tidakHadirCount++;
          else if (select.value === "izin") izinCount++;
        });

        document.getElementById("guruHadirCount").textContent = hadirCount;
        document.getElementById("guruTidakHadirCount").textContent =
          tidakHadirCount;
        document.getElementById("guruIzinCount").textContent = izinCount;
      }

      // Fungsi update summary santri
      function updateSantriSummary() {
        const selects = document.querySelectorAll(
          "#absenSantriTableBody select"
        );
        let hadirCount = 0;
        let tidakHadirCount = 0;
        let izinCount = 0;

        selects.forEach((select) => {
          if (select.value === "hadir") hadirCount++;
          else if (select.value === "tidak_hadir") tidakHadirCount++;
          else if (select.value === "izin") izinCount++;
        });

        document.getElementById("santriHadirCount").textContent = hadirCount;
        document.getElementById("santriTidakHadirCount").textContent =
          tidakHadirCount;
        document.getElementById("santriIzinCount").textContent = izinCount;
      }

      // Fungsi toggle all checkboxes
      function toggleAllGuru() {
        const selectAllCheckbox = document.getElementById("selectAllGuru");
        const guruCheckboxes = document.querySelectorAll(".guru-checkbox");

        guruCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      }

      function toggleAllSantri() {
        const selectAllCheckbox = document.getElementById("selectAllSantri");
        const santriCheckboxes = document.querySelectorAll(".santri-checkbox");

        santriCheckboxes.forEach((checkbox) => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      }

      // Fungsi export PDF untuk data santri
      function exportSantriPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(18);
        doc.text("Data Santri Pesantren Al-Hikmah", 14, 15);

        // Tanggal export
        doc.setFontSize(10);
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, 25);

        // Tabel data
        let yPosition = 35;
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("NIS", 35, yPosition);
        doc.text("Nama Lengkap", 60, yPosition);
        doc.text("Kelas", 120, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get current page data
        const from = (paginationState.santri.page - 1) * paginationState.santri.pageSize;
        const to = from + paginationState.santri.pageSize - 1;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("santri")
          .select(`
            *,
            kelas (
                id,
                nama
            )
        `)
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Data santri
            data.forEach((santri, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(santri.nis, 35, yPosition);
              doc.text(santri.nama_lengkap, 60, yPosition);
              doc.text(santri.kelas ? santri.kelas.nama : "-", 120, yPosition);
              doc.text(
                santri.status === "aktif" ? "Aktif" : "Tidak Aktif",
                160,
                yPosition
              );

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_santri.pdf");
            showToast("Export PDF berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data guru
      function exportGuruPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(18);
        doc.text("Data Guru Pesantren Al-Hikmah", 14, 15);

        // Tanggal export
        doc.setFontSize(10);
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, 25);

        // Tabel data
        let yPosition = 35;
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("NIP", 35, yPosition);
        doc.text("Nama Lengkap", 60, yPosition);
        doc.text("Mata Pelajaran", 120, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("guru")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Data guru
            data.forEach((guru, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(guru.nip, 35, yPosition);
              doc.text(guru.nama_lengkap, 60, yPosition);
              doc.text(guru.mata_pelajaran || "-", 120, yPosition);
              doc.text(
                guru.status === "aktif" ? "Aktif" : "Tidak Aktif",
                160,
                yPosition
              );

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_guru.pdf");
            showToast("Export PDF berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data absensi
      function exportAbsensiPDF(type) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;
        const waktuText =
          waktu === "pagi" ? "Pagi" : waktu === "sore" ? "Sore" : "Malam";

        // Header
        doc.setFontSize(18);
        doc.text(
          `Data Absensi ${type === "guru" ? "Guru" : "Santri"} Halaqoh`,
          14,
          15
        );

        // Tanggal dan waktu
        doc.setFontSize(10);
        doc.text(`Tanggal: ${formatDate(tanggal)}`, 14, 25);
        doc.text(`Sesi: ${waktuText}`, 14, 32);

        // Tabel data
        let yPosition = 42;
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text(type === "guru" ? "Nama Guru" : "Nama Santri", 35, yPosition);
        doc.text(type === "guru" ? "NIP" : "NIS", 90, yPosition);
        doc.text("Status", 130, yPosition);
        doc.text("Keterangan", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Ambil data dari tabel
        const tableId =
          type === "guru" ? "absenGuruTableBody" : "absenSantriTableBody";
        const rows = document.querySelectorAll(`#${tableId} tr`);

        // Data absensi
        rows.forEach((row, index) => {
          if (yPosition > 270) {
            doc.addPage();
            yPosition = 20;
          }

          const cells = row.querySelectorAll("td");
          const statusSelect = cells[4].querySelector("select");
          const statusText = statusSelect
            ? statusSelect.options[statusSelect.selectedIndex].text
            : "-";
          const keterangan = cells[5].querySelector("input").value;

          doc.setFontSize(10);
          doc.text(`${index + 1}`, 14, yPosition);
          doc.text(cells[1].textContent, 35, yPosition);
          doc.text(cells[2].textContent, 90, yPosition);
          doc.text(statusText, 130, yPosition);
          doc.text(keterangan, 160, yPosition);

          yPosition += 7;
        });

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
            align: "center",
          });
        }

        // Save PDF
        doc.save(`absensi_${type}_${tanggal}.pdf`);
        showToast("Export PDF berhasil!", "success");
      }

      // Fungsi export PDF untuk data kegiatan
      function exportKegiatanPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(18);
        doc.text("Data Kegiatan Pesantren Al-Hikmah", 14, 15);

        // Tanggal export
        doc.setFontSize(10);
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, 25);

        // Tabel data
        let yPosition = 35;
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("Tanggal", 35, yPosition);
        doc.text("Nama Kegiatan", 60, yPosition);
        doc.text("Penanggung Jawab", 120, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("kegiatan")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Data kegiatan
            data.forEach((kegiatan, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(formatDate(kegiatan.tanggal), 35, yPosition);
              doc.text(kegiatan.nama, 60, yPosition);
              doc.text(kegiatan.penanggung_jawab || "-", 120, yPosition);
              doc.text(getStatusText(kegiatan.status), 160, yPosition);

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_kegiatan.pdf");
            showToast("Export PDF berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data fasilitas
      function exportFasilitasPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(18);
        doc.text("Data Fasilitas Pesantren Al-Hikmah", 14, 15);

        // Tanggal export
        doc.setFontSize(10);
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, 25);

        // Tabel data
        let yPosition = 35;
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("Nama Fasilitas", 35, yPosition);
        doc.text("Kapasitas", 90, yPosition);
        doc.text("Kondisi", 120, yPosition);
        doc.text("Status", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("fasilitas")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Data fasilitas
            data.forEach((fasilitas, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(fasilitas.nama, 35, yPosition);
              doc.text(fasilitas.kapasitas || "-", 90, yPosition);
              doc.text(fasilitas.kondisi || "-", 120, yPosition);
              doc.text(getStatusText(fasilitas.status), 160, yPosition);

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_fasilitas.pdf");
            showToast("Export PDF berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export PDF untuk data transaksi
      function exportTransaksiPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(18);
        doc.text("Data Transaksi Pesantren Al-Hikmah", 14, 15);

        // Tanggal export
        doc.setFontSize(10);
        doc.text(`Tanggal Export: ${formatDate(new Date())}`, 14, 25);

        // Tabel data
        let yPosition = 35;
        doc.setFontSize(12);
        doc.text("No", 14, yPosition);
        doc.text("Tanggal", 35, yPosition);
        doc.text("Keterangan", 60, yPosition);
        doc.text("Kategori", 120, yPosition);
        doc.text("Jenis", 160, yPosition);

        yPosition += 7;
        doc.line(14, yPosition, 195, yPosition);
        yPosition += 5;

        // Get all data for export (not just current page)
        showLoading();
        supabase
          .from("transaksi")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Data transaksi
            data.forEach((transaksi, index) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }

              doc.setFontSize(10);
              doc.text(`${index + 1}`, 14, yPosition);
              doc.text(formatDate(transaksi.tanggal), 35, yPosition);
              doc.text(transaksi.keterangan.substring(0, 25), 60, yPosition);
              doc.text(transaksi.kategori, 120, yPosition);
              doc.text(
                transaksi.jenis === "pemasukan" ? "Pemasukan" : "Pengeluaran",
                160,
                yPosition
              );

              yPosition += 7;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save("data_transaksi.pdf");
            showToast("Export PDF berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data santri
      function exportSantriExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("santri")
          .select(`
            *,
            kelas (
                id,
                nama
            )
        `)
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((santri, index) => ({
              No: index + 1,
              NIS: santri.nis,
              "Nama Lengkap": santri.nama_lengkap,
              "Tempat Lahir": santri.tempat_lahir || "",
              "Tanggal Lahir": santri.tanggal_lahir || "",
              Kelas: santri.kelas ? santri.kelas.nama : "",
              Alamat: santri.alamat || "",
              "Nama Orang Tua": santri.nama_ortu || "",
              "HP Orang Tua": santri.hp_ortu || "",
              Status: santri.status === "aktif" ? "Aktif" : "Tidak Aktif",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 15 }, // NIS
              { wch: 25 }, // Nama Lengkap
              { wch: 15 }, // Tempat Lahir
              { wch: 15 }, // Tanggal Lahir
              { wch: 10 }, // Kelas
              { wch: 20 }, // Alamat
              { wch: 20 }, // Nama Orang Tua
              { wch: 15 }, // HP Orang Tua
              { wch: 10 }, // Status
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Santri");

            // Export file
            XLSX.writeFile(wb, "data_santri.xlsx");
            showToast("Export Excel berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data guru
      function exportGuruExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("guru")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((guru, index) => ({
              No: index + 1,
              NIP: guru.nip,
              "Nama Lengkap": guru.nama_lengkap,
              "Mata Pelajaran": guru.mata_pelajaran || "",
              "No. HP": guru.no_hp || "",
              Email: guru.email || "",
              Alamat: guru.alamat || "",
              Status: guru.status === "aktif" ? "Aktif" : "Tidak Aktif",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 20 }, // NIP
              { wch: 25 }, // Nama Lengkap
              { wch: 20 }, // Mata Pelajaran
              { wch: 15 }, // No. HP
              { wch: 25 }, // Email
              { wch: 30 }, // Alamat
              { wch: 10 }, // Status
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Guru");

            // Export file
            XLSX.writeFile(wb, "data_guru.xlsx");
            showToast("Export Excel berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data absensi
      function exportAbsensiExcel(type) {
        const tanggal = document.getElementById("absenTanggal").value;
        const waktu = document.getElementById("absenWaktu").value;
        const waktuText =
          waktu === "pagi" ? "Pagi" : waktu === "sore" ? "Sore" : "Malam";

        // Ambil data dari tabel
        const tableId =
          type === "guru" ? "absenGuruTableBody" : "absenSantriTableBody";
        const rows = document.querySelectorAll(`#${tableId} tr`);

        // Siapkan data untuk Excel
        const data = Array.from(rows).map((row, index) => {
          const cells = row.querySelectorAll("td");
          const statusSelect = cells[4].querySelector("select");
          const statusText = statusSelect
            ? statusSelect.options[statusSelect.selectedIndex].text
            : "-";
          const keterangan = cells[5].querySelector("input").value;

          return {
            No: index + 1,
            [type === "guru" ? "Nama Guru" : "Nama Santri"]:
              cells[1].textContent,
            [type === "guru" ? "NIP" : "NIS"]: cells[2].textContent,
            Status: statusText,
            Keterangan: keterangan,
          };
        });

        // Buat workbook
        const wb = XLSX.utils.book_new();

        // Buat worksheet
        const ws = XLSX.utils.json_to_sheet(data);

        // Atur lebar kolom
        const colWidths = [
          { wch: 5 }, // No
          { wch: 25 }, // Nama
          { wch: 20 }, // NIP/NIS
          { wch: 10 }, // Status
          { wch: 30 }, // Keterangan
        ];
        ws["!cols"] = colWidths;

        // Tambahkan worksheet ke workbook
        XLSX.utils.book_append_sheet(
          wb,
          ws,
          `Absensi ${type === "guru" ? "Guru" : "Santri"}`
        );

        // Export file
        XLSX.writeFile(wb, `absensi_${type}_${tanggal}.xlsx`);
        showToast("Export Excel berhasil!", "success");
      }

      // Fungsi export Excel untuk data kegiatan
      function exportKegiatanExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("kegiatan")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((kegiatan, index) => ({
              No: index + 1,
              "Nama Kegiatan": kegiatan.nama,
              Tanggal: formatDate(kegiatan.tanggal),
              Waktu: kegiatan.waktu || "",
              Lokasi: kegiatan.lokasi || "",
              "Penanggung Jawab": kegiatan.penanggung_jawab || "",
              Status: getStatusText(kegiatan.status),
              Deskripsi: kegiatan.deskripsi || "",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 25 }, // Nama Kegiatan
              { wch: 15 }, // Tanggal
              { wch: 10 }, // Waktu
              { wch: 20 }, // Lokasi
              { wch: 20 }, // Penanggung Jawab
              { wch: 10 }, // Status
              { wch: 30 }, // Deskripsi
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Kegiatan");

            // Export file
            XLSX.writeFile(wb, "data_kegiatan.xlsx");
            showToast("Export Excel berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data fasilitas
      function exportFasilitasExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("fasilitas")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((fasilitas, index) => ({
              No: index + 1,
              "Nama Fasilitas": fasilitas.nama,
              Kapasitas: fasilitas.kapasitas || "",
              Kondisi: fasilitas.kondisi || "",
              "Penanggung Jawab": fasilitas.penanggung_jawab || "",
              "Pemeriksaan Terakhir": fasilitas.pemeriksaan_terakhir
                ? formatDate(fasilitas.pemeriksaan_terakhir)
                : "",
              Status: getStatusText(fasilitas.status),
              Deskripsi: fasilitas.deskripsi || "",
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 20 }, // Nama Fasilitas
              { wch: 10 }, // Kapasitas
              { wch: 10 }, // Kondisi
              { wch: 20 }, // Penanggung Jawab
              { wch: 20 }, // Pemeriksaan Terakhir
              { wch: 10 }, // Status
              { wch: 30 }, // Deskripsi
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Fasilitas");

            // Export file
            XLSX.writeFile(wb, "data_fasilitas.xlsx");
            showToast("Export Excel berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export Excel untuk data transaksi
      function exportTransaksiExcel() {
        showLoading();
        // Get all data for export (not just current page)
        supabase
          .from("transaksi")
          .select("*")
          .then(({ data, error }) => {
            if (error) {
              showToast("Error loading data for export: " + error.message, "error");
              hideLoading();
              return;
            }

            // Siapkan data untuk Excel
            const exportData = data.map((transaksi, index) => ({
              No: index + 1,
              Tanggal: formatDate(transaksi.tanggal),
              Keterangan: transaksi.keterangan,
              Kategori: transaksi.kategori,
              Jenis: transaksi.jenis === "pemasukan" ? "Pemasukan" : "Pengeluaran",
              Jumlah: transaksi.jumlah,
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Atur lebar kolom
            const colWidths = [
              { wch: 5 }, // No
              { wch: 15 }, // Tanggal
              { wch: 30 }, // Keterangan
              { wch: 15 }, // Kategori
              { wch: 10 }, // Jenis
              { wch: 15 }, // Jumlah
            ];
            ws["!cols"] = colWidths;

            // Tambahkan worksheet ke workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data Transaksi");

            // Export file
            XLSX.writeFile(wb, "data_transaksi.xlsx");
            showToast("Export Excel berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export PDF untuk laporan keuangan
      function exportLaporanKeuanganPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Filter transaksi bulan ini
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        showLoading();
        supabase
          .from("transaksi")
          .select("*")
          .gte("tanggal", new Date(currentYear, currentMonth, 1))
          .lte("tanggal", new Date(currentYear, currentMonth + 1, 0))
          .then(({ data: transaksiThisMonth, error }) => {
            if (error) {
              showToast("Error loading data for report: " + error.message, "error");
              hideLoading();
              return;
            }

            // Hitung total
            const totalPemasukan = transaksiThisMonth
              .filter((t) => t.jenis === "pemasukan")
              .reduce((sum, t) => sum + parseFloat(t.jumlah), 0);
            const totalPengeluaran = transaksiThisMonth
              .filter((t) => t.jenis === "pengeluaran")
              .reduce((sum, t) => sum + parseFloat(t.jumlah), 0);
            const saldo = totalPemasukan - totalPengeluaran;

            // Header
            doc.setFontSize(18);
            doc.text("Laporan Keuangan Bulanan", 14, 15);

            // Periode
            doc.setFontSize(12);
            const monthNames = [
              "Januari",
              "Februari",
              "Maret",
              "April",
              "Mei",
              "Juni",
              "Juli",
              "Agustus",
              "September",
              "Oktober",
              "November",
              "Desember",
            ];
            doc.text(`Periode: ${monthNames[currentMonth]} ${currentYear}`, 14, 25);

            // Ringkasan
            doc.setFontSize(12);
            doc.text("Ringkasan:", 14, 40);
            doc.setFontSize(10);
            doc.text(`Total Pemasukan: Rp ${formatNumber(totalPemasukan)}`, 20, 50);
            doc.text(
              `Total Pengeluaran: Rp ${formatNumber(totalPengeluaran)}`,
              20,
              57
            );
            doc.text(`Saldo: Rp ${formatNumber(saldo)}`, 20, 64);

            // Tabel transaksi
            let yPosition = 80;
            doc.setFontSize(12);
            doc.text("Detail Transaksi:", 14, yPosition);
            yPosition += 10;

            doc.setFontSize(10);
            doc.text("Tanggal", 14, yPosition);
            doc.text("Keterangan", 40, yPosition);
            doc.text("Kategori", 100, yPosition);
            doc.text("Jenis", 130, yPosition);
            doc.text("Jumlah", 160, yPosition);

            yPosition += 7;
            doc.line(14, yPosition, 195, yPosition);
            yPosition += 5;

            // Data transaksi
            transaksiThisMonth.forEach((transaksi) => {
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }

              doc.setFontSize(9);
              doc.text(formatDate(transaksi.tanggal), 14, yPosition);
              doc.text(transaksi.keterangan.substring(0, 25), 40, yPosition);
              doc.text(transaksi.kategori, 100, yPosition);
              doc.text(
                transaksi.jenis === "pemasukan" ? "Pemasukan" : "Pengeluaran",
                130,
                yPosition
              );
              doc.text(`Rp ${formatNumber(transaksi.jumlah)}`, 160, yPosition);

              yPosition += 6;
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, {
                align: "center",
              });
            }

            // Save PDF
            doc.save(
              `laporan_keuangan_${monthNames[currentMonth]}_${currentYear}.pdf`
            );
            showToast("Export PDF laporan keuangan berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi export Excel untuk laporan keuangan
      function exportLaporanKeuanganExcel() {
        // Filter transaksi bulan ini
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        showLoading();
        supabase
          .from("transaksi")
          .select("*")
          .gte("tanggal", new Date(currentYear, currentMonth, 1))
          .lte("tanggal", new Date(currentYear, currentMonth + 1, 0))
          .then(({ data: transaksiThisMonth, error }) => {
            if (error) {
              showToast("Error loading data for report: " + error.message, "error");
              hideLoading();
              return;
            }

            // Hitung total
            const totalPemasukan = transaksiThisMonth
              .filter((t) => t.jenis === "pemasukan")
              .reduce((sum, t) => sum + parseFloat(t.jumlah), 0);
            const totalPengeluaran = transaksiThisMonth
              .filter((t) => t.jenis === "pengeluaran")
              .reduce((sum, t) => sum + parseFloat(t.jumlah), 0);
            const saldo = totalPemasukan - totalPengeluaran;

            // Siapkan data ringkasan
            const ringkasanData = [
              { Item: "Total Pemasukan", Jumlah: totalPemasukan },
              { Item: "Total Pengeluaran", Jumlah: totalPengeluaran },
              { Item: "Saldo", Jumlah: saldo },
            ];

            // Siapkan data transaksi
            const transaksiData = transaksiThisMonth.map((transaksi, index) => ({
              No: index + 1,
              Tanggal: formatDate(transaksi.tanggal),
              Keterangan: transaksi.keterangan,
              Kategori: transaksi.kategori,
              Jenis: transaksi.jenis === "pemasukan" ? "Pemasukan" : "Pengeluaran",
              Jumlah: transaksi.jumlah,
            }));

            // Buat workbook
            const wb = XLSX.utils.book_new();

            // Buat worksheet ringkasan
            const wsRingkasan = XLSX.utils.json_to_sheet(ringkasanData);
            wsRingkasan["!cols"] = [
              { wch: 20 }, // Item
              { wch: 15 }, // Jumlah
            ];
            XLSX.utils.book_append_sheet(wb, wsRingkasan, "Ringkasan");

            // Buat worksheet transaksi
            const wsTransaksi = XLSX.utils.json_to_sheet(transaksiData);
            wsTransaksi["!cols"] = [
              { wch: 5 }, // No
              { wch: 15 }, // Tanggal
              { wch: 30 }, // Keterangan
              { wch: 15 }, // Kategori
              { wch: 10 }, // Jenis
              { wch: 15 }, // Jumlah
            ];
            XLSX.utils.book_append_sheet(wb, wsTransaksi, "Detail Transaksi");

            // Export file
            const monthNames = [
              "Januari",
              "Februari",
              "Maret",
              "April",
              "Mei",
              "Juni",
              "Juli",
              "Agustus",
              "September",
              "Oktober",
              "November",
              "Desember",
            ];
            XLSX.writeFile(
              wb,
              `laporan_keuangan_${monthNames[currentMonth]}_${currentYear}.xlsx`
            );
            showToast("Export Excel laporan keuangan berhasil!", "success");
            hideLoading();
          });
      }

      // Fungsi generate report
      async function generateReport() {
        showLoading();

        try {
          const currentMonth = new Date().getMonth();
          const currentYear = new Date().getFullYear();
          const monthNames = [
            "Januari",
            "Februari",
            "Maret",
            "April",
            "Mei",
            "Juni",
            "Juli",
            "Agustus",
            "September",
            "Oktober",
            "November",
            "Desember",
          ];
          const periode = `${monthNames[currentMonth]} ${currentYear}`;

          // Create new report
          const { data, error } = await supabase.from("laporan").insert([
            {
              nama: `Laporan Keuangan ${periode}`,
              tipe: "keuangan",
              periode: periode,
              status: "dalam_proses",
              created_at: new Date().toISOString(),
            },
          ]);

          if (error) {
            showToast("Error: " + error.message, "error");
            hideLoading();
            return;
          }

          showToast("Laporan berhasil dibuat dan sedang diproses!", "success");

          // Reload data
          await loadLaporan(paginationState.laporan.page);
        } catch (err) {
          showToast("Terjadi kesalahan saat membuat laporan", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi download laporan
      async function downloadLaporan(id) {
        showLoading();

        try {
          // Get laporan data
          const { data: laporanData, error: laporanError } = await supabase
            .from("laporan")
            .select("*")
            .eq("id", id)
            .single();

          if (laporanError) {
            showToast("Error: " + laporanError.message, "error");
            hideLoading();
            return;
          }

          // Check if laporan is ready
          if (laporanData.status !== "selesai") {
            showToast("Laporan belum siap untuk diunduh", "warning");
            hideLoading();
            return;
          }

          // Download laporan
          showToast("Laporan berhasil diunduh!", "success");
        } catch (err) {
          showToast("Terjadi kesalahan saat mengunduh laporan", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi view laporan
      async function viewLaporan(id) {
        showLoading();

        try {
          // Get laporan data
          const { data: laporanData, error: laporanError } = await supabase
            .from("laporan")
            .select("*")
            .eq("id", id)
            .single();

          if (laporanError) {
            showToast("Error: " + laporanError.message, "error");
            hideLoading();
            return;
          }

          // Check if laporan is ready
          if (laporanData.status !== "selesai") {
            showToast("Laporan belum siap untuk dilihat", "warning");
            hideLoading();
            return;
          }

          // View laporan
          showToast("Laporan berhasil dibuka!", "success");
        } catch (err) {
          showToast("Terjadi kesalahan saat membuka laporan", "error");
        } finally {
          hideLoading();
        }
      }

      // Fungsi helper
      function formatDate(dateString) {
        const options = { year: "numeric", month: "long", day: "numeric" };
        return new Date(dateString).toLocaleDateString("id-ID", options);
      }

      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }

      function getStatusClass(status) {
        switch (status) {
          case "aktif":
          case "selesai":
          case "tersedia":
          case "hadir":
            return "active";
          case "dalam_proses":
          case "izin":
            return "pending";
          case "tidak_aktif":
          case "dibatalkan":
          case "tidak_tersedia":
          case "tidak_hadir":
            return "inactive";
          default:
            return "active";
        }
      }

      function getStatusText(status) {
        switch (status) {
          case "aktif":
            return "Aktif";
          case "tidak_aktif":
            return "Tidak Aktif";
          case "dalam_proses":
            return "Dalam Proses";
          case "selesai":
            return "Selesai";
          case "dibatalkan":
            return "Dibatalkan";
          case "tersedia":
            return "Tersedia";
          case "tidak_tersedia":
            return "Tidak Tersedia";
          case "hadir":
            return "Hadir";
          case "tidak_hadir":
            return "Tidak Hadir";
          case "izin":
            return "Izin";
          default:
            return status;
        }
      }

      // OPTIMASI: Fungsi helper untuk pagination
      function getPaginationRange(page, pageSize) {
        const from = (page - 1) * pageSize;
        const to = from + pageSize - 1;
        return { from, to };
      }

      function updatePagination(tableName) {
        const state = paginationState[tableName];
        const totalPages = Math.ceil(state.count / state.pageSize);
        const infoEl = document.getElementById(`${tableName}PaginationInfo`);
        const buttonsEl = document.getElementById(`${tableName}PaginationButtons`);

        // Update info text
        const startItem = (state.page - 1) * state.pageSize + 1;
        const endItem = Math.min(state.page * state.pageSize, state.count);
        infoEl.textContent = `Menampilkan ${startItem}-${endItem} dari ${state.count} data`;

        // Clear existing buttons
        buttonsEl.innerHTML = '';

        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn';
        prevBtn.textContent = 'Previous';
        prevBtn.disabled = state.page === 1;
        prevBtn.onclick = () => {
          if (state.page > 1) {
            loadTableData(tableName, state.page - 1);
          }
        };
        buttonsEl.appendChild(prevBtn);

        // Page number buttons
        const maxButtons = 5;
        let startPage = Math.max(1, state.page - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage + 1 < maxButtons) {
          startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `pagination-btn ${i === state.page ? 'active' : ''}`;
          pageBtn.textContent = i;
          pageBtn.onclick = () => loadTableData(tableName, i);
          buttonsEl.appendChild(pageBtn);
        }

        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn';
        nextBtn.textContent = 'Next';
        nextBtn.disabled = state.page === totalPages;
        nextBtn.onclick = () => {
          if (state.page < totalPages) {
            loadTableData(tableName, state.page + 1);
          }
        };
        buttonsEl.appendChild(nextBtn);
      }

      function loadTableData(tableName, page) {
        switch (tableName) {
          case 'santri':
            loadSantri(page);
            break;
          case 'guru':
            loadGuru(page);
            break;
          case 'kegiatan':
            loadKegiatan(page);
            break;
          case 'fasilitas':
            loadFasilitas(page);
            break;
          case 'transaksi':
            loadTransaksi(page);
            break;
          case 'laporan':
            loadLaporan(page);
            break;
        }
      }

      // Fungsi UI
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        sidebar.classList.toggle("collapsed");
        mainContent.classList.toggle("expanded");
      }

      // OPTIMASI: Fungsi showSection dengan lazy loading
      async function showSection(sectionId) {
        // Hide all sections
        const sections = document.querySelectorAll(".content-section");
        sections.forEach((section) => {
          section.style.display = "none";
        });

        // Show selected section
        document.getElementById(sectionId).style.display = "block";

        // Update active nav link
        const navLinks = document.querySelectorAll(".nav-link");
        navLinks.forEach((link) => {
          link.classList.remove("active");
        });
        event.target.closest(".nav-link").classList.add("active");

        // Lazy load data based on section
        showLoading();
        try {
          switch (sectionId) {
            case "dashboard":
              await loadDashboardData();
              break;
            case "santri":
              await loadSantri();
              await loadKelas(); // Load kelas for dropdown
              break;
            case "pengajar":
              await loadGuru();
              break;
            case "absen":
              // Load data for absen section
              await loadKelas(); // For kelas filter
              // Load absen data when filter is applied
              break;
            case "kegiatan":
              await loadKegiatan();
              break;
            case "fasilitas":
              await loadFasilitas();
              break;
            case "keuangan":
              await loadTransaksi();
              break;
            case "laporan":
              await loadLaporan();
              break;
            case "pengaturan":
              await loadPengaturan();
              break;
          }
        } catch (err) {
          showToast("Terjadi kesalahan saat memuat data", "error");
        } finally {
          hideLoading();
        }
      }

      function switchTab(tabName) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll(".tab-content");
        tabContents.forEach((content) => {
          content.classList.remove("active");
        });

        // Remove active class from all tab buttons
        const tabButtons = document.querySelectorAll(".tab-btn");
        tabButtons.forEach((button) => {
          button.classList.remove("active");
        });

        // Show selected tab content
        document.getElementById(tabName + "Tab").classList.add("active");

        // Add active class to clicked tab button
        event.target.classList.add("active");
      }

      function openModal(modalId) {
        // Reset modal title if needed
        if (modalId === "santriModal") {
          document.getElementById("santriModalTitle").textContent =
            "Tambah Santri Baru";
        } else if (modalId === "pengajarModal") {
          document.getElementById("pengajarModalTitle").textContent =
            "Tambah Pengajar Baru";
        } else if (modalId === "kegiatanModal") {
          document.getElementById("kegiatanModalTitle").textContent =
            "Tambah Kegiatan Baru";
        } else if (modalId === "fasilitasModal") {
          document.getElementById("fasilitasModalTitle").textContent =
            "Tambah Fasilitas Baru";
        } else if (modalId === "transaksiModal") {
          document.getElementById("transaksiModalTitle").textContent =
            "Tambah Transaksi Baru";
        }

        document.getElementById(modalId).classList.add("active");
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("active");
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", async function () {
        // Set current date for date inputs
        const today = new Date().toISOString().split("T")[0];
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach((input) => {
          input.value = today;
        });

        // Check if user is logged in
        const {
          data: { session },
        } = await supabase.auth.getSession();

        if (session) {
          currentUser = session.user;
          await loadUserProfile();
          // OPTIMASI: Hanya load dashboard data saat awal
          await loadDashboardData();
        } else {
          // Show login modal
          document.getElementById("loginModal").classList.add("active");
        }

        // Pantau perubahan status autentikasi (versi diperbaiki)
        supabase.auth.onAuthStateChange(async (event, session) => {
          console.log("Auth state changed:", event, session);

          if (event === "SIGNED_IN" && session) {
            currentUser = session.user;
            closeModal("loginModal");
            await loadUserProfile();
            // OPTIMASI: Hanya load dashboard data saat login
            await loadDashboardData();
          } else if (event === "SIGNED_OUT") {
            currentUser = null;
            // Hanya tampilkan modal jika tidak sedang dalam proses logout manual
            const loginModal = document.getElementById("loginModal");
            if (!loginModal.classList.contains("active")) {
              loginModal.classList.add("active");
            }
          }
        });
      });
    </script>
  </body>
</html>
